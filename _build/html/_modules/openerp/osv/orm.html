<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>openerp.osv.orm &mdash; OpenERP Server Developers Documentation 7.0b documentation</title>
    
    <link rel="stylesheet" href="../../../_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '7.0b',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="OpenERP Server Developers Documentation 7.0b documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../../../_static/small_flask.css" type= "text/css" rel="stylesheet" />

  </head>
  <body role="document">
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">OpenERP Server Developers Documentation 7.0b documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for openerp.osv.orm</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">##############################################################################</span>
<span class="c">#</span>
<span class="c">#    OpenERP, Open Source Management Solution</span>
<span class="c">#    Copyright (C) 2004-2009 Tiny SPRL (&lt;http://tiny.be&gt;).</span>
<span class="c">#</span>
<span class="c">#    This program is free software: you can redistribute it and/or modify</span>
<span class="c">#    it under the terms of the GNU Affero General Public License as</span>
<span class="c">#    published by the Free Software Foundation, either version 3 of the</span>
<span class="c">#    License, or (at your option) any later version.</span>
<span class="c">#</span>
<span class="c">#    This program is distributed in the hope that it will be useful,</span>
<span class="c">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c">#    GNU Affero General Public License for more details.</span>
<span class="c">#</span>
<span class="c">#    You should have received a copy of the GNU Affero General Public License</span>
<span class="c">#    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c">#</span>
<span class="c">##############################################################################</span>

<span class="c">#.apidoc title: Object Relational Mapping</span>
<span class="c">#.apidoc module-mods: member-order: bysource</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Object relational mapping to database (postgresql) module</span>
<span class="sd">     * Hierarchical structure</span>
<span class="sd">     * Constraints consistency, validations</span>
<span class="sd">     * Object meta Data depends on its status</span>
<span class="sd">     * Optimised processing by complex query (multiple actions at once)</span>
<span class="sd">     * Default fields value</span>
<span class="sd">     * Permissions optimisation</span>
<span class="sd">     * Persistant object: DB postgresql</span>
<span class="sd">     * Datas conversions</span>
<span class="sd">     * Multi-level caching system</span>
<span class="sd">     * 2 different inheritancies</span>
<span class="sd">     * Fields:</span>
<span class="sd">          - classicals (varchar, integer, boolean, ...)</span>
<span class="sd">          - relations (one2many, many2one, many2many)</span>
<span class="sd">          - functions</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">babel.dates</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">simplejson</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">types</span>

<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>

<span class="kn">import</span> <span class="nn">fields</span>
<span class="kn">import</span> <span class="nn">openerp</span>
<span class="kn">import</span> <span class="nn">openerp.netsvc</span> <span class="kn">as</span> <span class="nn">netsvc</span>
<span class="kn">import</span> <span class="nn">openerp.tools</span> <span class="kn">as</span> <span class="nn">tools</span>
<span class="kn">from</span> <span class="nn">openerp.tools.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">openerp.tools.misc</span> <span class="kn">import</span> <span class="n">CountingStream</span>
<span class="kn">from</span> <span class="nn">openerp.tools.safe_eval</span> <span class="kn">import</span> <span class="n">safe_eval</span> <span class="k">as</span> <span class="nb">eval</span>
<span class="kn">from</span> <span class="nn">openerp.tools.translate</span> <span class="kn">import</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">openerp</span> <span class="kn">import</span> <span class="n">SUPERUSER_ID</span>
<span class="kn">from</span> <span class="nn">query</span> <span class="kn">import</span> <span class="n">Query</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">_schema</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span> <span class="o">+</span> <span class="s">&#39;.schema&#39;</span><span class="p">)</span>

<span class="c"># List of etree._Element subclasses that we choose to ignore when parsing XML.</span>
<span class="kn">from</span> <span class="nn">openerp.tools</span> <span class="kn">import</span> <span class="n">SKIPPED_ELEMENT_TYPES</span>

<span class="n">regex_order</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^( *([a-z0-9_]+|&quot;[a-z0-9_]+&quot;)( *desc| *asc)?( *, *|))+$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
<span class="n">regex_object_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^[a-z0-9_.]+$&#39;</span><span class="p">)</span>

<span class="c"># TODO for trunk, raise the value to 1000</span>
<span class="n">AUTOINIT_RECALCULATE_STORED_FIELDS</span> <span class="o">=</span> <span class="mi">40</span>

<div class="viewcode-block" id="transfer_field_to_modifiers"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.transfer_field_to_modifiers">[docs]</a><span class="k">def</span> <span class="nf">transfer_field_to_modifiers</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">):</span>
    <span class="n">default_values</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">state_exceptions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;invisible&#39;</span><span class="p">,</span> <span class="s">&#39;readonly&#39;</span><span class="p">,</span> <span class="s">&#39;required&#39;</span><span class="p">):</span>
        <span class="n">state_exceptions</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">default_values</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">state</span><span class="p">,</span> <span class="n">modifs</span> <span class="ow">in</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;states&quot;</span><span class="p">,{}))</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">modif</span> <span class="ow">in</span> <span class="n">modifs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default_values</span><span class="p">[</span><span class="n">modif</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">!=</span> <span class="n">modif</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">state_exceptions</span><span class="p">[</span><span class="n">modif</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">default_value</span> <span class="ow">in</span> <span class="n">default_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">state_exceptions</span><span class="p">[</span><span class="n">attr</span><span class="p">]:</span>
            <span class="n">modifiers</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;state&quot;</span><span class="p">,</span> <span class="s">&quot;not in&quot;</span> <span class="k">if</span> <span class="n">default_value</span> <span class="k">else</span> <span class="s">&quot;in&quot;</span><span class="p">,</span> <span class="n">state_exceptions</span><span class="p">[</span><span class="n">attr</span><span class="p">])]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modifiers</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_value</span>


<span class="c"># Don&#39;t deal with groups, it is done by check_group().</span>
<span class="c"># Need the context to evaluate the invisible attribute on tree views.</span>
<span class="c"># For non-tree views, the context shouldn&#39;t be given.</span></div>
<div class="viewcode-block" id="transfer_node_to_modifiers"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.transfer_node_to_modifiers">[docs]</a><span class="k">def</span> <span class="nf">transfer_node_to_modifiers</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">in_tree_view</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;attrs&#39;</span><span class="p">):</span>
        <span class="n">modifiers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;attrs&#39;</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;states&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;invisible&#39;</span> <span class="ow">in</span> <span class="n">modifiers</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modifiers</span><span class="p">[</span><span class="s">&#39;invisible&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c"># TODO combine with AND or OR, use implicit AND for now.</span>
            <span class="n">modifiers</span><span class="p">[</span><span class="s">&#39;invisible&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;state&#39;</span><span class="p">,</span> <span class="s">&#39;not in&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;states&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modifiers</span><span class="p">[</span><span class="s">&#39;invisible&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;state&#39;</span><span class="p">,</span> <span class="s">&#39;not in&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;states&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">))]</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;invisible&#39;</span><span class="p">,</span> <span class="s">&#39;readonly&#39;</span><span class="p">,</span> <span class="s">&#39;required&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="p">{</span><span class="s">&#39;context&#39;</span><span class="p">:</span> <span class="n">context</span> <span class="ow">or</span> <span class="p">{}}))</span>
            <span class="k">if</span> <span class="n">in_tree_view</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">==</span> <span class="s">&#39;invisible&#39;</span><span class="p">:</span>
                <span class="c"># Invisible in a tree view has a specific meaning, make it a</span>
                <span class="c"># new key in the modifiers attribute.</span>
                <span class="n">modifiers</span><span class="p">[</span><span class="s">&#39;tree_invisible&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="n">v</span> <span class="ow">or</span> <span class="p">(</span><span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modifiers</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modifiers</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="c"># Don&#39;t set the attribute to False if a dynamic value was</span>
                <span class="c"># provided (i.e. a domain from attrs or states).</span>
                <span class="n">modifiers</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

</div>
<div class="viewcode-block" id="simplify_modifiers"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.simplify_modifiers">[docs]</a><span class="k">def</span> <span class="nf">simplify_modifiers</span><span class="p">(</span><span class="n">modifiers</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;invisible&#39;</span><span class="p">,</span> <span class="s">&#39;readonly&#39;</span><span class="p">,</span> <span class="s">&#39;required&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">modifiers</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">modifiers</span><span class="p">[</span><span class="n">a</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">modifiers</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="transfer_modifiers_to_node"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.transfer_modifiers_to_node">[docs]</a><span class="k">def</span> <span class="nf">transfer_modifiers_to_node</span><span class="p">(</span><span class="n">modifiers</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">modifiers</span><span class="p">:</span>
        <span class="n">simplify_modifiers</span><span class="p">(</span><span class="n">modifiers</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;modifiers&#39;</span><span class="p">,</span> <span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">modifiers</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="setup_modifiers"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.setup_modifiers">[docs]</a><span class="k">def</span> <span class="nf">setup_modifiers</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">in_tree_view</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Processes node attributes and field descriptors to generate</span>
<span class="sd">    the ``modifiers`` node attribute and set it on the provided node.</span>

<span class="sd">    Alters its first argument in-place.</span>

<span class="sd">    :param node: ``field`` node from an OpenERP view</span>
<span class="sd">    :type node: lxml.etree._Element</span>
<span class="sd">    :param dict field: field descriptor corresponding to the provided node</span>
<span class="sd">    :param dict context: execution context used to evaluate node attributes</span>
<span class="sd">    :param bool in_tree_view: triggers the ``tree_invisible`` code</span>
<span class="sd">                              path (separate from ``invisible``): in</span>
<span class="sd">                              tree view there are two levels of</span>
<span class="sd">                              invisibility, cell content (a column is</span>
<span class="sd">                              present but the cell itself is not</span>
<span class="sd">                              displayed) with ``invisible`` and column</span>
<span class="sd">                              invisibility (the whole column is</span>
<span class="sd">                              hidden) with ``tree_invisible``.</span>
<span class="sd">    :returns: nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">modifiers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">transfer_field_to_modifiers</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">)</span>
    <span class="n">transfer_node_to_modifiers</span><span class="p">(</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">in_tree_view</span><span class="o">=</span><span class="n">in_tree_view</span><span class="p">)</span>
    <span class="n">transfer_modifiers_to_node</span><span class="p">(</span><span class="n">modifiers</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="test_modifiers"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.test_modifiers">[docs]</a><span class="k">def</span> <span class="nf">test_modifiers</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
    <span class="n">modifiers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
        <span class="n">transfer_node_to_modifiers</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">)</span>
        <span class="n">simplify_modifiers</span><span class="p">(</span><span class="n">modifiers</span><span class="p">)</span>
        <span class="n">json</span> <span class="o">=</span> <span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">modifiers</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">json</span> <span class="o">==</span> <span class="n">expected</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">transfer_field_to_modifiers</span><span class="p">(</span><span class="n">what</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">)</span>
        <span class="n">simplify_modifiers</span><span class="p">(</span><span class="n">modifiers</span><span class="p">)</span>
        <span class="n">json</span> <span class="o">=</span> <span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">modifiers</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">json</span> <span class="o">==</span> <span class="n">expected</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>


<span class="c"># To use this test:</span>
<span class="c"># import openerp</span>
<span class="c"># openerp.osv.orm.modifiers_tests()</span></div>
<div class="viewcode-block" id="modifiers_tests"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.modifiers_tests">[docs]</a><span class="k">def</span> <span class="nf">modifiers_tests</span><span class="p">():</span>
    <span class="n">test_modifiers</span><span class="p">(</span><span class="s">&#39;&lt;field name=&quot;a&quot;/&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;{}&#39;</span><span class="p">)</span>
    <span class="n">test_modifiers</span><span class="p">(</span><span class="s">&#39;&lt;field name=&quot;a&quot; invisible=&quot;1&quot;/&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;{&quot;invisible&quot;: true}&#39;</span><span class="p">)</span>
    <span class="n">test_modifiers</span><span class="p">(</span><span class="s">&#39;&lt;field name=&quot;a&quot; readonly=&quot;1&quot;/&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;{&quot;readonly&quot;: true}&#39;</span><span class="p">)</span>
    <span class="n">test_modifiers</span><span class="p">(</span><span class="s">&#39;&lt;field name=&quot;a&quot; required=&quot;1&quot;/&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;{&quot;required&quot;: true}&#39;</span><span class="p">)</span>
    <span class="n">test_modifiers</span><span class="p">(</span><span class="s">&#39;&lt;field name=&quot;a&quot; invisible=&quot;0&quot;/&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;{}&#39;</span><span class="p">)</span>
    <span class="n">test_modifiers</span><span class="p">(</span><span class="s">&#39;&lt;field name=&quot;a&quot; readonly=&quot;0&quot;/&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;{}&#39;</span><span class="p">)</span>
    <span class="n">test_modifiers</span><span class="p">(</span><span class="s">&#39;&lt;field name=&quot;a&quot; required=&quot;0&quot;/&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;{}&#39;</span><span class="p">)</span>
    <span class="n">test_modifiers</span><span class="p">(</span><span class="s">&#39;&lt;field name=&quot;a&quot; invisible=&quot;1&quot; required=&quot;1&quot;/&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;{&quot;invisible&quot;: true, &quot;required&quot;: true}&#39;</span><span class="p">)</span> <span class="c"># TODO order is not guaranteed</span>
    <span class="n">test_modifiers</span><span class="p">(</span><span class="s">&#39;&lt;field name=&quot;a&quot; invisible=&quot;1&quot; required=&quot;0&quot;/&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;{&quot;invisible&quot;: true}&#39;</span><span class="p">)</span>
    <span class="n">test_modifiers</span><span class="p">(</span><span class="s">&#39;&lt;field name=&quot;a&quot; invisible=&quot;0&quot; required=&quot;1&quot;/&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;{&quot;required&quot;: true}&#39;</span><span class="p">)</span>
    <span class="n">test_modifiers</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;field name=&quot;a&quot; attrs=&quot;{&#39;invisible&#39;: [(&#39;b&#39;, &#39;=&#39;, &#39;c&#39;)]}&quot;/&gt;&quot;&quot;&quot;</span><span class="p">,</span> <span class="s">&#39;{&quot;invisible&quot;: [[&quot;b&quot;, &quot;=&quot;, &quot;c&quot;]]}&#39;</span><span class="p">)</span>

    <span class="c"># The dictionary is supposed to be the result of fields_get().</span>
    <span class="n">test_modifiers</span><span class="p">({},</span> <span class="s">&#39;{}&#39;</span><span class="p">)</span>
    <span class="n">test_modifiers</span><span class="p">({</span><span class="s">&quot;invisible&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span> <span class="s">&#39;{&quot;invisible&quot;: true}&#39;</span><span class="p">)</span>
    <span class="n">test_modifiers</span><span class="p">({</span><span class="s">&quot;invisible&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span> <span class="s">&#39;{}&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="check_object_name"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.check_object_name">[docs]</a><span class="k">def</span> <span class="nf">check_object_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check if the given name is a valid openerp object name.</span>

<span class="sd">        The _name attribute in osv and osv_memory object is subject to</span>
<span class="sd">        some restrictions. This function returns True or False whether</span>
<span class="sd">        the given name is allowed or not.</span>

<span class="sd">        TODO: this is an approximation. The goal in this approximation</span>
<span class="sd">        is to disallow uppercase characters (in some places, we quote</span>
<span class="sd">        table/column names and in other not, which leads to this kind</span>
<span class="sd">        of errors:</span>

<span class="sd">            psycopg2.ProgrammingError: relation &quot;xxx&quot; does not exist).</span>

<span class="sd">        The same restriction should apply to both osv and osv_memory</span>
<span class="sd">        objects for consistency.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">regex_object_name</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="raise_on_invalid_object_name"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.raise_on_invalid_object_name">[docs]</a><span class="k">def</span> <span class="nf">raise_on_invalid_object_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_object_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;The _name attribute </span><span class="si">%s</span><span class="s"> is not valid.&quot;</span> <span class="o">%</span> <span class="n">name</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="s">&#39;ValueError&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</div>
<span class="n">POSTGRES_CONFDELTYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;RESTRICT&#39;</span><span class="p">:</span> <span class="s">&#39;r&#39;</span><span class="p">,</span>
    <span class="s">&#39;NO ACTION&#39;</span><span class="p">:</span> <span class="s">&#39;a&#39;</span><span class="p">,</span>
    <span class="s">&#39;CASCADE&#39;</span><span class="p">:</span> <span class="s">&#39;c&#39;</span><span class="p">,</span>
    <span class="s">&#39;SET NULL&#39;</span><span class="p">:</span> <span class="s">&#39;n&#39;</span><span class="p">,</span>
    <span class="s">&#39;SET DEFAULT&#39;</span><span class="p">:</span> <span class="s">&#39;d&#39;</span><span class="p">,</span>
<span class="p">}</span>

<div class="viewcode-block" id="intersect"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.intersect">[docs]</a><span class="k">def</span> <span class="nf">intersect</span><span class="p">(</span><span class="n">la</span><span class="p">,</span> <span class="n">lb</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lb</span><span class="p">,</span> <span class="n">la</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="fix_import_export_id_paths"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.fix_import_export_id_paths">[docs]</a><span class="k">def</span> <span class="nf">fix_import_export_id_paths</span><span class="p">(</span><span class="n">fieldname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fixes the id fields in import and exports, and splits field paths</span>
<span class="sd">    on &#39;/&#39;.</span>

<span class="sd">    :param str fieldname: name of the field to import/export</span>
<span class="sd">    :return: split field name</span>
<span class="sd">    :rtype: list of str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fixed_db_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;([^/])\.id&#39;</span><span class="p">,</span> <span class="s">r&#39;\1/.id&#39;</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">)</span>
    <span class="n">fixed_external_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;([^/]):id&#39;</span><span class="p">,</span> <span class="s">r&#39;\1/id&#39;</span><span class="p">,</span> <span class="n">fixed_db_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fixed_external_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="except_orm"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.except_orm">[docs]</a><span class="k">class</span> <span class="nc">except_orm</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BrowseRecordError"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BrowseRecordError">[docs]</a><span class="k">class</span> <span class="nc">BrowseRecordError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="browse_null"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.browse_null">[docs]</a><span class="k">class</span> <span class="nc">browse_null</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Readonly python database object browser</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>  <span class="c"># XXX: return self ?</span>

    <span class="k">def</span> <span class="nf">__int__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">u&#39;&#39;</span>


<span class="c">#</span>
<span class="c"># TODO: execute an object method on browse_record_list</span>
<span class="c">#</span></div>
<div class="viewcode-block" id="browse_record_list"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.browse_record_list">[docs]</a><span class="k">class</span> <span class="nc">browse_record_list</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Collection of browse objects</span>

<span class="sd">        Such an instance will be returned when doing a ``browse([ids..])``</span>
<span class="sd">        and will be iterable, yielding browse() objects</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lst</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">browse_record_list</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>

</div>
<div class="viewcode-block" id="browse_record"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.browse_record">[docs]</a><span class="k">class</span> <span class="nc">browse_record</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; An object that behaves like a row of an object&#39;s table.</span>
<span class="sd">        It has attributes after the columns of the corresponding object.</span>

<span class="sd">        Examples::</span>

<span class="sd">            uobj = pool.get(&#39;res.users&#39;)</span>
<span class="sd">            user_rec = uobj.browse(cr, uid, 104)</span>
<span class="sd">            name = user_rec.name</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">list_class</span><span class="o">=</span><span class="n">browse_record_list</span><span class="p">,</span> <span class="n">fields_process</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param table: the browsed object (inherited from orm)</span>
<span class="sd">        :param dict cache: a dictionary of model-&gt;field-&gt;data to be shared</span>
<span class="sd">                           across browse objects, thus reducing the SQL</span>
<span class="sd">                           read()s. It can speed up things a lot, but also be</span>
<span class="sd">                           disastrous if not discarded after write()/unlink()</span>
<span class="sd">                           operations</span>
<span class="sd">        :param dict context: dictionary with an optional context</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fields_process</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fields_process</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_list_class</span> <span class="o">=</span> <span class="n">list_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span> <span class="o">=</span> <span class="n">cr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span> <span class="o">=</span> <span class="n">uid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="n">table</span> <span class="c"># deprecated, use _model!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;openerp.osv.orm.browse_record.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fields_process</span> <span class="o">=</span> <span class="n">fields_process</span>

        <span class="n">cache</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>

<span class="c">#        if not (id and isinstance(id, (int, long,))):</span>
<span class="c">#            raise BrowseRecordError(_(&#39;Wrong ID for the browse record, got %r, expected an integer.&#39;) % (id,))</span>
<span class="c">#        if not table.exists(cr, uid, id, context):</span>
<span class="c">#            raise BrowseRecordError(_(&#39;Object %s does not exists&#39;) % (self,))</span>

        <span class="k">if</span> <span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="nb">id</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">cache</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;id&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">]:</span>
            <span class="c"># build the list of fields we will fetch</span>

            <span class="c"># fetch the definition of the field which was asked for</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)):</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">LambdaType</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)):</span>
                    <span class="k">def</span> <span class="nf">function_proxy</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                        <span class="k">if</span> <span class="s">&#39;context&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
                            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">attr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">function_proxy</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">attr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;Field &#39;</span><span class="si">%s</span><span class="s">&#39; does not exist in object &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_stack</span><span class="p">()))</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

            <span class="c"># if the field is a classic one or a many2one, we&#39;ll fetch all classic and many2one fields</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">_prefetch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">col</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="c"># gen the list of &quot;local&quot; (ie not inherited) fields which are classic or many2one</span>
                <span class="n">field_filter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_classic_write</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_prefetch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groups</span>
                <span class="n">fields_to_fetch</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">field_filter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="c"># gen the list of inherited fields</span>
                <span class="n">inherits</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="c"># complete the field list with the inherited fields which are classic or many2one</span>
                <span class="n">fields_to_fetch</span> <span class="o">+=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">field_filter</span><span class="p">,</span> <span class="n">inherits</span><span class="p">)</span>
            <span class="c"># otherwise we fetch only that field</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fields_to_fetch</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">col</span><span class="p">)]</span>

            <span class="n">ids</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="nb">id</span><span class="p">:</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="c"># read the results</span>
            <span class="n">field_names</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fields_to_fetch</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">field_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="s">&quot;_classic_write&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">openerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">AccessError</span><span class="p">,</span> <span class="n">except_orm</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="c"># prefetching attempt failed, perhaps we&#39;re violating ACL restrictions involuntarily</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Prefetching attempt for fields </span><span class="si">%s</span><span class="s"> on </span><span class="si">%s</span><span class="s"> failed for ids </span><span class="si">%s</span><span class="s">, re-trying just for id </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">]</span>
                <span class="n">field_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="s">&quot;_classic_write&quot;</span><span class="p">)</span>

            <span class="c"># TODO: improve this, very slow for reports</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields_process</span><span class="p">:</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lang&#39;</span><span class="p">,</span> <span class="s">&#39;en_US&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;en_US&#39;</span>
                <span class="n">lang_obj_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;res.lang&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;code&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">lang</span><span class="p">)])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">lang_obj_ids</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Language with code &quot;</span><span class="si">%s</span><span class="s">&quot; is not defined in your system !</span><span class="se">\n</span><span class="s">Define it through the Administration menu.&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">lang</span><span class="p">,))</span>
                <span class="n">lang_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;res.lang&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="n">lang_obj_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_column</span> <span class="ow">in</span> <span class="n">fields_to_fetch</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field_column</span><span class="o">.</span><span class="n">_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields_process</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">result_line</span> <span class="ow">in</span> <span class="n">field_values</span><span class="p">:</span>
                            <span class="n">result_line</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields_process</span><span class="p">[</span><span class="n">field_column</span><span class="o">.</span><span class="n">_type</span><span class="p">](</span><span class="n">result_line</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">result_line</span><span class="p">[</span><span class="n">field_name</span><span class="p">]:</span>
                                <span class="n">result_line</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="n">result_line</span><span class="p">[</span><span class="n">field_name</span><span class="p">],</span> <span class="bp">self</span><span class="p">,</span> <span class="n">field_column</span><span class="p">,</span> <span class="n">lang_obj</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">field_values</span><span class="p">:</span>
                <span class="c"># Where did those ids come from? Perhaps old entries in ir_model_dat?</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;No field_values found for ids </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;Field </span><span class="si">%s</span><span class="s"> not found in </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
            <span class="c"># create browse records for &#39;remote&#39; objects</span>
            <span class="k">for</span> <span class="n">result_line</span> <span class="ow">in</span> <span class="n">field_values</span><span class="p">:</span>
                <span class="n">new_data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_column</span> <span class="ow">in</span> <span class="n">fields_to_fetch</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field_column</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2one&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">result_line</span><span class="p">[</span><span class="n">field_name</span><span class="p">]:</span>
                            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_column</span><span class="o">.</span><span class="n">_obj</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_line</span><span class="p">[</span><span class="n">field_name</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">result_line</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">result_line</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                                <span class="c"># FIXME: this happen when a _inherits object</span>
                                <span class="c">#        overwrite a field of it parent. Need</span>
                                <span class="c">#        testing to be sure we got the right</span>
                                <span class="c">#        object and not the parent one.</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">browse_record</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                        <span class="c"># In some cases the target model is not available yet, so we must ignore it,</span>
                                        <span class="c"># which is safe in most cases, this value will just be loaded later when needed.</span>
                                        <span class="c"># This situation can be caused by custom fields that connect objects with m2o without</span>
                                        <span class="c"># respecting module dependencies, causing relationships to be connected to soon when</span>
                                        <span class="c"># the target is not loaded yet.</span>
                                        <span class="k">continue</span>
                                    <span class="n">new_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">browse_record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">,</span>
                                        <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">,</span>
                                        <span class="n">list_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_list_class</span><span class="p">,</span>
                                        <span class="n">fields_process</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields_process</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">new_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">new_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">browse_null</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">browse_null</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">field_column</span><span class="o">.</span><span class="n">_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;one2many&#39;</span><span class="p">,</span> <span class="s">&#39;many2many&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_line</span><span class="p">[</span><span class="n">field_name</span><span class="p">]):</span>
                        <span class="n">new_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_class</span><span class="p">([</span><span class="n">browse_record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_column</span><span class="o">.</span><span class="n">_obj</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">,</span> <span class="n">list_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_list_class</span><span class="p">,</span> <span class="n">fields_process</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields_process</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">result_line</span><span class="p">[</span><span class="n">field_name</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">field_column</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;reference&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">result_line</span><span class="p">[</span><span class="n">field_name</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_line</span><span class="p">[</span><span class="n">field_name</span><span class="p">],</span> <span class="n">browse_record</span><span class="p">):</span>
                                <span class="n">new_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_line</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ref_obj</span><span class="p">,</span> <span class="n">ref_id</span> <span class="o">=</span> <span class="n">result_line</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
                                <span class="n">ref_id</span> <span class="o">=</span> <span class="nb">long</span><span class="p">(</span><span class="n">ref_id</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">ref_id</span><span class="p">:</span>
                                    <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ref_obj</span><span class="p">)</span>
                                    <span class="n">new_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">browse_record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="n">ref_id</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">,</span> <span class="n">list_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_list_class</span><span class="p">,</span> <span class="n">fields_process</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields_process</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">new_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">browse_null</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">browse_null</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_line</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">result_line</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">]:</span>
            <span class="c"># How did this happen? Could be a missing model due to custom fields used too soon, see above.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Fields to fetch: </span><span class="si">%s</span><span class="s">, Field values: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">field_values</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Cached: </span><span class="si">%s</span><span class="s">, Table: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Unknown attribute </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s"> &#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">_columns</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Iteration is not allowed on </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hasattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__int__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;browse_record(</span><span class="si">%s</span><span class="s">, </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">browse_record</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_table_name</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">browse_record</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_table_name</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>

    <span class="c"># we need to define __unicode__ even though we&#39;ve already defined __str__</span>
    <span class="c"># because we have overridden __getattr__</span>
    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">))</span>

    <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span>

<div class="viewcode-block" id="browse_record.refresh"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.browse_record.refresh">[docs]</a>    <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Force refreshing this browse_record&#39;s data and all the data of the</span>
<span class="sd">           records that belong to the same cache, by emptying the cache completely,</span>
<span class="sd">           preserving only the record identifiers (for prefetching optimizations).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_cache</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="c"># only preserve the ids of the records that were in the cache</span>
            <span class="n">cached_ids</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cached_ids</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="pg_varchar"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.pg_varchar">[docs]</a><span class="k">def</span> <span class="nf">pg_varchar</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns the VARCHAR declaration for the provided size:</span>

<span class="sd">    * If no size (or an empty or negative size is provided) return an</span>
<span class="sd">      &#39;infinite&#39; VARCHAR</span>
<span class="sd">    * Otherwise return a VARCHAR(n)</span>

<span class="sd">    :type int size: varchar size, optional</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">size</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;VARCHAR parameter should be an int, got </span><span class="si">%s</span><span class="s">&quot;</span>
                            <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;VARCHAR(</span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">size</span>
    <span class="k">return</span> <span class="s">&#39;VARCHAR&#39;</span>
</div>
<span class="n">FIELDS_TO_PGTYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">boolean</span><span class="p">:</span> <span class="s">&#39;bool&#39;</span><span class="p">,</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">integer</span><span class="p">:</span> <span class="s">&#39;int4&#39;</span><span class="p">,</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="s">&#39;text&#39;</span><span class="p">,</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">html</span><span class="p">:</span> <span class="s">&#39;text&#39;</span><span class="p">,</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">date</span><span class="p">:</span> <span class="s">&#39;date&#39;</span><span class="p">,</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span> <span class="s">&#39;timestamp&#39;</span><span class="p">,</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">binary</span><span class="p">:</span> <span class="s">&#39;bytea&#39;</span><span class="p">,</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">many2one</span><span class="p">:</span> <span class="s">&#39;int4&#39;</span><span class="p">,</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">serialized</span><span class="p">:</span> <span class="s">&#39;text&#39;</span><span class="p">,</span>
<span class="p">}</span>

<div class="viewcode-block" id="get_pg_type"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.get_pg_type">[docs]</a><span class="k">def</span> <span class="nf">get_pg_type</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">type_override</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param fields._column f: field to get a Postgres type for</span>
<span class="sd">    :param type type_override: use the provided type for dispatching instead of the field&#39;s own type</span>
<span class="sd">    :returns: (postgres_identification_type, postgres_type_specification)</span>
<span class="sd">    :rtype: (str, str)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="n">type_override</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">field_type</span> <span class="ow">in</span> <span class="n">FIELDS_TO_PGTYPES</span><span class="p">:</span>
        <span class="n">pg_type</span> <span class="o">=</span>  <span class="p">(</span><span class="n">FIELDS_TO_PGTYPES</span><span class="p">[</span><span class="n">field_type</span><span class="p">],</span> <span class="n">FIELDS_TO_PGTYPES</span><span class="p">[</span><span class="n">field_type</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">digits</span><span class="p">:</span>
            <span class="n">pg_type</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;numeric&#39;</span><span class="p">,</span> <span class="s">&#39;NUMERIC&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pg_type</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;float8&#39;</span><span class="p">,</span> <span class="s">&#39;DOUBLE PRECISION&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">char</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">reference</span><span class="p">)):</span>
        <span class="n">pg_type</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;varchar&#39;</span><span class="p">,</span> <span class="n">pg_varchar</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">selection</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">selection</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">))</span>\
                <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;size&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">pg_type</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;int4&#39;</span><span class="p">,</span> <span class="s">&#39;INTEGER&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pg_type</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;varchar&#39;</span><span class="p">,</span> <span class="n">pg_varchar</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;size&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">function</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;selection&#39;</span><span class="p">:</span>
            <span class="n">pg_type</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;varchar&#39;</span><span class="p">,</span> <span class="n">pg_varchar</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pg_type</span> <span class="o">=</span> <span class="n">get_pg_type</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">_type</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> type not supported!&#39;</span><span class="p">,</span> <span class="n">field_type</span><span class="p">)</span>
        <span class="n">pg_type</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">pg_type</span>

</div>
<div class="viewcode-block" id="MetaModel"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.MetaModel">[docs]</a><span class="k">class</span> <span class="nc">MetaModel</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Metaclass for the Model.</span>

<span class="sd">    This class is used as the metaclass for the Model class to discover</span>
<span class="sd">    the models defined in a module (i.e. without instanciating them).</span>
<span class="sd">    If the automatic discovery is not needed, it is possible to set the</span>
<span class="sd">    model&#39;s _register attribute to False.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">module_to_models</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_register</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">MetaModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># The (OpenERP) module name can be in the `openerp.addons` namespace</span>
        <span class="c"># or not. For instance module `sale` can be imported as</span>
        <span class="c"># `openerp.addons.sale` (the good way) or `sale` (for backward</span>
        <span class="c"># compatibility).</span>
        <span class="n">module_parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">module_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">module_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;openerp&#39;</span> <span class="ow">and</span> \
            <span class="n">module_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;addons&#39;</span><span class="p">:</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_module&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="n">module_name</span>

        <span class="c"># Remember which models to instanciate for this module.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module_to_models</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="c"># Definition of log access columns, automatically added to models if</span>
<span class="c"># self._log_access is True</span></div>
<span class="n">LOG_ACCESS_COLUMNS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;create_uid&#39;</span><span class="p">:</span> <span class="s">&#39;INTEGER REFERENCES res_users ON DELETE SET NULL&#39;</span><span class="p">,</span>
    <span class="s">&#39;create_date&#39;</span><span class="p">:</span> <span class="s">&#39;TIMESTAMP&#39;</span><span class="p">,</span>
    <span class="s">&#39;write_uid&#39;</span><span class="p">:</span> <span class="s">&#39;INTEGER REFERENCES res_users ON DELETE SET NULL&#39;</span><span class="p">,</span>
    <span class="s">&#39;write_date&#39;</span><span class="p">:</span> <span class="s">&#39;TIMESTAMP&#39;</span>
<span class="p">}</span>
<span class="c"># special columns automatically created by the ORM</span>
<span class="n">MAGIC_COLUMNS</span> <span class="o">=</span>  <span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">LOG_ACCESS_COLUMNS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

<div class="viewcode-block" id="BaseModel"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel">[docs]</a><span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Base class for OpenERP models.</span>

<span class="sd">    OpenERP models are created by inheriting from this class&#39; subclasses:</span>

<span class="sd">        * Model: for regular database-persisted models</span>
<span class="sd">        * TransientModel: for temporary data, stored in the database but automatically</span>
<span class="sd">                          vaccuumed every so often</span>
<span class="sd">        * AbstractModel: for abstract super classes meant to be shared by multiple</span>
<span class="sd">                        _inheriting classes (usually Models or TransientModels)</span>

<span class="sd">    The system will later instantiate the class once per database (on</span>
<span class="sd">    which the class&#39; module is installed).</span>

<span class="sd">    To create a class that should not be instantiated, the _register class attribute</span>
<span class="sd">    may be set to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">MetaModel</span>
    <span class="n">_auto</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># create database backend</span>
    <span class="n">_register</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># Set to false if the model shouldn&#39;t be automatically discovered.</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_columns</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_constraints</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_custom</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">_defaults</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_rec_name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_parent_name</span> <span class="o">=</span> <span class="s">&#39;parent_id&#39;</span>
    <span class="n">_parent_store</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">_parent_order</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">_date_name</span> <span class="o">=</span> <span class="s">&#39;date&#39;</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s">&#39;id&#39;</span>
    <span class="n">_sequence</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_needaction</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># dict of {field:method}, with method returning the (name_get of records, {id: fold})</span>
    <span class="c"># to include in the _read_group, if grouped on this field</span>
    <span class="n">_group_by_full</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c"># Transience</span>
    <span class="n">_transient</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True in a TransientModel</span>

    <span class="c"># structure:</span>
    <span class="c">#  { &#39;parent_model&#39;: &#39;m2o_field&#39;, ... }</span>
    <span class="n">_inherits</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c"># Mapping from inherits&#39;d field name to triple (m, r, f, n) where m is the</span>
    <span class="c"># model from which it is inherits&#39;d, r is the (local) field towards m, f</span>
    <span class="c"># is the _column object itself, and n is the original (i.e. top-most)</span>
    <span class="c"># parent model.</span>
    <span class="c"># Example:</span>
    <span class="c">#  { &#39;field_name&#39;: (&#39;parent_model&#39;, &#39;m2o_field_to_reach_parent&#39;,</span>
    <span class="c">#                   field_column_obj, origina_parent_model), ... }</span>
    <span class="n">_inherit_fields</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c"># Mapping field name/column_info object</span>
    <span class="c"># This is similar to _inherit_fields but:</span>
    <span class="c"># 1. includes self fields,</span>
    <span class="c"># 2. uses column_info instead of a triple.</span>
    <span class="n">_all_columns</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">_table</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_invalids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">_log_create</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_protected</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">,</span> <span class="s">&#39;create&#39;</span><span class="p">,</span> <span class="s">&#39;default_get&#39;</span><span class="p">,</span> <span class="s">&#39;perm_read&#39;</span><span class="p">,</span> <span class="s">&#39;unlink&#39;</span><span class="p">,</span> <span class="s">&#39;fields_get&#39;</span><span class="p">,</span> <span class="s">&#39;fields_view_get&#39;</span><span class="p">,</span> <span class="s">&#39;search&#39;</span><span class="p">,</span> <span class="s">&#39;name_get&#39;</span><span class="p">,</span> <span class="s">&#39;distinct_field_get&#39;</span><span class="p">,</span> <span class="s">&#39;name_search&#39;</span><span class="p">,</span> <span class="s">&#39;copy&#39;</span><span class="p">,</span> <span class="s">&#39;import_data&#39;</span><span class="p">,</span> <span class="s">&#39;search_count&#39;</span><span class="p">,</span> <span class="s">&#39;exists&#39;</span><span class="p">]</span>

    <span class="n">CONCURRENCY_CHECK_FIELD</span> <span class="o">=</span> <span class="s">&#39;__last_update&#39;</span>

<div class="viewcode-block" id="BaseModel.log"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;log() is deprecated. Please use OpenChatter notification system instead of the res.log mechanism.&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseModel.view_init"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.view_init">[docs]</a>    <span class="k">def</span> <span class="nf">view_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">fields_list</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override this method to do specific things when a view on the object is opened.&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
    <span class="k">def</span> <span class="nf">_field_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create entries in ir_model_fields for all the model&#39;s fields.</span>

<span class="sd">        If necessary, also create an entry in ir_model, and if called from the</span>
<span class="sd">        modules loading scheme (by receiving &#39;module&#39; in the context), also</span>
<span class="sd">        create entries in ir_model_data (for the model and the fields).</span>

<span class="sd">        - create an entry in ir_model (if there is not already one),</span>
<span class="sd">        - create an entry in ir_model_data (if there is not already one, and if</span>
<span class="sd">          &#39;module&#39; is in the context),</span>
<span class="sd">        - update ir_model_fields with the fields found in _columns</span>
<span class="sd">          (TODO there is some redundancy as _columns is updated from</span>
<span class="sd">          ir_model_fields in __init__).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT id FROM ir_model WHERE model=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span><span class="p">:</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SELECT nextval(</span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;ir_model_id_seq&#39;</span><span class="p">,))</span>
            <span class="n">model_id</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO ir_model (id,model, name, info,state) VALUES (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__doc__</span><span class="p">,</span> <span class="s">&#39;base&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_id</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;module&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">name_id</span> <span class="o">=</span> <span class="s">&#39;model_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;select * from ir_model_data where name=</span><span class="si">%s</span><span class="s"> and module=</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">name_id</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;module&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span><span class="p">:</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO ir_model_data (name,date_init,date_update,module,model,res_id) VALUES (</span><span class="si">%s</span><span class="s">, (now() at time zone &#39;UTC&#39;), (now() at time zone &#39;UTC&#39;), </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&quot;</span><span class="p">,</span> \
                    <span class="p">(</span><span class="n">name_id</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;module&#39;</span><span class="p">],</span> <span class="s">&#39;ir.model&#39;</span><span class="p">,</span> <span class="n">model_id</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT * FROM ir_model_fields WHERE model=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,))</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">():</span>
            <span class="n">cols</span><span class="p">[</span><span class="n">rec</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">rec</span>

        <span class="n">ir_model_fields_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.model.fields&#39;</span><span class="p">)</span>

        <span class="c"># sparse field should be created at the end, as it depends on its serialized field already existing</span>
        <span class="n">model_fields</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;sparse&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="ow">in</span> <span class="n">model_fields</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;model_id&#39;</span><span class="p">:</span> <span class="n">model_id</span><span class="p">,</span>
                <span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                <span class="s">&#39;field_description&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
                <span class="s">&#39;ttype&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">_type</span><span class="p">,</span>
                <span class="s">&#39;relation&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">_obj</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="s">&#39;view_load&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">view_load</span> <span class="ow">and</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;select_level&#39;</span><span class="p">:</span> <span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">select</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s">&#39;readonly&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readonly</span> <span class="ow">and</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;required&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">required</span> <span class="ow">and</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;selectable&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">selectable</span> <span class="ow">and</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;translate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">translate</span> <span class="ow">and</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;relation_field&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">_fields_id</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">one2many</span><span class="p">)</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="s">&#39;serialization_field_id&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;serialization_field&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
                <span class="c"># resolve link to serialization_field if specified by name</span>
                <span class="n">serialization_field_id</span> <span class="o">=</span> <span class="n">ir_model_fields_obj</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;model&#39;</span><span class="p">,</span><span class="s">&#39;=&#39;</span><span class="p">,</span><span class="n">vals</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">]),</span> <span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">serialization_field</span><span class="p">)])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">serialization_field_id</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Error&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Serialization field `</span><span class="si">%s</span><span class="s">` not found for sparse field `</span><span class="si">%s</span><span class="s">`!&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">serialization_field</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                <span class="n">vals</span><span class="p">[</span><span class="s">&#39;serialization_field_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">serialization_field_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c"># When its a custom field,it does not contain f.select</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;field_state&#39;</span><span class="p">,</span> <span class="s">&#39;base&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;manual&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;field_name&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">vals</span><span class="p">[</span><span class="s">&#39;select_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;select&#39;</span><span class="p">,</span> <span class="s">&#39;0&#39;</span><span class="p">)</span>
                <span class="c">#setting value to let the problem NOT occur next time</span>
                <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                    <span class="n">vals</span><span class="p">[</span><span class="s">&#39;select_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;select_level&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;select nextval(</span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;ir_model_fields_id_seq&#39;</span><span class="p">,))</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">vals</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;INSERT INTO ir_model_fields (</span>
<span class="s">                    id, model_id, model, name, field_description, ttype,</span>
<span class="s">                    relation,view_load,state,select_level,relation_field, translate, serialization_field_id</span>
<span class="s">                ) VALUES (</span>
<span class="s">                    </span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s"></span>
<span class="s">                )&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span>
                    <span class="nb">id</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="s">&#39;model_id&#39;</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="s">&#39;field_description&#39;</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="s">&#39;ttype&#39;</span><span class="p">],</span>
                     <span class="n">vals</span><span class="p">[</span><span class="s">&#39;relation&#39;</span><span class="p">],</span> <span class="nb">bool</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s">&#39;view_load&#39;</span><span class="p">]),</span> <span class="s">&#39;base&#39;</span><span class="p">,</span>
                    <span class="n">vals</span><span class="p">[</span><span class="s">&#39;select_level&#39;</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="s">&#39;relation_field&#39;</span><span class="p">],</span> <span class="nb">bool</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s">&#39;translate&#39;</span><span class="p">]),</span> <span class="n">vals</span><span class="p">[</span><span class="s">&#39;serialization_field_id&#39;</span><span class="p">]</span>
                <span class="p">))</span>
                <span class="k">if</span> <span class="s">&#39;module&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
                    <span class="n">name1</span> <span class="o">=</span> <span class="s">&#39;field_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select name from ir_model_data where name=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">name1</span><span class="p">,))</span>
                    <span class="k">if</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">():</span>
                        <span class="n">name1</span> <span class="o">=</span> <span class="n">name1</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO ir_model_data (name,date_init,date_update,module,model,res_id) VALUES (</span><span class="si">%s</span><span class="s">, (now() at time zone &#39;UTC&#39;), (now() at time zone &#39;UTC&#39;), </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&quot;</span><span class="p">,</span> \
                        <span class="p">(</span><span class="n">name1</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;module&#39;</span><span class="p">],</span> <span class="s">&#39;ir.model.fields&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">cols</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;update ir_model_fields set field_description=</span><span class="si">%s</span><span class="s"> where model=</span><span class="si">%s</span><span class="s"> and name=</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s">&#39;field_description&#39;</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]))</span>
                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;UPDATE ir_model_fields SET</span>
<span class="s">                            model_id=</span><span class="si">%s</span><span class="s">, field_description=</span><span class="si">%s</span><span class="s">, ttype=</span><span class="si">%s</span><span class="s">, relation=</span><span class="si">%s</span><span class="s">,</span>
<span class="s">                            view_load=</span><span class="si">%s</span><span class="s">, select_level=</span><span class="si">%s</span><span class="s">, readonly=</span><span class="si">%s</span><span class="s"> ,required=</span><span class="si">%s</span><span class="s">, selectable=</span><span class="si">%s</span><span class="s">, relation_field=</span><span class="si">%s</span><span class="s">, translate=</span><span class="si">%s</span><span class="s">, serialization_field_id=</span><span class="si">%s</span><span class="s"></span>
<span class="s">                        WHERE</span>
<span class="s">                            model=</span><span class="si">%s</span><span class="s"> AND name=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span>
                                <span class="n">vals</span><span class="p">[</span><span class="s">&#39;model_id&#39;</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="s">&#39;field_description&#39;</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="s">&#39;ttype&#39;</span><span class="p">],</span>
                                <span class="n">vals</span><span class="p">[</span><span class="s">&#39;relation&#39;</span><span class="p">],</span> <span class="nb">bool</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s">&#39;view_load&#39;</span><span class="p">]),</span>
                                <span class="n">vals</span><span class="p">[</span><span class="s">&#39;select_level&#39;</span><span class="p">],</span> <span class="nb">bool</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s">&#39;readonly&#39;</span><span class="p">]),</span> <span class="nb">bool</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s">&#39;required&#39;</span><span class="p">]),</span> <span class="nb">bool</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s">&#39;selectable&#39;</span><span class="p">]),</span> <span class="n">vals</span><span class="p">[</span><span class="s">&#39;relation_field&#39;</span><span class="p">],</span> <span class="nb">bool</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s">&#39;translate&#39;</span><span class="p">]),</span> <span class="n">vals</span><span class="p">[</span><span class="s">&#39;serialization_field_id&#39;</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
                            <span class="p">))</span>
                        <span class="k">break</span>

    <span class="c">#</span>
    <span class="c"># Goal: try to apply inheritance at the instanciation level and</span>
    <span class="c">#       put objects in the pool var</span>
    <span class="c">#</span>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="BaseModel.create_instance"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.create_instance">[docs]</a>    <span class="k">def</span> <span class="nf">create_instance</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Instanciate a given model.</span>

<span class="sd">        This class method instanciates the class of some model (i.e. a class</span>
<span class="sd">        deriving from osv or osv_memory). The class might be the class passed</span>
<span class="sd">        in argument or, if it inherits from another class, a class constructed</span>
<span class="sd">        by combining the two classes.</span>

<span class="sd">        The ``attributes`` argument specifies which parent class attributes</span>
<span class="sd">        have to be combined.</span>

<span class="sd">        TODO: the creation of the combined class is repeated at each call of</span>
<span class="sd">        this method. This is probably unnecessary.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;_columns&#39;</span><span class="p">,</span> <span class="s">&#39;_defaults&#39;</span><span class="p">,</span> <span class="s">&#39;_inherits&#39;</span><span class="p">,</span> <span class="s">&#39;_constraints&#39;</span><span class="p">,</span>
            <span class="s">&#39;_sql_constraints&#39;</span><span class="p">]</span>

        <span class="n">parent_names</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;_inherit&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_names</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_name</span> <span class="ow">or</span> <span class="n">parent_names</span>
                <span class="n">parent_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent_names</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;_name is mandatory in case of multiple inheritance&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">parent_name</span> <span class="ow">in</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">parent_names</span><span class="p">)</span><span class="o">==</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">parent_names</span> <span class="ow">or</span> <span class="p">[</span><span class="n">parent_names</span><span class="p">]):</span>
                <span class="n">parent_model</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_model</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;The model &quot;</span><span class="si">%s</span><span class="s">&quot; specifies an unexisting parent class &quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&#39;</span>
                        <span class="s">&#39;You may need to add a dependency on the parent class</span><span class="se">\&#39;</span><span class="s"> module.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent_name</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;_original_module&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="n">parent_model</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                    <span class="n">cls</span><span class="o">.</span><span class="n">_original_module</span> <span class="o">=</span> <span class="n">parent_model</span><span class="o">.</span><span class="n">_original_module</span>
                <span class="n">parent_class</span> <span class="o">=</span> <span class="n">parent_model</span><span class="o">.</span><span class="n">__class__</span>
                <span class="n">nattr</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                    <span class="n">new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">parent_model</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="p">{}))</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&#39;_columns&#39;</span><span class="p">:</span>
                        <span class="c"># Don&#39;t _inherit custom fields.</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">new</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">new</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">manual</span><span class="p">:</span>
                                <span class="k">del</span> <span class="n">new</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="s">&#39;update&#39;</span><span class="p">):</span>
                        <span class="n">new</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">{}))</span>
                    <span class="k">elif</span> <span class="n">s</span><span class="o">==</span><span class="s">&#39;_constraints&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">[]):</span>
                            <span class="n">exist</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">)):</span>
                                <span class="c">#For _constraints, we should check field and methods as well</span>
                                <span class="k">if</span> <span class="n">new</span><span class="p">[</span><span class="n">c2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">new</span><span class="p">[</span><span class="n">c2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
                                        <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">new</span><span class="p">[</span><span class="n">c2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;__name__&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="o">==</span> \
                                            <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;__name__&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)):</span>
                                    <span class="c"># If new class defines a constraint with</span>
                                    <span class="c"># same function name, we let it override</span>
                                    <span class="c"># the old one.</span>

                                    <span class="n">new</span><span class="p">[</span><span class="n">c2</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
                                    <span class="n">exist</span> <span class="o">=</span> <span class="bp">True</span>
                                    <span class="k">break</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">exist</span><span class="p">:</span>
                                <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">[]))</span>
                    <span class="n">nattr</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>

                <span class="c"># Keep links to non-inherited constraints, e.g. useful when exporting translations</span>
                <span class="n">nattr</span><span class="p">[</span><span class="s">&#39;_local_constraints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_constraints&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">nattr</span><span class="p">[</span><span class="s">&#39;_local_sql_constraints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_sql_constraints&#39;</span><span class="p">,</span> <span class="p">[])</span>

                <span class="n">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">parent_class</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">nattr</span><span class="p">,</span> <span class="n">_register</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_local_constraints</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;_constraints&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_local_sql_constraints</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;_sql_constraints&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;_original_module&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_original_module</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_module</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;_columns&#39;</span><span class="p">):</span>
            <span class="c"># float fields are registry-dependent (digit attribute). Duplicate them to avoid issues.</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;float&#39;</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">cr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
</div>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register this model.</span>

<span class="sd">        This doesn&#39;t create an instance but simply register the model</span>
<span class="sd">        as being part of the module where it is defined.</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c"># Set the module name (e.g. base, sale, accounting, ...) on the class.</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;_module&#39;</span><span class="p">):</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="n">module</span>

        <span class="c"># Record this class in the list of models to instantiate for this module,</span>
        <span class="c"># managed by the metaclass.</span>
        <span class="n">module_model_list</span> <span class="o">=</span> <span class="n">MetaModel</span><span class="o">.</span><span class="n">module_to_models</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">module_model_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cls</span><span class="o">.</span><span class="n">_custom</span><span class="p">:</span>
                <span class="n">module_model_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

        <span class="c"># Since we don&#39;t return an instance here, the __init__</span>
        <span class="c"># method won&#39;t be called.</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialize a model and make it part of the given registry.</span>

<span class="sd">        - copy the stored fields&#39; functions in the osv_pool,</span>
<span class="sd">        - update the _columns with the fields found in ir_model_fields,</span>
<span class="sd">        - ensure there is a many2one for each _inherits&#39;d parent,</span>
<span class="sd">        - update the children&#39;s _columns,</span>
<span class="sd">        - give a chance to each field to initialize itself.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_inherit&#39;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;The class </span><span class="si">%s</span><span class="s"> has to have a _name attribute&quot;</span> <span class="o">%</span> <span class="n">name</span>

            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="s">&#39;ValueError&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_log_access&#39;</span><span class="p">):</span>
            <span class="c"># If _log_access is not specified, it is the same value as _auto.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;_auto&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">store_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">store_field</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;digits_change&#39;</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">digits_change</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">not_this_field</span><span class="p">(</span><span class="n">stored_func</span><span class="p">):</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">stored_func</span>
                <span class="k">return</span> <span class="n">x</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">!=</span> <span class="n">store_field</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_store_function</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">not_this_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_store_function</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">function</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">store</span>
            <span class="k">if</span> <span class="n">sm</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">sm</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="p">{}:</span> <span class="n">ids</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="bp">None</span><span class="p">)}</span>
            <span class="k">for</span> <span class="nb">object</span><span class="p">,</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">sm</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">fnct</span><span class="p">,</span> <span class="n">fields2</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span> <span class="o">=</span> <span class="n">aa</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">fnct</span><span class="p">,</span> <span class="n">fields2</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="o">=</span> <span class="n">aa</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="s">&#39;Error&#39;</span><span class="p">,</span>
                        <span class="p">(</span><span class="s">&#39;Invalid function definition </span><span class="si">%s</span><span class="s"> in object </span><span class="si">%s</span><span class="s"> !</span><span class="se">\n</span><span class="s">You must use the definition: store={object:(fnct, fields, priority, time length)}.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">store_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_store_function</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">store_field</span><span class="p">,</span> <span class="n">fnct</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fields2</span><span class="p">)</span> <span class="k">if</span> <span class="n">fields2</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_store_function</span><span class="p">[</span><span class="nb">object</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_store_function</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">store_field</span><span class="p">,</span> <span class="n">fnct</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fields2</span><span class="p">)</span> <span class="k">if</span> <span class="n">fields2</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_store_function</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_constraints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_sql_error</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>

        <span class="c"># Load manual fields</span>

        <span class="c"># Check the query is already done for all modules of if we need to</span>
        <span class="c"># do it ourselves.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">fields_by_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">manual_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">fields_by_model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SELECT * FROM ir_model_fields WHERE model=</span><span class="si">%s</span><span class="s"> AND state=</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s">&#39;manual&#39;</span><span class="p">))</span>
            <span class="n">manual_fields</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">manual_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;string&#39;</span><span class="p">:</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;field_description&#39;</span><span class="p">],</span>
                <span class="s">&#39;required&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;required&#39;</span><span class="p">]),</span>
                <span class="s">&#39;readonly&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;readonly&#39;</span><span class="p">]),</span>
                <span class="s">&#39;domain&#39;</span><span class="p">:</span> <span class="nb">eval</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;domain&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;domain&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s">&#39;size&#39;</span><span class="p">:</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s">&#39;ondelete&#39;</span><span class="p">:</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;on_delete&#39;</span><span class="p">],</span>
                <span class="s">&#39;translate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;translate&#39;</span><span class="p">]),</span>
                <span class="s">&#39;manual&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                <span class="c">#&#39;select&#39;: int(field[&#39;select_level&#39;])</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;serialization_field_id&#39;</span><span class="p">]:</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SELECT name FROM ir_model_fields WHERE id=</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;serialization_field_id&#39;</span><span class="p">],))</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;serialization_field&#39;</span><span class="p">:</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;ttype&#39;</span><span class="p">]})</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;ttype&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;many2one&#39;</span><span class="p">,</span> <span class="s">&#39;one2many&#39;</span><span class="p">,</span> <span class="s">&#39;many2many&#39;</span><span class="p">]:</span>
                    <span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;relation&#39;</span><span class="p">:</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;relation&#39;</span><span class="p">]})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">sparse</span><span class="p">(</span><span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;ttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;selection&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">selection</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;selection&#39;</span><span class="p">]),</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;ttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;reference&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">reference</span><span class="p">(</span><span class="n">selection</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;selection&#39;</span><span class="p">]),</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;ttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;many2one&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">many2one</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;relation&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;ttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;one2many&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">one2many</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;relation&#39;</span><span class="p">],</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;relation_field&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;ttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;many2many&#39;</span><span class="p">:</span>
                <span class="n">_rel1</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;relation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">_rel2</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">_rel_name</span> <span class="o">=</span> <span class="s">&#39;x_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_rel&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_rel1</span><span class="p">,</span> <span class="n">_rel2</span><span class="p">,</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">many2many</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;relation&#39;</span><span class="p">],</span> <span class="n">_rel_name</span><span class="p">,</span> <span class="s">&#39;id1&#39;</span><span class="p">,</span> <span class="s">&#39;id2&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;ttype&#39;</span><span class="p">])(</span><span class="o">**</span><span class="n">attrs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_check</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_reload</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="s">&#39;_id_seq&#39;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">),</span> <span class="s">&#39;Default function defined in </span><span class="si">%s</span><span class="s"> but field </span><span class="si">%s</span><span class="s"> does not exist !&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">k</span><span class="p">,)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">restart</span><span class="p">()</span>

        <span class="c"># Transience</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_transient</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transient_check_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transient_max_count</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;osv_memory_count_limit&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transient_max_hours</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;osv_memory_age_limit&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">,</span> <span class="s">&quot;TransientModels must have log_access turned on, &quot;</span>\
                                     <span class="s">&quot;in order to implement their access rights policy&quot;</span>

        <span class="c"># Validate rec_name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="s">&quot;Invalid rec_name </span><span class="si">%s</span><span class="s"> for model </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span> <span class="o">=</span> <span class="s">&#39;name&#39;</span>


    <span class="k">def</span> <span class="nf">__export_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">check_type</span><span class="p">(</span><span class="n">field_type</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">field_type</span> <span class="o">==</span> <span class="s">&#39;float&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>
            <span class="k">elif</span> <span class="n">field_type</span> <span class="o">==</span> <span class="s">&#39;integer&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">field_type</span> <span class="o">==</span> <span class="s">&#39;boolean&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&#39;False&#39;</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">selection_field</span><span class="p">(</span><span class="n">in_field</span><span class="p">):</span>
            <span class="n">col_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">in_field</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">col_obj</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">return</span>  <span class="n">col_obj</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">col_obj</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">selection_field</span><span class="p">(</span><span class="n">col_obj</span><span class="o">.</span><span class="n">_inherits</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="k">def</span> <span class="nf">_get_xml_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.model.data&#39;</span><span class="p">)</span>
            <span class="n">data_ids</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;model&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;res_id&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_ids</span><span class="p">):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">data_ids</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;module&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;module&#39;</span><span class="p">]:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;module&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">postfix</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">postfix</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">postfix</span><span class="p">))</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">model_data</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">n</span><span class="p">)]):</span>
                        <span class="k">break</span>
                    <span class="n">postfix</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">model_data</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">n</span><span class="p">,</span>
                    <span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                    <span class="s">&#39;res_id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span>
                    <span class="s">&#39;module&#39;</span><span class="p">:</span> <span class="s">&#39;__export__&#39;</span><span class="p">,</span>
                <span class="p">})</span>
                <span class="n">r</span> <span class="o">=</span> <span class="s">&#39;__export__.&#39;</span><span class="o">+</span><span class="n">n</span>
            <span class="k">return</span> <span class="n">r</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)))</span>
        <span class="n">done</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fpos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">fpos</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">row</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.id&#39;</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;id&#39;</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">_get_xml_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                        <span class="c"># To display external name of selection field when its exported</span>
                        <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                        <span class="k">elif</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">cols</span> <span class="o">=</span> <span class="n">selection_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cols</span> <span class="ow">and</span> <span class="n">cols</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;selection&#39;</span><span class="p">:</span>
                            <span class="n">sel_list</span> <span class="o">=</span> <span class="n">cols</span><span class="o">.</span><span class="n">selection</span>
                            <span class="k">if</span> <span class="n">r</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">sel_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">([]):</span>
                                <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sel_list</span> <span class="k">if</span> <span class="n">r</span><span class="o">==</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                                <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">False</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="n">check_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">_type</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">:</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="n">check_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span><span class="p">)</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">fpos</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span> <span class="ow">or</span> <span class="bp">False</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">browse_record_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                        <span class="n">first</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="n">fields2</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">f</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span> \
                                <span class="ow">or</span> <span class="p">[],</span> <span class="n">fields</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">fields2</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fields2</span> <span class="k">if</span> <span class="n">x</span><span class="p">]:</span>
                                <span class="k">break</span>
                        <span class="n">done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fields2</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cols</span> <span class="ow">and</span> <span class="n">cols</span><span class="o">.</span><span class="n">_type</span><span class="o">==</span><span class="s">&#39;many2many&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="n">fpos</span><span class="p">])</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="n">fpos</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;id&#39;</span><span class="p">):</span>
                            <span class="n">data</span><span class="p">[</span><span class="n">fpos</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">_get_xml_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>
                            <span class="k">break</span>

                        <span class="k">for</span> <span class="n">row2</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                            <span class="n">lines2</span> <span class="o">=</span> <span class="n">row2</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">__export_row</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">row2</span><span class="p">,</span> <span class="n">fields2</span><span class="p">,</span>
                                    <span class="n">context</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">fpos2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)):</span>
                                    <span class="k">if</span> <span class="n">lines2</span> <span class="ow">and</span> <span class="n">lines2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">fpos2</span><span class="p">]:</span>
                                        <span class="n">data</span><span class="p">[</span><span class="n">fpos2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">fpos2</span><span class="p">]</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="n">fpos</span><span class="p">]:</span>
                                    <span class="n">dt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                                    <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                                        <span class="n">name_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">_table_name</span><span class="p">)</span><span class="o">.</span><span class="n">_rec_name</span>
                                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rr</span><span class="p">[</span><span class="n">name_relation</span><span class="p">],</span> <span class="n">browse_record</span><span class="p">):</span>
                                            <span class="n">rr</span> <span class="o">=</span> <span class="n">rr</span><span class="p">[</span><span class="n">name_relation</span><span class="p">]</span>
                                        <span class="n">rr_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">_table_name</span><span class="p">)</span><span class="o">.</span><span class="n">name_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">[</span><span class="n">rr</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
                                        <span class="n">rr_name</span> <span class="o">=</span> <span class="n">rr_name</span> <span class="ow">and</span> <span class="n">rr_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">rr_name</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
                                        <span class="n">dt</span> <span class="o">+=</span> <span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">rr_name</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;,&#39;</span>
                                    <span class="n">data</span><span class="p">[</span><span class="n">fpos</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="k">break</span>
                                <span class="n">lines</span> <span class="o">+=</span> <span class="n">lines2</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                                <span class="n">first</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">lines</span> <span class="o">+=</span> <span class="n">lines2</span>
                        <span class="k">break</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">browse_record</span><span class="p">):</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">_table_name</span><span class="p">)</span><span class="o">.</span><span class="n">name_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">fpos</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">r</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span> <span class="o">+</span> <span class="n">lines</span>

<div class="viewcode-block" id="BaseModel.export_data"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.export_data">[docs]</a>    <span class="k">def</span> <span class="nf">export_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">fields_to_export</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export fields for selected objects</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param uid: current user id</span>
<span class="sd">        :param ids: list of ids</span>
<span class="sd">        :param fields_to_export: list of fields</span>
<span class="sd">        :param context: context arguments, like lang, time zone</span>
<span class="sd">        :rtype: dictionary with a *datas* matrix</span>

<span class="sd">        This method is used when exporting data via client menu</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">f</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="mi">2</span><span class="p">]})</span>
        <span class="n">fields_to_export</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">fix_import_export_id_paths</span><span class="p">,</span> <span class="n">fields_to_export</span><span class="p">)</span>
        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
            <span class="n">datas</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__export_row</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">fields_to_export</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;datas&#39;</span><span class="p">:</span> <span class="n">datas</span><span class="p">}</span>
</div>
<div class="viewcode-block" id="BaseModel.import_data"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.import_data">[docs]</a>    <span class="k">def</span> <span class="nf">import_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">datas</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;init&#39;</span><span class="p">,</span> <span class="n">current_module</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">noupdate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. deprecated:: 7.0</span>
<span class="sd">            Use :meth:`~load` instead</span>

<span class="sd">        Import given data in given module</span>

<span class="sd">        This method is used when importing data via client menu.</span>

<span class="sd">        Example of fields to import for a sale.order::</span>

<span class="sd">            .id,                         (=database_id)</span>
<span class="sd">            partner_id,                  (=name_search)</span>
<span class="sd">            order_line/.id,              (=database_id)</span>
<span class="sd">            order_line/name,</span>
<span class="sd">            order_line/product_id/id,    (=xml id)</span>
<span class="sd">            order_line/price_unit,</span>
<span class="sd">            order_line/product_uom_qty,</span>
<span class="sd">            order_line/product_uom/id    (=xml_id)</span>

<span class="sd">        This method returns a 4-tuple with the following structure::</span>

<span class="sd">            (return_code, errored_resource, error_message, unused)</span>

<span class="sd">        * The first item is a return code, it is ``-1`` in case of</span>
<span class="sd">          import error, or the last imported row number in case of success</span>
<span class="sd">        * The second item contains the record data dict that failed to import</span>
<span class="sd">          in case of error, otherwise it&#39;s 0</span>
<span class="sd">        * The third item contains an error message string in case of error,</span>
<span class="sd">          otherwise it&#39;s 0</span>
<span class="sd">        * The last item is currently unused, with no specific semantics</span>

<span class="sd">        :param fields: list of fields to import</span>
<span class="sd">        :param datas: data to import</span>
<span class="sd">        :param mode: &#39;init&#39; or &#39;update&#39; for record creation</span>
<span class="sd">        :param current_module: module name</span>
<span class="sd">        :param noupdate: flag for record creation</span>
<span class="sd">        :param filename: optional file to store partial import state for recovery</span>
<span class="sd">        :returns: 4-tuple in the form (return_code, errored_resource, error_message, unused)</span>
<span class="sd">        :rtype: (int, dict or 0, str or 0, str or 0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">context</span><span class="p">[</span><span class="s">&#39;_import_current_module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_module</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">fix_import_export_id_paths</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
        <span class="n">ir_model_data_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.model.data&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;error&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;import_partial&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;import_partial&#39;</span><span class="p">),</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">partial_import_file</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">partial_import_file</span><span class="p">)</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">xml_id</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_records</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_records</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">datas</span><span class="p">,</span>
                                                  <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">),</span>
                            <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">):</span>
                <span class="n">ir_model_data_obj</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                     <span class="n">current_module</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">xml_id</span><span class="o">=</span><span class="n">xml_id</span><span class="p">,</span>
                     <span class="n">noupdate</span><span class="o">=</span><span class="n">noupdate</span><span class="p">,</span> <span class="n">res_id</span><span class="o">=</span><span class="n">res_id</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;rows&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;to&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;import_partial&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">filename</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">position</span><span class="o">%</span><span class="mi">100</span><span class="p">)):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;import_partial&#39;</span><span class="p">),</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">partial_import</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">partial_import</span><span class="p">)</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">position</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;import_partial&#39;</span><span class="p">),</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">partial_import</span><span class="p">:</span>
                        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">partial_import</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;defer_parent_store_computation&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store_compute</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{},</span> <span class="s">&#39;Line </span><span class="si">%d</span><span class="s"> : </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">position</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;defer_parent_store_computation&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store_compute</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">position</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="BaseModel.load"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to load the data matrix, and returns a list of ids (or</span>
<span class="sd">        ``False`` if there was an error and no id could be generated) and a</span>
<span class="sd">        list of messages.</span>

<span class="sd">        The ids are those of the records created and saved (in database), in</span>
<span class="sd">        the same order they were extracted from the file. They can be passed</span>
<span class="sd">        directly to :meth:`~read`</span>

<span class="sd">        :param fields: list of fields to import, at the same index as the corresponding data</span>
<span class="sd">        :type fields: list(str)</span>
<span class="sd">        :param data: row-major matrix of data to import</span>
<span class="sd">        :type data: list(list(str))</span>
<span class="sd">        :param dict context:</span>
<span class="sd">        :returns: {ids: list(int)|False, messages: [Message]}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SAVEPOINT model_load&#39;</span><span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">fix_import_export_id_paths</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
        <span class="n">ModelData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clear_caches</span><span class="p">()</span>

        <span class="n">fg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

        <span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;init&#39;</span>
        <span class="n">current_module</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">noupdate</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_records</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_extract_records</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
                                      <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">),</span>
                <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SAVEPOINT model_load_save&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">InternalError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="c"># broken transaction, exit and hope the source error was</span>
                <span class="c"># already logged</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;error&#39;</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">):</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p">,</span><span class="n">message</span><span class="o">=</span>
                        <span class="s">u&quot;Unknown database error: &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">break</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ModelData</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                     <span class="n">current_module</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">xml_id</span><span class="o">=</span><span class="n">xid</span><span class="p">,</span>
                     <span class="n">noupdate</span><span class="o">=</span><span class="n">noupdate</span><span class="p">,</span> <span class="n">res_id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">))</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;RELEASE SAVEPOINT model_load_save&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">Warning</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;warning&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ROLLBACK TO SAVEPOINT model_load_save&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">info</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">PGERROR_TO_OE</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">pgcode</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">fg</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">e</span><span class="p">)))</span>
                <span class="c"># Failed to write, log to messages, rollback savepoint (to</span>
                <span class="c"># avoid broken transaction) and keep going</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ROLLBACK TO SAVEPOINT model_load_save&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;error&#39;</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">):</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ROLLBACK TO SAVEPOINT model_load&#39;</span><span class="p">)</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;ids&#39;</span><span class="p">:</span> <span class="n">ids</span><span class="p">,</span> <span class="s">&#39;messages&#39;</span><span class="p">:</span> <span class="n">messages</span><span class="p">}</span></div>
    <span class="k">def</span> <span class="nf">_extract_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">fields_</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
                         <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates record dicts from the data sequence.</span>

<span class="sd">        The result is a generator of dicts mapping field names to raw</span>
<span class="sd">        (unconverted, unvalidated) values.</span>

<span class="sd">        For relational fields, if sub-fields were provided the value will be</span>
<span class="sd">        a list of sub-records</span>

<span class="sd">        The following sub-fields may be set on the record (by key):</span>
<span class="sd">        * None is the name_get for the record (to use with name_create/name_search)</span>
<span class="sd">        * &quot;id&quot; is the External ID for the record</span>
<span class="sd">        * &quot;.id&quot; is the Database ID for the record</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">column</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())</span>
        <span class="c"># Fake columns to avoid special cases in extractor</span>
        <span class="n">columns</span><span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">char</span><span class="p">(</span><span class="s">&#39;rec_name&#39;</span><span class="p">)</span>
        <span class="n">columns</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">char</span><span class="p">(</span><span class="s">&#39;External ID&#39;</span><span class="p">)</span>
        <span class="n">columns</span><span class="p">[</span><span class="s">&#39;.id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="s">&#39;Database ID&#39;</span><span class="p">)</span>

        <span class="c"># m2o fields can&#39;t be on multiple lines so exclude them from the</span>
        <span class="c"># is_relational field rows filter, but special-case it later on to</span>
        <span class="c"># be handled with relational fields (as it can have subfields)</span>
        <span class="n">is_relational</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">field</span><span class="p">:</span> <span class="n">columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;one2many&#39;</span><span class="p">,</span> <span class="s">&#39;many2many&#39;</span><span class="p">,</span> <span class="s">&#39;many2one&#39;</span><span class="p">)</span>
        <span class="n">get_o2m_values</span> <span class="o">=</span> <span class="n">itemgetter_tuple</span><span class="p">(</span>
            <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields_</span><span class="p">)</span>
                  <span class="k">if</span> <span class="n">columns</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;one2many&#39;</span><span class="p">])</span>
        <span class="n">get_nono2m_values</span> <span class="o">=</span> <span class="n">itemgetter_tuple</span><span class="p">(</span>
            <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields_</span><span class="p">)</span>
                  <span class="k">if</span> <span class="n">columns</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">_type</span> <span class="o">!=</span> <span class="s">&#39;one2many&#39;</span><span class="p">])</span>
        <span class="c"># Checks if the provided row has any non-empty non-relational field</span>
        <span class="k">def</span> <span class="nf">only_o2m_values</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">get_nono2m_values</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">get_o2m_values</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">row</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>

        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span> <span class="k">return</span>

            <span class="n">row</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="c"># copy non-relational fields to record dict</span>
            <span class="n">record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="n">fields_</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_relational</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="c"># Get all following rows which have relational values attached to</span>
            <span class="c"># the current record (no non-relational values)</span>
            <span class="n">record_span</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">takewhile</span><span class="p">(</span>
                <span class="n">only_o2m_values</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
            <span class="c"># stitch record row back on for relational fields</span>
            <span class="n">record_span</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">([</span><span class="n">row</span><span class="p">],</span> <span class="n">record_span</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">relfield</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_</span>
                             <span class="k">if</span> <span class="n">is_relational</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">column</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="n">relfield</span><span class="p">]</span>
                <span class="c"># FIXME: how to not use _obj without relying on fields_get?</span>
                <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="n">column</span><span class="o">.</span><span class="n">_obj</span><span class="p">]</span>

                <span class="c"># get only cells for this sub-field, should be strictly</span>
                <span class="c"># non-empty, field path [None] is for name_get column</span>
                <span class="n">indices</span><span class="p">,</span> <span class="n">subfields</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">or</span> <span class="p">[</span><span class="bp">None</span><span class="p">])</span>
                                           <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields_</span><span class="p">)</span>
                                           <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">relfield</span><span class="p">))</span>

                <span class="c"># return all rows which have at least one value for the</span>
                <span class="c"># subfields of relfield</span>
                <span class="n">relfield_data</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="nb">any</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">itemgetter_tuple</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="n">record_span</span><span class="p">))</span>
                <span class="n">record</span><span class="p">[</span><span class="n">relfield</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">subrecord</span>
                    <span class="k">for</span> <span class="n">subrecord</span><span class="p">,</span> <span class="n">_subinfo</span> <span class="ow">in</span> <span class="n">Model</span><span class="o">.</span><span class="n">_extract_records</span><span class="p">(</span>
                        <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">subfields</span><span class="p">,</span> <span class="n">relfield_data</span><span class="p">,</span>
                        <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)]</span>

            <span class="k">yield</span> <span class="n">record</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;rows&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;from&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
                <span class="s">&#39;to&#39;</span><span class="p">:</span> <span class="n">index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">record_span</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">}}</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">record_span</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_convert_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span>
                         <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Converts records from the source iterable (recursive dicts of</span>
<span class="sd">        strings) into forms which can be written to the database (via</span>
<span class="sd">        self.create or (ir.model.data)._update)</span>

<span class="sd">        :returns: a list of triplets of (id, xid, record)</span>
<span class="sd">        :rtype: list((int|None, str|None, dict))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">Converter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;ir.fields.converter&#39;</span><span class="p">]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">column</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())</span>
        <span class="n">Translation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;ir.translation&#39;</span><span class="p">]</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">Translation</span><span class="o">.</span><span class="n">_get_source</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">+</span> <span class="s">&#39;,&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="p">,</span> <span class="s">&#39;field&#39;</span><span class="p">,</span>
                                         <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lang&#39;</span><span class="p">))</span>
                 <span class="ow">or</span> <span class="n">column</span><span class="o">.</span><span class="n">string</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())</span>

        <span class="n">convert</span> <span class="o">=</span> <span class="n">Converter</span><span class="o">.</span><span class="n">for_model</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_log</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="s">&#39;warning&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span> <span class="k">else</span> <span class="s">&#39;error&#39;</span>
            <span class="c"># logs the logical (not human-readable) field name for automated</span>
            <span class="c"># processing of response, but injects human readable in message</span>
            <span class="n">record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                          <span class="n">message</span><span class="o">=</span><span class="nb">unicode</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">%</span> <span class="n">base</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">record</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">log</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

        <span class="n">stream</span> <span class="o">=</span> <span class="n">CountingStream</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record</span><span class="p">,</span> <span class="n">extras</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">dbid</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">xid</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># name_get/name_create</span>
            <span class="k">if</span> <span class="bp">None</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span> <span class="k">pass</span>
            <span class="c"># xid</span>
            <span class="k">if</span> <span class="s">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                <span class="n">xid</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
            <span class="c"># dbid</span>
            <span class="k">if</span> <span class="s">&#39;.id&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dbid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s">&#39;.id&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c"># in case of overridden id column</span>
                    <span class="n">dbid</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s">&#39;.id&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">dbid</span><span class="p">)],</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">):</span>
                    <span class="n">log</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">extras</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p">,</span>
                        <span class="n">record</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                        <span class="n">field</span><span class="o">=</span><span class="s">&#39;.id&#39;</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">u&quot;Unknown database identifier &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">dbid</span><span class="p">))</span>
                    <span class="n">dbid</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="n">converted</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">field</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>\
                <span class="n">_log</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">extras</span><span class="p">,</span> <span class="n">record</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field_names</span><span class="p">[</span><span class="n">field</span><span class="p">]),</span> <span class="n">field</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>

            <span class="k">yield</span> <span class="n">dbid</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">converted</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extras</span><span class="p">,</span> <span class="n">record</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<div class="viewcode-block" id="BaseModel.get_invalid_fields"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.get_invalid_fields">[docs]</a>    <span class="k">def</span> <span class="nf">get_invalid_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_invalids</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">context</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">lng</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lang&#39;</span><span class="p">)</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.translation&#39;</span><span class="p">)</span>
        <span class="n">error_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">:</span>
            <span class="n">fun</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">constraint</span>
            <span class="c"># We don&#39;t pass around the context here: validation code</span>
            <span class="c"># must always yield the same results.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">):</span>
                <span class="c"># Check presence of __call__ directly instead of using</span>
                <span class="c"># callable() because it will be deprecated as of Python 3.0</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">&#39;__call__&#39;</span><span class="p">):</span>
                    <span class="n">tmp_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tmp_msg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="n">tmp_msg</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">tmp_msg</span>
                        <span class="n">translated_msg</span> <span class="o">=</span> <span class="n">tmp_msg</span> <span class="o">%</span> <span class="n">params</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">translated_msg</span> <span class="o">=</span> <span class="n">tmp_msg</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">translated_msg</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">_get_source</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s">&#39;constraint&#39;</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="n">error_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">_</span><span class="p">(</span><span class="s">&quot;Error occurred while validating the field(s) </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span> <span class="n">translated_msg</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_invalids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error_msgs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="s">&#39;ValidateError&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">error_msgs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_invalids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<div class="viewcode-block" id="BaseModel.default_get"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.default_get">[docs]</a>    <span class="k">def</span> <span class="nf">default_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">fields_list</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns default values for the fields in fields_list.</span>

<span class="sd">        :param fields_list: list of fields to get the default values for (example [&#39;field1&#39;, &#39;field2&#39;,])</span>
<span class="sd">        :type fields_list: list</span>
<span class="sd">        :param context: optional context dictionary - it may contains keys for specifying certain options</span>
<span class="sd">                        like ``context_lang`` (language) or ``context_tz`` (timezone) to alter the results of the call.</span>
<span class="sd">                        It may contain keys in the form ``default_XXX`` (where XXX is a field name), to set</span>
<span class="sd">                        or override a default value for a field.</span>
<span class="sd">                        A special ``bin_size`` boolean flag may also be passed in the context to request the</span>
<span class="sd">                        value of all fields.binary columns to be returned as the size of the binary instead of its</span>
<span class="sd">                        contents. This can also be selectively overriden by passing a field-specific flag</span>
<span class="sd">                        in the form ``bin_size_XXX: True/False`` where ``XXX`` is the name of the field.</span>
<span class="sd">                        Note: The ``bin_size_XXX`` form is new in OpenERP v6.0.</span>
<span class="sd">        :return: dictionary of the default values (set on the object model class, through user preferences, or in the context)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># trigger view init hook</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">fields_list</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># get the default values for the inherited fields</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">default_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">fields_list</span><span class="p">,</span>
                <span class="n">context</span><span class="p">))</span>

        <span class="c"># get the default values defined in the object</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">[</span><span class="n">f</span><span class="p">]):</span>
                    <span class="n">defaults</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">[</span><span class="n">f</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">defaults</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>

            <span class="n">fld_def</span> <span class="o">=</span> <span class="p">((</span><span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> \
                    <span class="ow">or</span> <span class="p">((</span><span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> \
                    <span class="ow">or</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fld_def</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">property</span><span class="p">):</span>
                <span class="n">property_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.property&#39;</span><span class="p">)</span>
                <span class="n">prop_value</span> <span class="o">=</span> <span class="n">property_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prop_value</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop_value</span><span class="p">,</span> <span class="p">(</span><span class="n">browse_record</span><span class="p">,</span> <span class="n">browse_null</span><span class="p">)):</span>
                        <span class="n">defaults</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop_value</span><span class="o">.</span><span class="n">id</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">defaults</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop_value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
                        <span class="n">defaults</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># get the default values set by the user and override the default</span>
        <span class="c"># values defined in the object</span>
        <span class="n">ir_values_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.values&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">ir_values_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">])</span>
        <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_value</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_list</span><span class="p">:</span>
                <span class="n">fld_def</span> <span class="o">=</span> <span class="p">(</span><span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">fld_def</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2one&#39;</span><span class="p">:</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fld_def</span><span class="o">.</span><span class="n">_obj</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">field_value</span> <span class="ow">or</span> <span class="bp">False</span><span class="p">)]):</span>
                        <span class="k">continue</span>
                <span class="k">if</span> <span class="n">fld_def</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2many&#39;</span><span class="p">:</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fld_def</span><span class="o">.</span><span class="n">_obj</span><span class="p">)</span>
                    <span class="n">field_value2</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field_value</span> <span class="ow">or</span> <span class="p">[])):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span>
                            <span class="n">field_value</span><span class="p">[</span><span class="n">i</span><span class="p">])]):</span>
                            <span class="k">continue</span>
                        <span class="n">field_value2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_value</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">field_value</span> <span class="o">=</span> <span class="n">field_value2</span>
                <span class="k">if</span> <span class="n">fld_def</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;one2many&#39;</span><span class="p">:</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fld_def</span><span class="o">.</span><span class="n">_obj</span><span class="p">)</span>
                    <span class="n">field_value2</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">field_value</span> <span class="ow">or</span> <span class="p">[])):</span>
                        <span class="n">field_value2</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                        <span class="k">for</span> <span class="n">field2</span> <span class="ow">in</span> <span class="n">field_value</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">field2</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field2</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2one&#39;</span><span class="p">:</span>
                                <span class="n">obj2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field2</span><span class="p">]</span><span class="o">.</span><span class="n">_obj</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">obj2</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span>
                                        <span class="p">[(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">field_value</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">field2</span><span class="p">])]):</span>
                                    <span class="k">continue</span>
                            <span class="k">elif</span> <span class="n">field2</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">field2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2one&#39;</span><span class="p">:</span>
                                <span class="n">obj2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">field2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">_obj</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">obj2</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span>
                                        <span class="p">[(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">field_value</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">field2</span><span class="p">])]):</span>
                                    <span class="k">continue</span>
                            <span class="c"># TODO add test for many2many and one2many</span>
                            <span class="n">field_value2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">field2</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_value</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">field2</span><span class="p">]</span>
                    <span class="n">field_value</span> <span class="o">=</span> <span class="n">field_value2</span>
                <span class="n">defaults</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_value</span>

        <span class="c"># get the default values from the context</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">context</span> <span class="ow">or</span> <span class="p">{}:</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;default_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">fields_list</span><span class="p">):</span>
                <span class="n">defaults</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">8</span><span class="p">:]]</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">defaults</span>
</div>
<div class="viewcode-block" id="BaseModel.fields_get_keys"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.fields_get_keys">[docs]</a>    <span class="k">def</span> <span class="nf">fields_get_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="c"># TODO I believe this loop can be replace by</span>
        <span class="c"># res.extend(self._inherit_fields.key())</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">fields_get_keys</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span>
</div>
    <span class="k">def</span> <span class="nf">_rec_name_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">rec_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span>
        <span class="k">if</span> <span class="n">rec_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
            <span class="n">rec_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s">&quot;id&quot;</span>
        <span class="k">return</span> <span class="n">rec_name</span>

    <span class="c">#</span>
    <span class="c"># Overload this method if you need a window title which depends on the context</span>
    <span class="c">#</span>
<div class="viewcode-block" id="BaseModel.view_header_get"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.view_header_get">[docs]</a>    <span class="k">def</span> <span class="nf">view_header_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s">&#39;form&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="BaseModel.user_has_groups"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.user_has_groups">[docs]</a>    <span class="k">def</span> <span class="nf">user_has_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return true if the user is at least member of one of the groups</span>
<span class="sd">           in groups_str. Typically used to resolve ``groups`` attribute</span>
<span class="sd">           in view and model definitions.</span>

<span class="sd">           :param str groups: comma-separated list of fully-qualified group</span>
<span class="sd">                              external IDs, e.g.: ``base.group_user,base.group_system``</span>
<span class="sd">           :return: True if the current user is a member of one of the</span>
<span class="sd">                    given groups</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;res.users&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">group_ext_id</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">group_ext_id</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)])</span>
</div>
    <span class="k">def</span> <span class="nf">__view_look_dom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">view_id</span><span class="p">,</span> <span class="n">in_tree_view</span><span class="p">,</span> <span class="n">model_fields</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the description of the fields in the node.</span>

<span class="sd">        In a normal call to this method, node is a complete view architecture</span>
<span class="sd">        but it is actually possible to give some sub-node (this is used so</span>
<span class="sd">        that the method can call itself recursively).</span>

<span class="sd">        Originally, the field descriptions are drawn from the node itself.</span>
<span class="sd">        But there is now some code calling fields_get() in order to merge some</span>
<span class="sd">        of those information in the architecture.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">children</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">modifiers</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">s</span>

        <span class="k">def</span> <span class="nf">check_group</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Apply group restrictions,  may be set at view level or model level::</span>
<span class="sd">               * at view level this means the element should be made invisible to</span>
<span class="sd">                 people who are not members</span>
<span class="sd">               * at model level (exclusively for fields, obviously), this means</span>
<span class="sd">                 the field should be completely removed from the view, as it is</span>
<span class="sd">                 completely unavailable for non-members</span>

<span class="sd">               :return: True if field should be included in the result of fields_view_get</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;field&#39;</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="p">:</span>
                <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">column</span>
                <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">groups</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_groups</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span>
                                                              <span class="n">groups</span><span class="o">=</span><span class="n">column</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span>
                                                              <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">):</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="n">fields</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="c"># no point processing view-level ``groups`` anymore, return</span>
                    <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;groups&#39;</span><span class="p">):</span>
                <span class="n">can_see</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_groups</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span>
                                               <span class="n">groups</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;groups&#39;</span><span class="p">),</span>
                                               <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">can_see</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;invisible&#39;</span><span class="p">,</span> <span class="s">&#39;1&#39;</span><span class="p">)</span>
                    <span class="n">modifiers</span><span class="p">[</span><span class="s">&#39;invisible&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="s">&#39;attrs&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                        <span class="k">del</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;attrs&#39;</span><span class="p">])</span> <span class="c">#avoid making field visible later</span>
                <span class="k">del</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;groups&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;field&#39;</span><span class="p">,</span> <span class="s">&#39;node&#39;</span><span class="p">,</span> <span class="s">&#39;arrow&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;object&#39;</span><span class="p">):</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">views</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">xml</span> <span class="o">=</span> <span class="s">&quot;&lt;form&gt;&quot;</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;field&#39;</span><span class="p">:</span>
                        <span class="n">xml</span> <span class="o">+=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="n">xml</span> <span class="o">+=</span> <span class="s">&quot;&lt;/form&gt;&quot;</span>
                <span class="n">new_xml</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">encode</span><span class="p">(</span><span class="n">xml</span><span class="p">))</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">ctx</span><span class="p">[</span><span class="s">&#39;base_model_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
                <span class="n">xarch</span><span class="p">,</span> <span class="n">xfields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;object&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">__view_look_dom_arch</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">new_xml</span><span class="p">,</span> <span class="n">view_id</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
                <span class="n">views</span><span class="p">[</span><span class="s">&#39;form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&#39;arch&#39;</span><span class="p">:</span> <span class="n">xarch</span><span class="p">,</span>
                    <span class="s">&#39;fields&#39;</span><span class="p">:</span> <span class="n">xfields</span>
                <span class="p">}</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;views&#39;</span><span class="p">:</span> <span class="n">views</span><span class="p">}</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="n">xfields</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">):</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                        <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)][</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">column</span> <span class="o">=</span> <span class="bp">False</span>

                <span class="k">if</span> <span class="n">column</span><span class="p">:</span>
                    <span class="n">relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">_obj</span><span class="p">)</span>

                    <span class="n">children</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">views</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;form&#39;</span><span class="p">,</span> <span class="s">&#39;tree&#39;</span><span class="p">,</span> <span class="s">&#39;graph&#39;</span><span class="p">,</span> <span class="s">&#39;kanban&#39;</span><span class="p">):</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                            <span class="n">ctx</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">ctx</span><span class="p">[</span><span class="s">&#39;base_model_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
                            <span class="n">xarch</span><span class="p">,</span> <span class="n">xfields</span> <span class="o">=</span> <span class="n">relation</span><span class="o">.</span><span class="n">__view_look_dom_arch</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">view_id</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
                            <span class="n">views</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tag</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s">&#39;arch&#39;</span><span class="p">:</span> <span class="n">xarch</span><span class="p">,</span>
                                <span class="s">&#39;fields&#39;</span><span class="p">:</span> <span class="n">xfields</span>
                            <span class="p">}</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;views&#39;</span><span class="p">:</span> <span class="n">views</span><span class="p">}</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;widget&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;widget&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;selection&#39;</span><span class="p">:</span>
                        <span class="c"># Prepare the cached selection list for the client. This needs to be</span>
                        <span class="c"># done even when the field is invisible to the current user, because</span>
                        <span class="c"># other events could need to change its value to any of the selectable ones</span>
                        <span class="c"># (such as on_change events, refreshes, etc.)</span>

                        <span class="c"># If domain and context are strings, we keep them for client-side, otherwise</span>
                        <span class="c"># we evaluate them server-side to consider them when generating the list of</span>
                        <span class="c"># possible values</span>
                        <span class="c"># TODO: find a way to remove this hack, by allow dynamic domains</span>
                        <span class="n">dom</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">_domain</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">_domain</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                            <span class="n">dom</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">_domain</span><span class="p">)</span>
                        <span class="n">dom</span> <span class="o">+=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;domain&#39;</span><span class="p">,</span> <span class="s">&#39;[]&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s">&#39;uid&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>
                        <span class="n">search_context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">_context</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">_context</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                            <span class="n">search_context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">_context</span><span class="p">)</span>
                        <span class="n">attrs</span><span class="p">[</span><span class="s">&#39;selection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relation</span><span class="o">.</span><span class="n">_name_search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">dom</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">search_context</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name_get_uid</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;required&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;required&#39;</span><span class="p">)))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">column</span><span class="o">.</span><span class="n">required</span><span class="p">:</span>
                            <span class="n">attrs</span><span class="p">[</span><span class="s">&#39;selection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">False</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
                <span class="n">fields</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">attrs</span>

                <span class="n">field</span> <span class="o">=</span> <span class="n">model_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
                    <span class="n">transfer_field_to_modifiers</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">)</span>


        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;form&#39;</span><span class="p">,</span> <span class="s">&#39;tree&#39;</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_header_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;string&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">in_tree_view</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;tree&#39;</span>

        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;calendar&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">additional_field</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;date_start&#39;</span><span class="p">,</span> <span class="s">&#39;date_delay&#39;</span><span class="p">,</span> <span class="s">&#39;date_stop&#39;</span><span class="p">,</span> <span class="s">&#39;color&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">additional_field</span><span class="p">):</span>
                    <span class="n">fields</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">additional_field</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_group</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="c"># node must be removed, no need to proceed further with its children</span>
            <span class="k">return</span> <span class="n">fields</span>

        <span class="c"># The view architeture overrides the python model.</span>
        <span class="c"># Get the attrs before they are (possibly) deleted by check_group below</span>
        <span class="n">transfer_node_to_modifiers</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">in_tree_view</span><span class="p">)</span>

        <span class="c"># TODO remove attrs couterpart in modifiers when invisible is true ?</span>

        <span class="c"># translate view</span>
        <span class="k">if</span> <span class="s">&#39;lang&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.translation&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_get_source</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s">&#39;view&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;lang&#39;</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">trans</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">trans</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tail</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.translation&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_get_source</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s">&#39;view&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;lang&#39;</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">trans</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span>  <span class="n">node</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">trans</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;string&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.translation&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_get_source</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s">&#39;view&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;lang&#39;</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;string&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">trans</span> <span class="o">==</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;string&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;base_model_name&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">):</span>
                    <span class="c"># If translation is same as source, perhaps we&#39;d have more luck with the alternative model name</span>
                    <span class="c"># (in case we are in a mixed situation, such as an inherited view where parent_view.model != model</span>
                    <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.translation&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_get_source</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;base_model_name&#39;</span><span class="p">],</span> <span class="s">&#39;view&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;lang&#39;</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;string&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">trans</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;string&#39;</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;confirm&#39;</span><span class="p">,</span> <span class="s">&#39;sum&#39;</span><span class="p">,</span> <span class="s">&#39;avg&#39;</span><span class="p">,</span> <span class="s">&#39;help&#39;</span><span class="p">,</span> <span class="s">&#39;placeholder&#39;</span><span class="p">):</span>
                <span class="n">attr_value</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">attr_value</span><span class="p">:</span>
                    <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.translation&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_get_source</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s">&#39;view&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;lang&#39;</span><span class="p">],</span> <span class="n">attr_value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">trans</span><span class="p">:</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">children</span> <span class="ow">or</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;field&#39;</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;filter&#39;</span><span class="p">,</span><span class="s">&#39;separator&#39;</span><span class="p">)):</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__view_look_dom</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">view_id</span><span class="p">,</span> <span class="n">in_tree_view</span><span class="p">,</span> <span class="n">model_fields</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>

        <span class="n">transfer_modifiers_to_node</span><span class="p">(</span><span class="n">modifiers</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fields</span>

    <span class="k">def</span> <span class="nf">_disable_workflow_buttons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the buttons in node to readonly if the user can&#39;t activate them. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># admin user can always activate workflow buttons</span>
            <span class="k">return</span> <span class="n">node</span>

        <span class="c"># TODO handle the case of more than one workflow for a model or multiple</span>
        <span class="c"># transitions with different groups and same signal</span>
        <span class="n">usersobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;res.users&#39;</span><span class="p">)</span>
        <span class="n">buttons</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">getiterator</span><span class="p">(</span><span class="s">&#39;button&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;object&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">button</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
            <span class="n">user_groups</span> <span class="o">=</span> <span class="n">usersobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="p">[</span><span class="n">user</span><span class="p">],</span> <span class="p">[</span><span class="s">&#39;groups_id&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;groups_id&#39;</span><span class="p">]</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT DISTINCT t.group_id</span>
<span class="s">                        FROM wkf</span>
<span class="s">                  INNER JOIN wkf_activity a ON a.wkf_id = wkf.id</span>
<span class="s">                  INNER JOIN wkf_transition t ON (t.act_to = a.id)</span>
<span class="s">                       WHERE wkf.osv = </span><span class="si">%s</span><span class="s"></span>
<span class="s">                         AND t.signal = </span><span class="si">%s</span><span class="s"></span>
<span class="s">                         AND t.group_id is NOT NULL</span>
<span class="s">                   &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)))</span>
            <span class="n">group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">can_click</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">group_ids</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">user_groups</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">group_ids</span><span class="p">))</span>
            <span class="n">button</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;readonly&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="n">can_click</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">__view_look_dom_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">view_id</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return an architecture and a description of all the fields.</span>

<span class="sd">        The field description combines the result of fields_get() and</span>
<span class="sd">        __view_look_dom().</span>

<span class="sd">        :param node: the architecture as as an etree</span>
<span class="sd">        :return: a tuple (arch, fields) where arch is the given node as a</span>
<span class="sd">            string and fields is the description of all the fields.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;diagram&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">getchildren</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;node&#39;</span><span class="p">:</span>
                <span class="n">node_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">getchildren</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;object&#39;</span><span class="p">))</span>
                <span class="n">node_fields</span> <span class="o">=</span> <span class="n">node_model</span><span class="o">.</span><span class="n">fields_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node_fields</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;create&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node_model</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;create&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;create&quot;</span><span class="p">,</span> <span class="s">&#39;false&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">getchildren</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;arrow&#39;</span><span class="p">:</span>
                <span class="n">arrow_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">getchildren</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;object&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">fields_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arrow_fields</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">fields_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__view_look_dom</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">view_id</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disable_workflow_buttons</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;kanban&#39;</span><span class="p">,</span> <span class="s">&#39;tree&#39;</span><span class="p">,</span> <span class="s">&#39;form&#39;</span><span class="p">,</span> <span class="s">&#39;gantt&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">((</span><span class="s">&#39;create&#39;</span><span class="p">,</span> <span class="s">&#39;create&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;delete&#39;</span><span class="p">,</span> <span class="s">&#39;unlink&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;edit&#39;</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="s">&#39;false&#39;</span><span class="p">)</span>
        <span class="n">arch</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields_def</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_def</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s">&#39;id&#39;</span><span class="p">:</span>
                <span class="c"># sometime, the view may contain the (invisible) field &#39;id&#39; needed for a domain (when 2 objects have cross references)</span>
                <span class="n">fields</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;readonly&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="s">&#39;integer&#39;</span><span class="p">,</span> <span class="s">&#39;string&#39;</span><span class="p">:</span> <span class="s">&#39;ID&#39;</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fields_def</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;select name, model from ir_ui_view where (id=</span><span class="si">%s</span><span class="s"> or inherit_id=</span><span class="si">%s</span><span class="s">) and arch like </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">view_id</span><span class="p">,</span> <span class="n">view_id</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%%%s%%</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="p">))</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[:]</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">res</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;Can&#39;t find field &#39;</span><span class="si">%s</span><span class="s">&#39; in the following view parts composing the view of object model &#39;</span><span class="si">%s</span><span class="s">&#39;:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span> <span class="bp">None</span><span class="p">))</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> * &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">])</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Either you wrongly customized this view, or some modules bringing those views are not compatible with your current data model&quot;</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="s">&#39;View error&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arch</span><span class="p">,</span> <span class="n">fields</span>

    <span class="k">def</span> <span class="nf">_get_default_form_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates a default single-line form view using all fields</span>
<span class="sd">        of the current model except the m2m and o2m ones.</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param int user: user id</span>
<span class="sd">        :param dict context: connection context</span>
<span class="sd">        :returns: a form view as an lxml document</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&#39;form&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>
        <span class="c"># TODO it seems fields_get can be replaced by _all_columns (no need for translation)</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">descriptor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">descriptor</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;one2many&#39;</span><span class="p">,</span> <span class="s">&#39;many2many&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s">&#39;field&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">descriptor</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;text&#39;</span><span class="p">:</span>
                <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s">&#39;newline&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">view</span>

    <span class="k">def</span> <span class="nf">_get_default_search_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates a single-field search view, based on _rec_name.</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param int user: user id</span>
<span class="sd">        :param dict context: connection context</span>
<span class="sd">        :returns: a tree view as an lxml document</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&#39;search&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>
        <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s">&#39;field&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name_fallback</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">view</span>

    <span class="k">def</span> <span class="nf">_get_default_tree_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates a single-field tree view, based on _rec_name.</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param int user: user id</span>
<span class="sd">        :param dict context: connection context</span>
<span class="sd">        :returns: a tree view as an lxml document</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&#39;tree&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>
        <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s">&#39;field&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name_fallback</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">view</span>

    <span class="k">def</span> <span class="nf">_get_default_calendar_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates a default calendar view by trying to infer</span>
<span class="sd">        calendar fields from a number of pre-set attribute names</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param int user: user id</span>
<span class="sd">        :param dict context: connection context</span>
<span class="sd">        :returns: a calendar view</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">set_first_of</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">in_</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Sets the first value of ``seq`` also found in ``in_`` to</span>
<span class="sd">            the ``to`` attribute of the view being closed over.</span>

<span class="sd">            Returns whether it&#39;s found a suitable value (and set it on</span>
<span class="sd">            the attribute) or not</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">in_</span><span class="p">:</span>
                    <span class="n">view</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">view</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s">&#39;calendar&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>
        <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s">&#39;field&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_name_fallback</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_date_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
            <span class="n">date_found</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">,</span> <span class="s">&#39;date_start&#39;</span><span class="p">,</span> <span class="s">&#39;x_date&#39;</span><span class="p">,</span> <span class="s">&#39;x_date_start&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_date_name</span> <span class="o">=</span> <span class="n">dt</span>
                    <span class="n">date_found</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">date_found</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Invalid Object Architecture!&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Insufficient fields for Calendar View!&quot;</span><span class="p">))</span>
        <span class="n">view</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;date_start&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_date_name</span><span class="p">)</span>

        <span class="n">set_first_of</span><span class="p">([</span><span class="s">&quot;user_id&quot;</span><span class="p">,</span> <span class="s">&quot;partner_id&quot;</span><span class="p">,</span> <span class="s">&quot;x_user_id&quot;</span><span class="p">,</span> <span class="s">&quot;x_partner_id&quot;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">,</span> <span class="s">&#39;color&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_first_of</span><span class="p">([</span><span class="s">&quot;date_stop&quot;</span><span class="p">,</span> <span class="s">&quot;date_end&quot;</span><span class="p">,</span> <span class="s">&quot;x_date_stop&quot;</span><span class="p">,</span> <span class="s">&quot;x_date_end&quot;</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">,</span> <span class="s">&#39;date_stop&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">set_first_of</span><span class="p">([</span><span class="s">&quot;date_delay&quot;</span><span class="p">,</span> <span class="s">&quot;planned_hours&quot;</span><span class="p">,</span> <span class="s">&quot;x_date_delay&quot;</span><span class="p">,</span> <span class="s">&quot;x_planned_hours&quot;</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">,</span> <span class="s">&#39;date_delay&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s">&#39;Invalid Object Architecture!&#39;</span><span class="p">),</span>
                    <span class="n">_</span><span class="p">(</span><span class="s">&quot;Insufficient fields to generate a Calendar View for </span><span class="si">%s</span><span class="s">, missing a date_stop or a date_delay&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">view</span>

    <span class="c">#</span>
    <span class="c"># if view_id, view_type is not required</span>
    <span class="c">#</span>
<div class="viewcode-block" id="BaseModel.fields_view_get"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.fields_view_get">[docs]</a>    <span class="k">def</span> <span class="nf">fields_view_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s">&#39;form&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">toolbar</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">submenu</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the detailed composition of the requested view like fields, model, view architecture</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param user: current user id</span>
<span class="sd">        :param view_id: id of the view or None</span>
<span class="sd">        :param view_type: type of the view to return if view_id is None (&#39;form&#39;, tree&#39;, ...)</span>
<span class="sd">        :param context: context arguments, like lang, time zone</span>
<span class="sd">        :param toolbar: true to include contextual actions</span>
<span class="sd">        :param submenu: deprecated</span>
<span class="sd">        :return: dictionary describing the composition of the requested view (including inherited views and extensions)</span>
<span class="sd">        :raise AttributeError:</span>
<span class="sd">                            * if the inherited view has unknown position to work with other than &#39;before&#39;, &#39;after&#39;, &#39;inside&#39;, &#39;replace&#39;</span>
<span class="sd">                            * if some tag other than &#39;position&#39; is found in parent view</span>
<span class="sd">        :raise Invalid ArchitectureError: if there is view type other than form, tree, calendar, search etc defined on the structure</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">s</span>

        <span class="k">def</span> <span class="nf">raise_view_error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">child_view_id</span><span class="p">):</span>
            <span class="n">view</span><span class="p">,</span> <span class="n">child_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.ui.view&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="p">[</span><span class="n">view_id</span><span class="p">,</span> <span class="n">child_view_id</span><span class="p">],</span> <span class="n">context</span><span class="p">)</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="n">error_msg</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;parent_xml_id&#39;</span><span class="p">:</span> <span class="n">view</span><span class="o">.</span><span class="n">xml_id</span><span class="p">}</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&quot;View definition error for inherited view &#39;</span><span class="si">%s</span><span class="s">&#39; on model &#39;</span><span class="si">%s</span><span class="s">&#39;: </span><span class="si">%s</span><span class="s">&quot;</span>
                                 <span class="o">%</span>  <span class="p">(</span><span class="n">child_view</span><span class="o">.</span><span class="n">xml_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">locate</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Locate a node in a source (parent) architecture.</span>

<span class="sd">            Given a complete source (parent) architecture (i.e. the field</span>
<span class="sd">            `arch` in a view), and a &#39;spec&#39; node (a node in an inheriting</span>
<span class="sd">            view that specifies the location in the source view of what</span>
<span class="sd">            should be changed), return (if it exists) the node in the</span>
<span class="sd">            source view matching the specification.</span>

<span class="sd">            :param source: a parent architecture to modify</span>
<span class="sd">            :param spec: a modifying node in an inheriting view</span>
<span class="sd">            :return: a node in the source matching the spec</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;xpath&#39;</span><span class="p">:</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;expr&#39;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">nodes</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;field&#39;</span><span class="p">:</span>
                <span class="c"># Only compare the field name: a field can be only once in a given view</span>
                <span class="c"># at a given level (and for multilevel expressions, we should use xpath</span>
                <span class="c"># inheritance spec anyway).</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">getiterator</span><span class="p">(</span><span class="s">&#39;field&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">node</span>
                <span class="k">return</span> <span class="bp">None</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">getiterator</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">tag</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">SKIPPED_ELEMENT_TYPES</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> \
                        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">attrib</span>
                            <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;position&#39;</span><span class="p">,</span><span class="s">&#39;version&#39;</span><span class="p">)):</span>
                    <span class="c"># Version spec should match parent&#39;s root element&#39;s version</span>
                    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">):</span>
                        <span class="k">return</span> <span class="bp">None</span>
                    <span class="k">return</span> <span class="n">node</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">def</span> <span class="nf">apply_inheritance_specs</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">specs_arch</span><span class="p">,</span> <span class="n">inherit_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Apply an inheriting view.</span>

<span class="sd">            Apply to a source architecture all the spec nodes (i.e. nodes</span>
<span class="sd">            describing where and what changes to apply to some parent</span>
<span class="sd">            architecture) given by an inheriting view.</span>

<span class="sd">            :param source: a parent architecture to modify</span>
<span class="sd">            :param specs_arch: a modifying architecture in an inheriting view</span>
<span class="sd">            :param inherit_id: the database id of the inheriting view</span>
<span class="sd">            :return: a modified source where the specs are applied</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">specs_tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">encode</span><span class="p">(</span><span class="n">specs_arch</span><span class="p">))</span>
            <span class="c"># Queue of specification nodes (i.e. nodes describing where and</span>
            <span class="c"># changes to apply to some parent architecture).</span>
            <span class="n">specs</span> <span class="o">=</span> <span class="p">[</span><span class="n">specs_tree</span><span class="p">]</span>

            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">SKIPPED_ELEMENT_TYPES</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;data&#39;</span><span class="p">:</span>
                    <span class="n">specs</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">specs_tree</span> <span class="p">]</span>
                    <span class="k">continue</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">locate</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;position&#39;</span><span class="p">,</span> <span class="s">&#39;inside&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="s">&#39;replace&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">source</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
                                <span class="n">node</span><span class="o">.</span><span class="n">addprevious</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">pos</span> <span class="o">==</span> <span class="s">&#39;attributes&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">getiterator</span><span class="p">(</span><span class="s">&#39;attribute&#39;</span><span class="p">):</span>
                            <span class="n">attribute</span> <span class="o">=</span> <span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span> <span class="n">child</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">attribute</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">attribute</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">attribute</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">del</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">attribute</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sib</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getnext</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="s">&#39;inside&#39;</span><span class="p">:</span>
                                <span class="n">node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">pos</span> <span class="o">==</span> <span class="s">&#39;after&#39;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">sib</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                    <span class="n">node</span><span class="o">.</span><span class="n">addnext</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                                    <span class="n">node</span> <span class="o">=</span> <span class="n">child</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">sib</span><span class="o">.</span><span class="n">addprevious</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">pos</span> <span class="o">==</span> <span class="s">&#39;before&#39;</span><span class="p">:</span>
                                <span class="n">node</span><span class="o">.</span><span class="n">addprevious</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">raise_view_error</span><span class="p">(</span><span class="s">&quot;Invalid position value: &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">pos</span><span class="p">,</span> <span class="n">inherit_id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                        <span class="s">&#39; </span><span class="si">%s</span><span class="s">=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">attrib</span>
                        <span class="k">if</span> <span class="n">attr</span> <span class="o">!=</span> <span class="s">&#39;position&#39;</span>
                    <span class="p">])</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;&lt;</span><span class="si">%s%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">):</span>
                        <span class="n">raise_view_error</span><span class="p">(</span><span class="s">&quot;Mismatching view API version for element &#39;</span><span class="si">%s</span><span class="s">&#39;: </span><span class="si">%r</span><span class="s"> vs </span><span class="si">%r</span><span class="s"> in parent view &#39;</span><span class="si">%%</span><span class="s">(parent_xml_id)s&#39;&quot;</span> <span class="o">%</span> \
                                            <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">),</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">)),</span> <span class="n">inherit_id</span><span class="p">)</span>
                    <span class="n">raise_view_error</span><span class="p">(</span><span class="s">&quot;Element &#39;</span><span class="si">%s</span><span class="s">&#39; not found in parent view &#39;</span><span class="si">%%</span><span class="s">(parent_xml_id)s&#39;&quot;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">,</span> <span class="n">inherit_id</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">source</span>

        <span class="k">def</span> <span class="nf">apply_view_inheritance</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">inherit_id</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Apply all the (directly and indirectly) inheriting views.</span>

<span class="sd">            :param source: a parent architecture to modify (with parent</span>
<span class="sd">                modifications already applied)</span>
<span class="sd">            :param inherit_id: the database view_id of the parent view</span>
<span class="sd">            :return: a modified source where all the modifying architecture</span>
<span class="sd">                are applied</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">sql_inherit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.ui.view&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_inheriting_views_arch</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">inherit_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">view_arch</span><span class="p">,</span> <span class="n">view_id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sql_inherit</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">apply_inheritance_specs</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">view_arch</span><span class="p">,</span> <span class="n">view_id</span><span class="p">)</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">apply_view_inheritance</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">view_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">source</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="n">view_type</span><span class="p">,</span> <span class="s">&#39;model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">}</span>

        <span class="n">sql_res</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">parent_view_model</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">view_ref</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">view_type</span> <span class="o">+</span> <span class="s">&#39;_view_ref&#39;</span><span class="p">)</span>
        <span class="c"># Search for a root (i.e. without any parent) view.</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">view_ref</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">view_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">view_ref</span><span class="p">:</span>
                    <span class="n">module</span><span class="p">,</span> <span class="n">view_ref</span> <span class="o">=</span> <span class="n">view_ref</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT res_id FROM ir_model_data WHERE model=&#39;ir.ui.view&#39; AND module=</span><span class="si">%s</span><span class="s"> AND name=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">view_ref</span><span class="p">))</span>
                    <span class="n">view_ref_res</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">view_ref_res</span><span class="p">:</span>
                        <span class="n">view_id</span> <span class="o">=</span> <span class="n">view_ref_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">view_id</span><span class="p">:</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT arch,name,field_parent,id,type,inherit_id,model</span>
<span class="s">                              FROM ir_ui_view</span>
<span class="s">                              WHERE id=</span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">view_id</span><span class="p">,))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT arch,name,field_parent,id,type,inherit_id,model</span>
<span class="s">                              FROM ir_ui_view</span>
<span class="s">                              WHERE model=</span><span class="si">%s</span><span class="s"> AND type=</span><span class="si">%s</span><span class="s"> AND inherit_id IS NULL</span>
<span class="s">                              ORDER BY priority&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">view_type</span><span class="p">))</span>
            <span class="n">sql_res</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchone</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">sql_res</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">view_id</span> <span class="o">=</span> <span class="n">sql_res</span><span class="p">[</span><span class="s">&#39;inherit_id&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">sql_res</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">parent_view_model</span> <span class="o">=</span> <span class="n">sql_res</span><span class="p">[</span><span class="s">&#39;model&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sql_res</span><span class="p">[</span><span class="s">&#39;inherit_id&#39;</span><span class="p">]:</span>
                <span class="k">break</span>

        <span class="c"># if a view was found</span>
        <span class="k">if</span> <span class="n">sql_res</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">encode</span><span class="p">(</span><span class="n">sql_res</span><span class="p">[</span><span class="s">&#39;arch&#39;</span><span class="p">]))</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">arch</span><span class="o">=</span><span class="n">apply_view_inheritance</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">sql_res</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]),</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">sql_res</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">],</span>
                <span class="n">view_id</span><span class="o">=</span><span class="n">sql_res</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span>
                <span class="n">name</span><span class="o">=</span><span class="n">sql_res</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
                <span class="n">field_parent</span><span class="o">=</span><span class="n">sql_res</span><span class="p">[</span><span class="s">&#39;field_parent&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># otherwise, build some kind of default view</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">view</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_get_default_</span><span class="si">%s</span><span class="s">_view&#39;</span> <span class="o">%</span> <span class="n">view_type</span><span class="p">)(</span>
                    <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c"># what happens here, graph case?</span>
                <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Invalid Architecture!&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;There is no view of type &#39;</span><span class="si">%s</span><span class="s">&#39; defined for the structure!&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">view_type</span><span class="p">)</span>

            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">arch</span><span class="o">=</span><span class="n">view</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">,</span>
                <span class="n">field_parent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">view_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">parent_view_model</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ctx</span><span class="p">[</span><span class="s">&#39;base_model_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_view_model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">context</span>
        <span class="n">xarch</span><span class="p">,</span> <span class="n">xfields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__view_look_dom_arch</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;arch&#39;</span><span class="p">],</span> <span class="n">view_id</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;arch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xarch</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfields</span>

        <span class="k">if</span> <span class="n">toolbar</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;report_sxw_content&#39;</span><span class="p">,</span> <span class="s">&#39;report_rml_content&#39;</span><span class="p">,</span>
                        <span class="s">&#39;report_sxw&#39;</span><span class="p">,</span> <span class="s">&#39;report_rml&#39;</span><span class="p">,</span>
                        <span class="s">&#39;report_sxw_content_data&#39;</span><span class="p">,</span> <span class="s">&#39;report_rml_content_data&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">x</span>
            <span class="n">ir_values_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.values&#39;</span><span class="p">)</span>
            <span class="n">resprint</span> <span class="o">=</span> <span class="n">ir_values_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;action&#39;</span><span class="p">,</span>
                    <span class="s">&#39;client_print_multi&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">False</span><span class="p">)],</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="n">context</span><span class="p">)</span>
            <span class="n">resaction</span> <span class="o">=</span> <span class="n">ir_values_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;action&#39;</span><span class="p">,</span>
                    <span class="s">&#39;client_action_multi&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">False</span><span class="p">)],</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="n">context</span><span class="p">)</span>

            <span class="n">resrelate</span> <span class="o">=</span> <span class="n">ir_values_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;action&#39;</span><span class="p">,</span>
                    <span class="s">&#39;client_action_relate&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">False</span><span class="p">)],</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="n">context</span><span class="p">)</span>
            <span class="n">resaction</span> <span class="o">=</span> <span class="p">[</span><span class="n">clean</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">resaction</span>
                         <span class="k">if</span> <span class="n">view_type</span> <span class="o">==</span> <span class="s">&#39;tree&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">action</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;multi&#39;</span><span class="p">)]</span>
            <span class="n">resprint</span> <span class="o">=</span> <span class="p">[</span><span class="n">clean</span><span class="p">(</span><span class="n">print_</span><span class="p">)</span> <span class="k">for</span> <span class="n">print_</span> <span class="ow">in</span> <span class="n">resprint</span>
                        <span class="k">if</span> <span class="n">view_type</span> <span class="o">==</span> <span class="s">&#39;tree&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">print_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;multi&#39;</span><span class="p">)]</span>
            <span class="c">#When multi=&quot;True&quot; set it will display only in More of the list view </span>
            <span class="n">resrelate</span> <span class="o">=</span> <span class="p">[</span><span class="n">clean</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">resrelate</span>
                         <span class="k">if</span> <span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;multi&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">view_type</span> <span class="o">==</span> <span class="s">&#39;tree&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">action</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;multi&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">view_type</span> <span class="o">==</span> <span class="s">&#39;form&#39;</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">resprint</span><span class="p">,</span> <span class="n">resaction</span><span class="p">,</span> <span class="n">resrelate</span><span class="p">):</span>
                <span class="n">x</span><span class="p">[</span><span class="s">&#39;string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>

            <span class="n">result</span><span class="p">[</span><span class="s">&#39;toolbar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;print&#39;</span><span class="p">:</span> <span class="n">resprint</span><span class="p">,</span>
                <span class="s">&#39;action&#39;</span><span class="p">:</span> <span class="n">resaction</span><span class="p">,</span>
                <span class="s">&#39;relate&#39;</span><span class="p">:</span> <span class="n">resrelate</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
    <span class="n">_view_look_dom_arch</span> <span class="o">=</span> <span class="n">__view_look_dom_arch</span>

<div class="viewcode-block" id="BaseModel.search_count"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.search_count">[docs]</a>    <span class="k">def</span> <span class="nf">search_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
</div>
<div class="viewcode-block" id="BaseModel.search"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.search">[docs]</a>    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search for records based on a search domain.</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param user: current user id</span>
<span class="sd">        :param args: list of tuples specifying the search domain [(&#39;field_name&#39;, &#39;operator&#39;, value), ...]. Pass an empty list to match all records.</span>
<span class="sd">        :param offset: optional number of results to skip in the returned values (default: 0)</span>
<span class="sd">        :param limit: optional max number of records to return (default: **None**)</span>
<span class="sd">        :param order: optional columns to sort by (default: self._order=id )</span>
<span class="sd">        :param context: optional context arguments, like lang, time zone</span>
<span class="sd">        :type context: dictionary</span>
<span class="sd">        :param count: optional (default: **False**), if **True**, returns only the number of records matching the criteria, not their ids</span>
<span class="sd">        :return: id or list of ids of records matching the criteria</span>
<span class="sd">        :rtype: integer or list of integers</span>
<span class="sd">        :raise AccessError: * if user tries to bypass access rules for read on the requested object.</span>

<span class="sd">        **Expressing a search domain (args)**</span>

<span class="sd">        Each tuple in the search domain needs to have 3 elements, in the form: **(&#39;field_name&#39;, &#39;operator&#39;, value)**, where:</span>

<span class="sd">            * **field_name** must be a valid name of field of the object model, possibly following many-to-one relationships using dot-notation, e.g &#39;street&#39; or &#39;partner_id.country&#39; are valid values.</span>
<span class="sd">            * **operator** must be a string with a valid comparison operator from this list: ``=, !=, &gt;, &gt;=, &lt;, &lt;=, like, ilike, in, not in, child_of, parent_left, parent_right``</span>
<span class="sd">              The semantics of most of these operators are obvious.</span>
<span class="sd">              The ``child_of`` operator will look for records who are children or grand-children of a given record,</span>
<span class="sd">              according to the semantics of this model (i.e following the relationship field named by</span>
<span class="sd">              ``self._parent_name``, by default ``parent_id``.</span>
<span class="sd">            * **value** must be a valid value to compare with the values of **field_name**, depending on its type.</span>

<span class="sd">        Domain criteria can be combined using 3 logical operators than can be added between tuples:  &#39;**&amp;**&#39; (logical AND, default), &#39;**|**&#39; (logical OR), &#39;**!**&#39; (logical NOT).</span>
<span class="sd">        These are **prefix** operators and the arity of the &#39;**&amp;**&#39; and &#39;**|**&#39; operator is 2, while the arity of the &#39;**!**&#39; is just 1.</span>
<span class="sd">        Be very careful about this when you combine them the first time.</span>

<span class="sd">        Here is an example of searching for Partners named *ABC* from Belgium and Germany whose language is not english ::</span>

<span class="sd">            [(&#39;name&#39;,&#39;=&#39;,&#39;ABC&#39;),&#39;!&#39;,(&#39;language.code&#39;,&#39;=&#39;,&#39;en_US&#39;),&#39;|&#39;,(&#39;country_id.code&#39;,&#39;=&#39;,&#39;be&#39;),(&#39;country_id.code&#39;,&#39;=&#39;,&#39;de&#39;))</span>

<span class="sd">        The &#39;&amp;&#39; is omitted as it is the default, and of course we could have used &#39;!=&#39; for the language, but what this domain really represents is::</span>

<span class="sd">            (name is &#39;ABC&#39; AND (language is NOT english) AND (country is Belgium OR Germany))</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseModel.name_get"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.name_get">[docs]</a>    <span class="k">def</span> <span class="nf">name_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the preferred display value (text representation) for the records with the</span>
<span class="sd">           given ``ids``. By default this will be the value of the ``name`` column, unless</span>
<span class="sd">           the model implements a custom behavior.</span>
<span class="sd">           Can sometimes be seen as the inverse function of :meth:`~.name_search`, but it is not</span>
<span class="sd">           guaranteed to be.</span>

<span class="sd">           :rtype: list(tuple)</span>
<span class="sd">           :return: list of pairs ``(id,text_repr)`` for all records with the given ``ids``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="p">:</span>
            <span class="n">rec_name_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">]</span><span class="o">.</span><span class="n">column</span>
            <span class="k">return</span> <span class="p">[(</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="n">rec_name_column</span><span class="o">.</span><span class="n">as_display_name</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">],</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">],</span>
                                       <span class="n">load</span><span class="o">=</span><span class="s">&#39;_classic_write&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[(</span><span class="nb">id</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="BaseModel.name_search"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.name_search">[docs]</a>    <span class="k">def</span> <span class="nf">name_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s">&#39;ilike&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Search for records that have a display name matching the given ``name`` pattern if compared</span>
<span class="sd">           with the given ``operator``, while also matching the optional search domain (``args``).</span>
<span class="sd">           This is used for example to provide suggestions based on a partial value for a relational</span>
<span class="sd">           field.</span>
<span class="sd">           Sometimes be seen as the inverse function of :meth:`~.name_get`, but it is not</span>
<span class="sd">           guaranteed to be.</span>

<span class="sd">           This method is equivalent to calling :meth:`~.search` with a search domain based on ``name``</span>
<span class="sd">           and then :meth:`~.name_get` on the result of the search.</span>

<span class="sd">           :param list args: optional search domain (see :meth:`~.search` for syntax),</span>
<span class="sd">                             specifying further restrictions</span>
<span class="sd">           :param str operator: domain operator for matching the ``name`` pattern, such as ``&#39;like&#39;``</span>
<span class="sd">                                or ``&#39;=&#39;``.</span>
<span class="sd">           :param int limit: optional max number of records to return</span>
<span class="sd">           :rtype: list</span>
<span class="sd">           :return: list of pairs ``(id,text_repr)`` for all matching records.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseModel.name_create"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.name_create">[docs]</a>    <span class="k">def</span> <span class="nf">name_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a new record by calling :meth:`~.create` with only one</span>
<span class="sd">           value provided: the name of the new record (``_rec_name`` field).</span>
<span class="sd">           The new record will also be initialized with any default values applicable</span>
<span class="sd">           to this model, or provided through the context. The usual behavior of</span>
<span class="sd">           :meth:`~.create` applies.</span>
<span class="sd">           Similarly, this method may raise an exception if the model has multiple</span>
<span class="sd">           required fields and some do not have default values.</span>

<span class="sd">           :param name: name of the record to create</span>

<span class="sd">           :rtype: tuple</span>
<span class="sd">           :return: the :meth:`~.name_get` pair value for the newly-created record.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rec_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">[</span><span class="n">rec_id</span><span class="p">],</span> <span class="n">context</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c"># private implementation of name_search, allows passing a dedicated user for the name_get part to</span>
    <span class="c"># solve some access rights issues</span></div>
    <span class="k">def</span> <span class="nf">_name_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s">&#39;ilike&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">name_get_uid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:]</span>
        <span class="c"># optimize out the default criterion of ``ilike &#39;&#39;`` that matches everything</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;&#39;</span> <span class="ow">and</span> <span class="n">operator</span> <span class="o">==</span> <span class="s">&#39;ilike&#39;</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">name</span><span class="p">)]</span>
        <span class="n">access_rights_uid</span> <span class="o">=</span> <span class="n">name_get_uid</span> <span class="ow">or</span> <span class="n">user</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">access_rights_uid</span><span class="o">=</span><span class="n">access_rights_uid</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">access_rights_uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="BaseModel.read_string"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.read_string">[docs]</a>    <span class="k">def</span> <span class="nf">read_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">langs</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">res2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.translation&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="c">#FIXME: collect all calls to _get_source into one SQL call.</span>
        <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">langs</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;code&#39;</span><span class="p">:</span> <span class="n">lang</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                    <span class="n">res_trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.translation&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_get_source</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;field&#39;</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">res_trans</span><span class="p">:</span>
                        <span class="n">res</span><span class="p">[</span><span class="n">lang</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_trans</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">res</span><span class="p">[</span><span class="n">lang</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">string</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">intersect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">fields</span><span class="p">)</span>
            <span class="n">res2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">read_string</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">langs</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">res2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">lang</span><span class="p">][</span><span class="s">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lang</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">res2</span><span class="p">[</span><span class="n">lang</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">lang</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">res2</span><span class="p">[</span><span class="n">lang</span><span class="p">][</span><span class="n">f</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span>
</div>
<div class="viewcode-block" id="BaseModel.write_string"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.write_string">[docs]</a>    <span class="k">def</span> <span class="nf">write_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">langs</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.translation&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">)</span>
        <span class="c">#FIXME: try to only call the translation in one SQL</span>
        <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">langs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">string</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.translation&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_set_ids</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="n">field</span><span class="p">,</span> <span class="s">&#39;field&#39;</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">src</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">intersect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">vals</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cols</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">write_string</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">langs</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
    <span class="k">def</span> <span class="nf">_add_missing_default_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">missing_defaults</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">avoid_tables</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># avoid overriding inherited values when parent is set</span>
        <span class="k">for</span> <span class="n">tables</span><span class="p">,</span> <span class="n">parent_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">parent_field</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">avoid_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">missing_defaults</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">avoid_tables</span><span class="p">):</span>
                <span class="n">missing_defaults</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_defaults</span><span class="p">):</span>
            <span class="c"># override defaults with the provided values, never allow the other way around</span>
            <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">missing_defaults</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">dv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">dv</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2many&#39;</span><span class="p">)</span> \
                     <span class="ow">or</span> <span class="p">(</span><span class="n">dv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">dv</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2many&#39;</span><span class="p">))</span> \
                        <span class="ow">and</span> <span class="n">defaults</span><span class="p">[</span><span class="n">dv</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="n">dv</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
                    <span class="n">defaults</span><span class="p">[</span><span class="n">dv</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">defaults</span><span class="p">[</span><span class="n">dv</span><span class="p">])]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">dv</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;one2many&#39;</span> \
                    <span class="ow">or</span> <span class="p">(</span><span class="n">dv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">dv</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;one2many&#39;</span><span class="p">))</span> \
                        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="n">dv</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="n">defaults</span><span class="p">[</span><span class="n">dv</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="n">dv</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">defaults</span><span class="p">[</span><span class="n">dv</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">[</span><span class="n">dv</span><span class="p">]]</span>
            <span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">defaults</span>
        <span class="k">return</span> <span class="n">values</span>

<div class="viewcode-block" id="BaseModel.clear_caches"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.clear_caches">[docs]</a>    <span class="k">def</span> <span class="nf">clear_caches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clear the caches</span>

<span class="sd">        This clears the caches associated to methods decorated with</span>
<span class="sd">        ``tools.ormcache`` or ``tools.ormcache_multi``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_ormcache&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ormcache</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_any_cache_cleared</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

</div>
    <span class="k">def</span> <span class="nf">_read_group_fill_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">groupby_list</span><span class="p">,</span> <span class="n">aggregated_fields</span><span class="p">,</span>
                                 <span class="n">read_group_result</span><span class="p">,</span> <span class="n">read_group_order</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method for filling in empty groups for all possible values of</span>
<span class="sd">           the field being grouped by&quot;&quot;&quot;</span>

        <span class="c"># self._group_by_full should map groupable fields to a method that returns</span>
        <span class="c"># a list of all aggregated values that we want to display for this field,</span>
        <span class="c"># in the form of a m2o-like pair (key,label).</span>
        <span class="c"># This is useful to implement kanban views for instance, where all columns</span>
        <span class="c"># should be displayed even if they don&#39;t contain any record.</span>

        <span class="c"># Grab the list of all groups that should be displayed, including all present groups</span>
        <span class="n">present_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">groupby</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">read_group_result</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">groupby</span><span class="p">]]</span>
        <span class="n">all_groups</span><span class="p">,</span><span class="n">folded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_by_full</span><span class="p">[</span><span class="n">groupby</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">present_group_ids</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span>
                                                  <span class="n">read_group_order</span><span class="o">=</span><span class="n">read_group_order</span><span class="p">,</span>
                                                  <span class="n">access_rights_uid</span><span class="o">=</span><span class="n">openerp</span><span class="o">.</span><span class="n">SUPERUSER_ID</span><span class="p">,</span>
                                                  <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

        <span class="n">result_template</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">aggregated_fields</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">result_template</span><span class="p">[</span><span class="n">groupby</span> <span class="o">+</span> <span class="s">&#39;_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">groupby_list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">groupby_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">result_template</span><span class="p">[</span><span class="s">&#39;__context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;group_by&#39;</span><span class="p">:</span> <span class="n">groupby_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]}</span>

        <span class="c"># Merge the left_side (current results as dicts) with the right_side (all</span>
        <span class="c"># possible values as m2o pairs). Both lists are supposed to be using the</span>
        <span class="c"># same ordering, and can be merged in one pass.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">known_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">def</span> <span class="nf">append_left</span><span class="p">(</span><span class="n">left_side</span><span class="p">):</span>
            <span class="n">grouped_value</span> <span class="o">=</span> <span class="n">left_side</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="ow">and</span> <span class="n">left_side</span><span class="p">[</span><span class="n">groupby</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">grouped_value</span> <span class="ow">in</span> <span class="n">known_values</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">left_side</span><span class="p">)</span>
                <span class="n">known_values</span><span class="p">[</span><span class="n">grouped_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">left_side</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">count_attr</span> <span class="o">=</span> <span class="n">groupby</span> <span class="o">+</span> <span class="s">&#39;_count&#39;</span>
                <span class="n">known_values</span><span class="p">[</span><span class="n">grouped_value</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">count_attr</span><span class="p">:</span> <span class="n">left_side</span><span class="p">[</span><span class="n">count_attr</span><span class="p">]})</span>
        <span class="k">def</span> <span class="nf">append_right</span><span class="p">(</span><span class="n">right_side</span><span class="p">):</span>
            <span class="n">grouped_value</span> <span class="o">=</span> <span class="n">right_side</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">grouped_value</span> <span class="ow">in</span> <span class="n">known_values</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">result_template</span><span class="p">)</span>
                <span class="n">line</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="o">=</span> <span class="n">right_side</span>
                <span class="n">line</span><span class="p">[</span><span class="s">&#39;__domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">groupby</span><span class="p">,</span><span class="s">&#39;=&#39;</span><span class="p">,</span><span class="n">grouped_value</span><span class="p">)]</span> <span class="o">+</span> <span class="n">domain</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">known_values</span><span class="p">[</span><span class="n">grouped_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
        <span class="k">while</span> <span class="n">read_group_result</span> <span class="ow">or</span> <span class="n">all_groups</span><span class="p">:</span>
            <span class="n">left_side</span> <span class="o">=</span> <span class="n">read_group_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">read_group_result</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="n">right_side</span> <span class="o">=</span> <span class="n">all_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">all_groups</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="k">assert</span> <span class="n">left_side</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">left_side</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span> \
                 <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">left_side</span><span class="p">[</span><span class="n">groupby</span><span class="p">],</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)),</span> \
                <span class="s">&#39;M2O-like pair expected, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">left_side</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">right_side</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">right_side</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)),</span> \
                <span class="s">&#39;M2O-like pair expected, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">right_side</span>
            <span class="k">if</span> <span class="n">left_side</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">append_right</span><span class="p">(</span><span class="n">all_groups</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">right_side</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">append_left</span><span class="p">(</span><span class="n">read_group_result</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">left_side</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="o">==</span> <span class="n">right_side</span><span class="p">:</span>
                <span class="n">append_left</span><span class="p">(</span><span class="n">read_group_result</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">all_groups</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c"># discard right_side</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">left_side</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">left_side</span><span class="p">[</span><span class="n">groupby</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c"># left side == &quot;Undefined&quot; entry, not present on right_side</span>
                <span class="n">append_left</span><span class="p">(</span><span class="n">read_group_result</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">append_right</span><span class="p">(</span><span class="n">all_groups</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">folded</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">r</span><span class="p">[</span><span class="s">&#39;__fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="n">groupby</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_read_group_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orderby</span><span class="p">,</span> <span class="n">aggregated_fields</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">qualified_groupby_field</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">groupby_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the GROUP BY and ORDER BY terms for the read_group method. Adds the missing JOIN clause</span>
<span class="sd">        to the query if order should be computed against m2o field. </span>
<span class="sd">        :param orderby: the orderby definition in the form &quot;%(field)s %(order)s&quot;</span>
<span class="sd">        :param aggregated_fields: list of aggregated fields in the query</span>
<span class="sd">        :param groupby: the current groupby field name</span>
<span class="sd">        :param qualified_groupby_field: the fully qualified SQL name for the grouped field</span>
<span class="sd">        :param osv.Query query: the query under construction</span>
<span class="sd">        :param groupby_type: the type of the grouped field</span>
<span class="sd">        :return: (groupby_terms, orderby_terms)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">orderby_terms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">groupby_terms</span> <span class="o">=</span> <span class="p">[</span><span class="n">qualified_groupby_field</span><span class="p">]</span> <span class="k">if</span> <span class="n">groupby</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">orderby</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">groupby_terms</span><span class="p">,</span> <span class="n">orderby_terms</span>    

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_qorder</span><span class="p">(</span><span class="n">orderby</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">order_part</span> <span class="ow">in</span> <span class="n">orderby</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">order_split</span> <span class="o">=</span> <span class="n">order_part</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">order_field</span> <span class="o">=</span> <span class="n">order_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">order_field</span> <span class="o">==</span> <span class="n">groupby</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">groupby_type</span> <span class="o">==</span> <span class="s">&#39;many2one&#39;</span><span class="p">:</span>
                    <span class="n">order_clause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_order_by</span><span class="p">(</span><span class="n">order_part</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;ORDER BY &#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">order_clause</span><span class="p">:</span>
                        <span class="n">orderby_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order_clause</span><span class="p">)</span>
                        <span class="n">groupby_terms</span> <span class="o">+=</span> <span class="p">[</span><span class="n">order_term</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">order_term</span> <span class="ow">in</span> <span class="n">order_clause</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">orderby_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order_part</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">order_field</span> <span class="ow">in</span> <span class="n">aggregated_fields</span><span class="p">:</span>
                <span class="n">orderby_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order_part</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Cannot order by a field that will not appear in the results (needs to be grouped or aggregated)</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: read_group order by `</span><span class="si">%s</span><span class="s">` ignored, cannot sort on empty columns (not grouped/aggregated)&#39;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">order_part</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">groupby_terms</span><span class="p">,</span> <span class="n">orderby_terms</span>

<div class="viewcode-block" id="BaseModel.read_group"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.read_group">[docs]</a>    <span class="k">def</span> <span class="nf">read_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of records in list view grouped by the given ``groupby`` fields</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param uid: current user id</span>
<span class="sd">        :param domain: list specifying search criteria [[&#39;field_name&#39;, &#39;operator&#39;, &#39;value&#39;], ...]</span>
<span class="sd">        :param list fields: list of fields present in the list view specified on the object</span>
<span class="sd">        :param list groupby: fields by which the records will be grouped</span>
<span class="sd">        :param int offset: optional number of records to skip</span>
<span class="sd">        :param int limit: optional max number of records to return</span>
<span class="sd">        :param dict context: context arguments, like lang, time zone</span>
<span class="sd">        :param list orderby: optional ``order by`` specification, for</span>
<span class="sd">                             overriding the natural sort ordering of the</span>
<span class="sd">                             groups, see also :py:meth:`~osv.osv.osv.search`</span>
<span class="sd">                             (supported only for many2one fields currently)</span>
<span class="sd">        :return: list of dictionaries(one dictionary for each record) containing:</span>

<span class="sd">                    * the values of fields grouped by the fields in ``groupby`` argument</span>
<span class="sd">                    * __domain: list of tuples specifying the search criteria</span>
<span class="sd">                    * __context: dictionary with argument like ``groupby``</span>
<span class="sd">        :rtype: [{&#39;field_name_1&#39;: value, ...]</span>
<span class="sd">        :raise AccessError: * if user has no read rights on the requested object</span>
<span class="sd">                            * if user tries to bypass access rules for read on the requested object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">context</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where_calc</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_ir_rules</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

        <span class="c"># Take care of adding join(s) if groupby is an &#39;_inherits&#39;ed field</span>
        <span class="n">groupby_list</span> <span class="o">=</span> <span class="n">groupby</span>
        <span class="n">qualified_groupby_field</span> <span class="o">=</span> <span class="n">groupby</span>
        <span class="k">if</span> <span class="n">groupby</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">groupby</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">qualified_groupby_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_join_calc</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">groupby</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">groupby</span> <span class="ow">or</span> <span class="n">groupby</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">,</span> <span class="s">&quot;Fields in &#39;groupby&#39; must appear in the list of fields to read (perhaps it&#39;s missing in the list view?)&quot;</span>
            <span class="n">groupby_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">groupby</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">assert</span> <span class="n">groupby_def</span> <span class="ow">and</span> <span class="n">groupby_def</span><span class="o">.</span><span class="n">_classic_write</span><span class="p">,</span> <span class="s">&quot;Fields in &#39;groupby&#39; must be regular database-persisted fields (no function or related fields), or function fields with store=True&quot;</span>

        <span class="c"># TODO it seems fields_get can be replaced by _all_columns (no need for translation)</span>
        <span class="n">fget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
        <span class="n">select_terms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">groupby_type</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">groupby</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fget</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">groupby</span><span class="p">):</span>
                <span class="n">groupby_type</span> <span class="o">=</span> <span class="n">fget</span><span class="p">[</span><span class="n">groupby</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">groupby_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;date&#39;</span><span class="p">,</span> <span class="s">&#39;datetime&#39;</span><span class="p">):</span>
                    <span class="n">qualified_groupby_field</span> <span class="o">=</span> <span class="s">&quot;to_char(</span><span class="si">%s</span><span class="s">,&#39;yyyy-mm&#39;)&quot;</span> <span class="o">%</span> <span class="n">qualified_groupby_field</span>
                <span class="k">elif</span> <span class="n">groupby_type</span> <span class="o">==</span> <span class="s">&#39;boolean&#39;</span><span class="p">:</span>
                    <span class="n">qualified_groupby_field</span> <span class="o">=</span> <span class="s">&quot;coalesce(</span><span class="si">%s</span><span class="s">,false)&quot;</span> <span class="o">%</span> <span class="n">qualified_groupby_field</span>
                <span class="n">select_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> as </span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qualified_groupby_field</span><span class="p">,</span> <span class="n">groupby</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Don&#39;t allow arbitrary values, as this would be a SQL injection vector!</span>
                <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Invalid group_by&#39;</span><span class="p">),</span>
                                 <span class="n">_</span><span class="p">(</span><span class="s">&#39;Invalid group_by specification: &quot;</span><span class="si">%s</span><span class="s">&quot;.</span><span class="se">\n</span><span class="s">A group_by specification must be a list of valid fields.&#39;</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">groupby</span><span class="p">,))</span>

        <span class="n">aggregated_fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;sequence&#39;</span><span class="p">,</span> <span class="n">groupby</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fget</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;integer&#39;</span><span class="p">,</span> <span class="s">&#39;float&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="s">&#39;_classic_write&#39;</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">aggregated_fields</span><span class="p">:</span>
            <span class="n">group_operator</span> <span class="o">=</span> <span class="n">fget</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;group_operator&#39;</span><span class="p">,</span> <span class="s">&#39;sum&#39;</span><span class="p">)</span>
            <span class="n">qualified_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_join_calc</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">select_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">) AS </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">group_operator</span><span class="p">,</span> <span class="n">qualified_field</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>

        <span class="n">order</span> <span class="o">=</span> <span class="n">orderby</span> <span class="ow">or</span> <span class="n">groupby</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">groupby_terms</span><span class="p">,</span> <span class="n">orderby_terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_prepare</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">aggregated_fields</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">qualified_groupby_field</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">groupby_type</span><span class="p">)</span>

        <span class="n">from_clause</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">where_clause_params</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">get_sql</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groupby_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;group_by_no_leaf&#39;</span><span class="p">):</span>
            <span class="n">count_field</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">count_field</span> <span class="o">=</span> <span class="n">groupby</span>

        <span class="n">prefix_terms</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">terms</span><span class="p">:</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">terms</span><span class="p">))</span> <span class="k">if</span> <span class="n">terms</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
        <span class="n">prefix_term</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">term</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">term</span><span class="p">))</span> <span class="k">if</span> <span class="n">term</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">            SELECT min(</span><span class="si">%(table)s</span><span class="s">.id) AS id, count(</span><span class="si">%(table)s</span><span class="s">.id) AS </span><span class="si">%(count_field)s</span><span class="s">_count</span>
<span class="s">                   </span><span class="si">%(extra_fields)s</span><span class="s"></span>
<span class="s">            FROM </span><span class="si">%(from)s</span><span class="s"></span>
<span class="s">            </span><span class="si">%(where)s</span><span class="s"></span>
<span class="s">            </span><span class="si">%(groupby)s</span><span class="s"></span>
<span class="s">            </span><span class="si">%(orderby)s</span><span class="s"></span>
<span class="s">            </span><span class="si">%(limit)s</span><span class="s"></span>
<span class="s">            </span><span class="si">%(offset)s</span><span class="s"></span>
<span class="s">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s">&#39;table&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span>
            <span class="s">&#39;count_field&#39;</span><span class="p">:</span> <span class="n">count_field</span><span class="p">,</span>
            <span class="s">&#39;extra_fields&#39;</span><span class="p">:</span> <span class="n">prefix_terms</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="n">select_terms</span><span class="p">),</span>
            <span class="s">&#39;from&#39;</span><span class="p">:</span> <span class="n">from_clause</span><span class="p">,</span>
            <span class="s">&#39;where&#39;</span><span class="p">:</span> <span class="n">prefix_term</span><span class="p">(</span><span class="s">&#39;WHERE&#39;</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">),</span>
            <span class="s">&#39;groupby&#39;</span><span class="p">:</span> <span class="n">prefix_terms</span><span class="p">(</span><span class="s">&#39;GROUP BY&#39;</span><span class="p">,</span> <span class="n">groupby_terms</span><span class="p">),</span>
            <span class="s">&#39;orderby&#39;</span><span class="p">:</span> <span class="n">prefix_terms</span><span class="p">(</span><span class="s">&#39;ORDER BY&#39;</span><span class="p">,</span> <span class="n">orderby_terms</span><span class="p">),</span>
            <span class="s">&#39;limit&#39;</span><span class="p">:</span> <span class="n">prefix_term</span><span class="p">(</span><span class="s">&#39;LIMIT&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="bp">None</span><span class="p">),</span>
            <span class="s">&#39;offset&#39;</span><span class="p">:</span> <span class="n">prefix_term</span><span class="p">(</span><span class="s">&#39;OFFSET&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="bp">None</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">where_clause_params</span><span class="p">)</span>
        <span class="n">alldata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fetched_data</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()</span>

        <span class="n">data_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">fetched_data</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fld</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="n">fld</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">alldata</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">r</span>
            <span class="n">data_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">r</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">groupby</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">data_ids</span><span class="p">,</span> <span class="p">[</span><span class="n">groupby</span><span class="p">],</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
            <span class="c"># restore order of the search as read() uses the default _order (this is only for groups, so the footprint of data should be small):</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="n">groupby</span><span class="p">:</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_ids</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_ids</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">groupby</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s">&#39;__domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">groupby</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">alldata</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]][</span><span class="n">groupby</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">False</span><span class="p">)]</span> <span class="o">+</span> <span class="n">domain</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groupby_list</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">groupby</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;group_by_no_leaf&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                        <span class="n">d</span><span class="p">[</span><span class="s">&#39;__context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;group_by&#39;</span><span class="p">:</span> <span class="n">groupby_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]}</span>
            <span class="k">if</span> <span class="n">groupby</span> <span class="ow">and</span> <span class="n">groupby</span> <span class="ow">in</span> <span class="n">fget</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fget</span><span class="p">[</span><span class="n">groupby</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;date&#39;</span><span class="p">,</span> <span class="s">&#39;datetime&#39;</span><span class="p">):</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">alldata</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]][</span><span class="n">groupby</span><span class="p">][:</span><span class="mi">7</span><span class="p">],</span> <span class="s">&#39;%Y-%m&#39;</span><span class="p">)</span>
                    <span class="n">days</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

                    <span class="n">date_value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">groupby</span><span class="p">][:</span><span class="mi">10</span><span class="p">],</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="o">=</span> <span class="n">babel</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">format_date</span><span class="p">(</span>
                        <span class="n">date_value</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;MMMM yyyy&#39;</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lang&#39;</span><span class="p">,</span> <span class="s">&#39;en_US&#39;</span><span class="p">))</span>
                    <span class="n">d</span><span class="p">[</span><span class="s">&#39;__domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">groupby</span><span class="p">,</span> <span class="s">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="n">alldata</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]][</span><span class="n">groupby</span><span class="p">]</span> <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">alldata</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]][</span><span class="n">groupby</span><span class="p">][:</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;-01&#39;</span><span class="p">,</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">False</span><span class="p">),</span>\
                                     <span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="s">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="n">alldata</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]][</span><span class="n">groupby</span><span class="p">]</span> <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">alldata</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]][</span><span class="n">groupby</span><span class="p">][:</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">days</span><span class="p">),</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">False</span><span class="p">)]</span> <span class="o">+</span> <span class="n">domain</span>
                <span class="k">del</span> <span class="n">alldata</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]][</span><span class="n">groupby</span><span class="p">]</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">alldata</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]])</span>
            <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">groupby</span> <span class="ow">and</span> <span class="n">groupby</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_by_full</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_fill_results</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">groupby_list</span><span class="p">,</span>
                                                   <span class="n">aggregated_fields</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">read_group_order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
                                                   <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
</div>
    <span class="k">def</span> <span class="nf">_inherits_join_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_model</span><span class="p">,</span> <span class="n">parent_model_name</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add missing table SELECT and JOIN clause to ``query`` for reaching the parent table (no duplicates)</span>
<span class="sd">        :param current_model: current model object</span>
<span class="sd">        :param parent_model_name: name of the parent model for which the clauses should be added</span>
<span class="sd">        :param query: query object on which the JOIN should be added</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inherits_field</span> <span class="o">=</span> <span class="n">current_model</span><span class="o">.</span><span class="n">_inherits</span><span class="p">[</span><span class="n">parent_model_name</span><span class="p">]</span>
        <span class="n">parent_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_model_name</span><span class="p">)</span>
        <span class="n">parent_alias</span><span class="p">,</span> <span class="n">parent_alias_statement</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">add_join</span><span class="p">((</span><span class="n">current_model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">parent_model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">inherits_field</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">inherits_field</span><span class="p">),</span> <span class="n">implicit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parent_alias</span>

    <span class="k">def</span> <span class="nf">_inherits_join_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds missing table select and join clause(s) to ``query`` for reaching</span>
<span class="sd">        the field coming from an &#39;_inherits&#39; parent table (no duplicates).</span>

<span class="sd">        :param field: name of inherited field to reach</span>
<span class="sd">        :param query: query object on which the JOIN should be added</span>
<span class="sd">        :return: qualified name of field, to be used in SELECT clause</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_table</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">parent_alias</span> <span class="o">=</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">current_table</span><span class="o">.</span><span class="n">_table</span>
        <span class="k">while</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">current_table</span><span class="o">.</span><span class="n">_inherit_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">current_table</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
            <span class="n">parent_model_name</span> <span class="o">=</span> <span class="n">current_table</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">parent_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_model_name</span><span class="p">)</span>
            <span class="n">parent_alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_join_add</span><span class="p">(</span><span class="n">current_table</span><span class="p">,</span> <span class="n">parent_model_name</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">current_table</span> <span class="o">=</span> <span class="n">parent_table</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_alias</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parent_store_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Computing parent left and right for table </span><span class="si">%s</span><span class="s">...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">browse_rec</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="c"># TODO: set order</span>
            <span class="n">where</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="o">+</span><span class="s">&#39;=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
                <span class="n">where</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="o">+</span><span class="s">&#39; IS NULL&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_order</span><span class="p">:</span>
                <span class="n">where</span> <span class="o">+=</span> <span class="s">&#39; order by &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_order</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SELECT id FROM &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; WHERE &#39;</span><span class="o">+</span><span class="n">where</span><span class="p">)</span>
            <span class="n">pos2</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                <span class="n">pos2</span> <span class="o">=</span> <span class="n">browse_rec</span><span class="p">(</span><span class="nb">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos2</span><span class="p">)</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;update &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; set parent_left=</span><span class="si">%s</span><span class="s">, parent_right=</span><span class="si">%s</span><span class="s"> where id=</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">root</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">pos2</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s">&#39;SELECT id FROM &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; WHERE &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="o">+</span><span class="s">&#39; IS NULL&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_order</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s">&#39; order by &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_order</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">root</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">browse_rec</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_update_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;storing computed values of fields.function &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">_symbol_set</span>
        <span class="n">update_query</span> <span class="o">=</span> <span class="s">&#39;UPDATE &quot;</span><span class="si">%s</span><span class="s">&quot; SET &quot;</span><span class="si">%s</span><span class="s">&quot;=</span><span class="si">%s</span><span class="s"> WHERE id=</span><span class="si">%%</span><span class="s">s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ss</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;select id from &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
        <span class="n">ids_lst</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="k">while</span> <span class="n">ids_lst</span><span class="p">:</span>
            <span class="n">iids</span> <span class="o">=</span> <span class="n">ids_lst</span><span class="p">[:</span><span class="n">AUTOINIT_RECALCULATE_STORED_FIELDS</span><span class="p">]</span>
            <span class="n">ids_lst</span> <span class="o">=</span> <span class="n">ids_lst</span><span class="p">[</span><span class="n">AUTOINIT_RECALCULATE_STORED_FIELDS</span><span class="p">:]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">iids</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">_multi</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="c"># if val is a many2one, just write the ID</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update_query</span><span class="p">,</span> <span class="p">(</span><span class="n">ss</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">val</span><span class="p">),</span> <span class="n">key</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_selection_field_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Raise except_orm if value is not among the valid values for the selection field&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;reference&#39;</span><span class="p">:</span>
            <span class="n">val_model</span><span class="p">,</span> <span class="n">val_id_str</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">val_id</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val_id</span> <span class="o">=</span> <span class="nb">long</span><span class="p">(</span><span class="n">val_id_str</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">val_id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;ValidateError&#39;</span><span class="p">),</span>
                                 <span class="n">_</span><span class="p">(</span><span class="s">&#39;Invalid value for reference field &quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot; (last part must be a non-zero integer): &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val_model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">selection</span><span class="p">):</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)):</span>
            <span class="k">return</span>
        <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;ValidateError&#39;</span><span class="p">),</span>
                         <span class="n">_</span><span class="p">(</span><span class="s">&#39;The value &quot;</span><span class="si">%s</span><span class="s">&quot; for the field &quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot; is not in the selection&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_removed_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c"># iterate on the database columns to drop the NOT NULL constraints</span>
        <span class="c"># of fields which were required but have been removed (or will be added by another module)</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">fields</span><span class="o">.</span><span class="n">function</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">store</span><span class="p">)]</span>
        <span class="n">columns</span> <span class="o">+=</span> <span class="n">MAGIC_COLUMNS</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT a.attname, a.attnotnull&quot;</span>
                   <span class="s">&quot;  FROM pg_class c, pg_attribute a&quot;</span>
                   <span class="s">&quot; WHERE c.relname=</span><span class="si">%s</span><span class="s">&quot;</span>
                   <span class="s">&quot;   AND c.oid=a.attrelid&quot;</span>
                   <span class="s">&quot;   AND a.attisdropped=</span><span class="si">%s</span><span class="s">&quot;</span>
                   <span class="s">&quot;   AND pg_catalog.format_type(a.atttypid, a.atttypmod) NOT IN (&#39;cid&#39;, &#39;tid&#39;, &#39;oid&#39;, &#39;xid&#39;)&quot;</span>
                   <span class="s">&quot;   AND a.attname NOT IN </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">columns</span><span class="p">))),</span>

        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;column </span><span class="si">%s</span><span class="s"> is in the table </span><span class="si">%s</span><span class="s"> but not in the corresponding object </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span>
                              <span class="n">column</span><span class="p">[</span><span class="s">&#39;attname&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="s">&#39;attnotnull&#39;</span><span class="p">]:</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; ALTER COLUMN &quot;</span><span class="si">%s</span><span class="s">&quot; DROP NOT NULL&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">column</span><span class="p">[</span><span class="s">&#39;attname&#39;</span><span class="p">]))</span>
                <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: column &#39;</span><span class="si">%s</span><span class="s">&#39;: dropped NOT NULL constraint&quot;</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">column</span><span class="p">[</span><span class="s">&#39;attname&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_save_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">constraint_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Record the creation of a constraint for this model, to make it possible</span>
<span class="sd">        to delete it later when the module is uninstalled. Type can be either</span>
<span class="sd">        &#39;f&#39; or &#39;u&#39; depending on the constraint being a foreign key or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">:</span>
            <span class="c"># no need to save constraints for custom models as they&#39;re not part</span>
            <span class="c"># of any module</span>
            <span class="k">return</span>
        <span class="k">assert</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">,</span> <span class="s">&#39;u&#39;</span><span class="p">)</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">            SELECT 1 FROM ir_model_constraint, ir_module_module</span>
<span class="s">            WHERE ir_model_constraint.module=ir_module_module.id</span>
<span class="s">                AND ir_model_constraint.name=</span><span class="si">%s</span><span class="s"></span>
<span class="s">                AND ir_module_module.name=</span><span class="si">%s</span><span class="s"></span>
<span class="s">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">constraint_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span><span class="p">:</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">                INSERT INTO ir_model_constraint</span>
<span class="s">                    (name, date_init, date_update, module, model, type)</span>
<span class="s">                VALUES (</span><span class="si">%s</span><span class="s">, now() AT TIME ZONE &#39;UTC&#39;, now() AT TIME ZONE &#39;UTC&#39;,</span>
<span class="s">                    (SELECT id FROM ir_module_module WHERE name=</span><span class="si">%s</span><span class="s">),</span>
<span class="s">                    (SELECT id FROM ir_model WHERE model=</span><span class="si">%s</span><span class="s">), </span><span class="si">%s</span><span class="s">)&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">constraint_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_save_relation_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">relation_table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Record the creation of a many2many for this model, to make it possible</span>
<span class="sd">        to delete it later when the module is uninstalled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">            SELECT 1 FROM ir_model_relation, ir_module_module</span>
<span class="s">            WHERE ir_model_relation.module=ir_module_module.id</span>
<span class="s">                AND ir_model_relation.name=</span><span class="si">%s</span><span class="s"></span>
<span class="s">                AND ir_module_module.name=</span><span class="si">%s</span><span class="s"></span>
<span class="s">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">relation_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span><span class="p">:</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;INSERT INTO ir_model_relation (name, date_init, date_update, module, model)</span>
<span class="s">                                 VALUES (</span><span class="si">%s</span><span class="s">, now() AT TIME ZONE &#39;UTC&#39;, now() AT TIME ZONE &#39;UTC&#39;,</span>
<span class="s">                    (SELECT id FROM ir_module_module WHERE name=</span><span class="si">%s</span><span class="s">),</span>
<span class="s">                    (SELECT id FROM ir_model WHERE model=</span><span class="si">%s</span><span class="s">))&quot;&quot;&quot;</span><span class="p">,</span>
                       <span class="p">(</span><span class="n">relation_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>

    <span class="c"># checked version: for direct m2o starting from `self`</span>
    <span class="k">def</span> <span class="nf">_m2o_add_foreign_key_checked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_field</span><span class="p">,</span> <span class="n">dest_model</span><span class="p">,</span> <span class="n">ondelete</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_transient</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">is_transient</span><span class="p">(),</span> \
            <span class="s">&#39;Many2One relationships from non-transient Model to TransientModel are forbidden&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_transient</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">is_transient</span><span class="p">():</span>
            <span class="c"># TransientModel relationships to regular Models are annoying</span>
            <span class="c"># usually because they could block deletion due to the FKs.</span>
            <span class="c"># So unless stated otherwise we default them to ondelete=cascade.</span>
            <span class="n">ondelete</span> <span class="o">=</span> <span class="n">ondelete</span> <span class="ow">or</span> <span class="s">&#39;cascade&#39;</span>
        <span class="n">fk_def</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">source_field</span><span class="p">,</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">ondelete</span> <span class="ow">or</span> <span class="s">&#39;set null&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_foreign_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fk_def</span><span class="p">)</span>
        <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: added foreign key &#39;</span><span class="si">%s</span><span class="s">&#39; with definition=REFERENCES </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s"> ON DELETE </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">fk_def</span><span class="p">)</span>

    <span class="c"># unchecked version: for custom cases, such as m2m relationships</span>
    <span class="k">def</span> <span class="nf">_m2o_add_foreign_key_unchecked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_table</span><span class="p">,</span> <span class="n">source_field</span><span class="p">,</span> <span class="n">dest_model</span><span class="p">,</span> <span class="n">ondelete</span><span class="p">):</span>
        <span class="n">fk_def</span> <span class="o">=</span> <span class="p">(</span><span class="n">source_table</span><span class="p">,</span> <span class="n">source_field</span><span class="p">,</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">ondelete</span> <span class="ow">or</span> <span class="s">&#39;set null&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_foreign_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fk_def</span><span class="p">)</span>
        <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: added foreign key &#39;</span><span class="si">%s</span><span class="s">&#39; with definition=REFERENCES </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s"> ON DELETE </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">fk_def</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_drop_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">source_table</span><span class="p">,</span> <span class="n">constraint_name</span><span class="p">):</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;ALTER TABLE </span><span class="si">%s</span><span class="s"> DROP CONSTRAINT </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source_table</span><span class="p">,</span><span class="n">constraint_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_m2o_fix_foreign_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">source_table</span><span class="p">,</span> <span class="n">source_field</span><span class="p">,</span> <span class="n">dest_model</span><span class="p">,</span> <span class="n">ondelete</span><span class="p">):</span>
        <span class="c"># Find FK constraint(s) currently established for the m2o field,</span>
        <span class="c"># and see whether they are stale or not</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT confdeltype as ondelete_rule, conname as constraint_name,</span>
<span class="s">                             cl2.relname as foreign_table</span>
<span class="s">                      FROM pg_constraint as con, pg_class as cl1, pg_class as cl2,</span>
<span class="s">                           pg_attribute as att1, pg_attribute as att2</span>
<span class="s">                      WHERE con.conrelid = cl1.oid</span>
<span class="s">                        AND cl1.relname = </span><span class="si">%s</span><span class="s"></span>
<span class="s">                        AND con.confrelid = cl2.oid</span>
<span class="s">                        AND array_lower(con.conkey, 1) = 1</span>
<span class="s">                        AND con.conkey[1] = att1.attnum</span>
<span class="s">                        AND att1.attrelid = cl1.oid</span>
<span class="s">                        AND att1.attname = </span><span class="si">%s</span><span class="s"></span>
<span class="s">                        AND array_lower(con.confkey, 1) = 1</span>
<span class="s">                        AND con.confkey[1] = att2.attnum</span>
<span class="s">                        AND att2.attrelid = cl2.oid</span>
<span class="s">                        AND att2.attname = </span><span class="si">%s</span><span class="s"></span>
<span class="s">                        AND con.contype = &#39;f&#39;&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">source_table</span><span class="p">,</span> <span class="n">source_field</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">))</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c"># Is it the right constraint?</span>
                <span class="n">cons</span><span class="p">,</span> <span class="o">=</span> <span class="n">constraints</span>
                <span class="k">if</span> <span class="n">cons</span><span class="p">[</span><span class="s">&#39;ondelete_rule&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">POSTGRES_CONFDELTYPES</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">ondelete</span> <span class="ow">or</span> <span class="s">&#39;set null&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>\
                    <span class="ow">or</span> <span class="n">cons</span><span class="p">[</span><span class="s">&#39;foreign_table&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">_table</span><span class="p">:</span>
                    <span class="c"># Wrong FK: drop it and recreate</span>
                    <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: dropping obsolete FK constraint: &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="p">,</span>
                                  <span class="n">source_table</span><span class="p">,</span> <span class="n">cons</span><span class="p">[</span><span class="s">&#39;constraint_name&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_drop_constraint</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">source_table</span><span class="p">,</span> <span class="n">cons</span><span class="p">[</span><span class="s">&#39;constraint_name&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># it&#39;s all good, nothing to do!</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Multiple FKs found for the same field, drop them all, and re-create</span>
                <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
                    <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: dropping duplicate FK constraints: &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="p">,</span>
                                  <span class="n">source_table</span><span class="p">,</span> <span class="n">cons</span><span class="p">[</span><span class="s">&#39;constraint_name&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_drop_constraint</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">source_table</span><span class="p">,</span> <span class="n">cons</span><span class="p">[</span><span class="s">&#39;constraint_name&#39;</span><span class="p">])</span>

        <span class="c"># (re-)create the FK</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_m2o_add_foreign_key_checked</span><span class="p">(</span><span class="n">source_field</span><span class="p">,</span> <span class="n">dest_model</span><span class="p">,</span> <span class="n">ondelete</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">_auto_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Call _field_create and, unless _auto is False:</span>

<span class="sd">        - create the corresponding table in database for the model,</span>
<span class="sd">        - possibly add the parent columns in database,</span>
<span class="sd">        - possibly add the columns &#39;create_uid&#39;, &#39;create_date&#39;, &#39;write_uid&#39;,</span>
<span class="sd">          &#39;write_date&#39; in database if _log_access is True (the default),</span>
<span class="sd">        - report on database columns no more existing in _columns,</span>
<span class="sd">        - remove no more existing not null constraints,</span>
<span class="sd">        - alter existing database columns to match _columns,</span>
<span class="sd">        - create database tables to match _columns,</span>
<span class="sd">        - add database indices to match _columns,</span>
<span class="sd">        - save in self._foreign_keys a list a foreign keys to create (see</span>
<span class="sd">          _auto_end).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_foreign_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">raise_on_invalid_object_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">store_compute</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">todo_end</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">update_custom_fields</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;update_custom_fields&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_field_create</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="n">create</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_exist</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_auto&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_table</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>

            <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_columns_exist</span><span class="p">(</span><span class="n">cr</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_create_parent_columns</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>
                    <span class="n">store_compute</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="c"># Create the create_uid, create_date, write_uid, write_date, columns if desired.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_log_columns</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_check_removed_columns</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="c"># iterate on the &quot;object columns&quot;</span>
            <span class="n">column_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_column_data</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">MAGIC_COLUMNS</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c"># Don&#39;t update custom (also called manual) fields</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">manual</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">update_custom_fields</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">one2many</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_o2m_raise_on_missing_reference</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">many2many</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_m2m_raise_or_create_relation</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">column_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

                    <span class="c"># The field is not found as-is in database, try if it</span>
                    <span class="c"># exists with an old name.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;oldname&#39;</span><span class="p">):</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">column_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">oldname</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; RENAME &quot;</span><span class="si">%s</span><span class="s">&quot; TO &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">oldname</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                            <span class="n">res</span><span class="p">[</span><span class="s">&#39;attname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
                            <span class="n">column_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
                            <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: renamed column &#39;</span><span class="si">%s</span><span class="s">&#39; to &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">oldname</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

                    <span class="c"># The field already exists in database. Possibly</span>
                    <span class="c"># change its type, rename it, drop it or change its</span>
                    <span class="c"># constraints.</span>
                    <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                        <span class="n">f_pg_type</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s">&#39;typname&#39;</span><span class="p">]</span>
                        <span class="n">f_pg_size</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span>
                        <span class="n">f_pg_notnull</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s">&#39;attnotnull&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">function</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span>\
                                <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;nodrop&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;column </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">) in table </span><span class="si">%s</span><span class="s"> removed: converted to a function !</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
                                         <span class="n">k</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
                            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; DROP COLUMN &quot;</span><span class="si">%s</span><span class="s">&quot; CASCADE&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                            <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                            <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: dropped column &#39;</span><span class="si">%s</span><span class="s">&#39; with cascade&quot;</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                            <span class="n">f_obj_type</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">f_obj_type</span> <span class="o">=</span> <span class="n">get_pg_type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">and</span> <span class="n">get_pg_type</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="k">if</span> <span class="n">f_obj_type</span><span class="p">:</span>
                            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="n">casts</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="p">(</span><span class="s">&#39;text&#39;</span><span class="p">,</span> <span class="s">&#39;char&#39;</span><span class="p">,</span> <span class="n">pg_varchar</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="s">&#39;::</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">pg_varchar</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">size</span><span class="p">)),</span>
                                <span class="p">(</span><span class="s">&#39;varchar&#39;</span><span class="p">,</span> <span class="s">&#39;text&#39;</span><span class="p">,</span> <span class="s">&#39;TEXT&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span>
                                <span class="p">(</span><span class="s">&#39;int4&#39;</span><span class="p">,</span> <span class="s">&#39;float&#39;</span><span class="p">,</span> <span class="n">get_pg_type</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;::&#39;</span><span class="o">+</span><span class="n">get_pg_type</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                                <span class="p">(</span><span class="s">&#39;date&#39;</span><span class="p">,</span> <span class="s">&#39;datetime&#39;</span><span class="p">,</span> <span class="s">&#39;TIMESTAMP&#39;</span><span class="p">,</span> <span class="s">&#39;::TIMESTAMP&#39;</span><span class="p">),</span>
                                <span class="p">(</span><span class="s">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s">&#39;date&#39;</span><span class="p">,</span> <span class="s">&#39;date&#39;</span><span class="p">,</span> <span class="s">&#39;::date&#39;</span><span class="p">),</span>
                                <span class="p">(</span><span class="s">&#39;numeric&#39;</span><span class="p">,</span> <span class="s">&#39;float&#39;</span><span class="p">,</span> <span class="n">get_pg_type</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;::&#39;</span><span class="o">+</span><span class="n">get_pg_type</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                                <span class="p">(</span><span class="s">&#39;float8&#39;</span><span class="p">,</span> <span class="s">&#39;float&#39;</span><span class="p">,</span> <span class="n">get_pg_type</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;::&#39;</span><span class="o">+</span><span class="n">get_pg_type</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="p">]</span>
                            <span class="k">if</span> <span class="n">f_pg_type</span> <span class="o">==</span> <span class="s">&#39;varchar&#39;</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;char&#39;</span> <span class="ow">and</span> <span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">size</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">f_pg_size</span><span class="p">)</span> <span class="ow">or</span> <span class="n">f_pg_size</span> <span class="o">&lt;</span> <span class="n">f</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; RENAME COLUMN &quot;</span><span class="si">%s</span><span class="s">&quot; TO temp_change_size&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; ADD COLUMN &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">pg_varchar</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span>
                                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;UPDATE &quot;</span><span class="si">%s</span><span class="s">&quot; SET &quot;</span><span class="si">%s</span><span class="s">&quot;=temp_change_size::</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">pg_varchar</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span>
                                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; DROP COLUMN temp_change_size CASCADE&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,))</span>
                                <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                                <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: column &#39;</span><span class="si">%s</span><span class="s">&#39; (type varchar) changed size from </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">f_pg_size</span> <span class="ow">or</span> <span class="s">&#39;unlimited&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">size</span> <span class="ow">or</span> <span class="s">&#39;unlimited&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">casts</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">f_pg_type</span><span class="o">==</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">_type</span><span class="o">==</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                                    <span class="k">if</span> <span class="n">f_pg_type</span> <span class="o">!=</span> <span class="n">f_obj_type</span><span class="p">:</span>
                                        <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>
                                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; RENAME COLUMN &quot;</span><span class="si">%s</span><span class="s">&quot; TO temp_change_size&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; ADD COLUMN &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">((</span><span class="s">&#39;UPDATE &quot;</span><span class="si">%s</span><span class="s">&quot; SET &quot;</span><span class="si">%s</span><span class="s">&quot;=temp_change_size&#39;</span><span class="o">+</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; DROP COLUMN temp_change_size CASCADE&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,))</span>
                                        <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                                        <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: column &#39;</span><span class="si">%s</span><span class="s">&#39; changed type from </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                    <span class="k">break</span>

                            <span class="k">if</span> <span class="n">f_pg_type</span> <span class="o">!=</span> <span class="n">f_obj_type</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                                        <span class="n">newname</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="s">&#39;_moved&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT count(1) FROM pg_class c,pg_attribute a &quot;</span> \
                                            <span class="s">&quot;WHERE c.relname=</span><span class="si">%s</span><span class="s"> &quot;</span> \
                                            <span class="s">&quot;AND a.attname=</span><span class="si">%s</span><span class="s"> &quot;</span> \
                                            <span class="s">&quot;AND c.oid=a.attrelid &quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">newname</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                                            <span class="k">break</span>
                                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                                    <span class="k">if</span> <span class="n">f_pg_notnull</span><span class="p">:</span>
                                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; ALTER COLUMN &quot;</span><span class="si">%s</span><span class="s">&quot; DROP NOT NULL&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; RENAME COLUMN &quot;</span><span class="si">%s</span><span class="s">&quot; TO &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">newname</span><span class="p">))</span>
                                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; ADD COLUMN &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">get_pg_type</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
                                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;COMMENT ON COLUMN </span><span class="si">%s</span><span class="s">.</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s"> IS </span><span class="si">%%</span><span class="s">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">string</span><span class="p">,))</span>
                                    <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: column &#39;</span><span class="si">%s</span><span class="s">&#39; has changed type (DB=</span><span class="si">%s</span><span class="s">, def=</span><span class="si">%s</span><span class="s">), data moved to column </span><span class="si">%s</span><span class="s"> !&quot;</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">f_pg_type</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">_type</span><span class="p">,</span> <span class="n">newname</span><span class="p">)</span>

                            <span class="c"># if the field is required and hasn&#39;t got a NOT NULL constraint</span>
                            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">required</span> <span class="ow">and</span> <span class="n">f_pg_notnull</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="c"># set the field to the default value if any</span>
                                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                                        <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

                                    <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                        <span class="n">ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">_symbol_set</span>
                                        <span class="n">query</span> <span class="o">=</span> <span class="s">&#39;UPDATE &quot;</span><span class="si">%s</span><span class="s">&quot; SET &quot;</span><span class="si">%s</span><span class="s">&quot;=</span><span class="si">%s</span><span class="s"> WHERE &quot;</span><span class="si">%s</span><span class="s">&quot; is NULL&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ss</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k</span><span class="p">)</span>
                                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">ss</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">default</span><span class="p">),))</span>
                                <span class="c"># add the NOT NULL constraint</span>
                                <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; ALTER COLUMN &quot;</span><span class="si">%s</span><span class="s">&quot; SET NOT NULL&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">log_exceptions</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                                    <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                                    <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: column &#39;</span><span class="si">%s</span><span class="s">&#39;: added NOT NULL constraint&quot;</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: unable to set a NOT NULL constraint on column &#39;</span><span class="si">%s</span><span class="s">&#39; !</span><span class="se">\n</span><span class="s">&quot;</span>\
                                        <span class="s">&quot;If you want to have it, you should update the records and execute manually:</span><span class="se">\n</span><span class="s">&quot;</span>\
                                        <span class="s">&quot;ALTER TABLE </span><span class="si">%s</span><span class="s"> ALTER COLUMN </span><span class="si">%s</span><span class="s"> SET NOT NULL&quot;</span>
                                    <span class="n">_schema</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                                <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                            <span class="k">elif</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">required</span> <span class="ow">and</span> <span class="n">f_pg_notnull</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; ALTER COLUMN &quot;</span><span class="si">%s</span><span class="s">&quot; DROP NOT NULL&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                                <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                                <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: column &#39;</span><span class="si">%s</span><span class="s">&#39;: dropped NOT NULL constraint&quot;</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                            <span class="c"># Verify index</span>
                            <span class="n">indexname</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_index&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT indexname FROM pg_indexes WHERE indexname = </span><span class="si">%s</span><span class="s"> and tablename = </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">indexname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">))</span>
                            <span class="n">res2</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">res2</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">select</span><span class="p">:</span>
                                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;CREATE INDEX &quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_index&quot; ON &quot;</span><span class="si">%s</span><span class="s">&quot; (&quot;</span><span class="si">%s</span><span class="s">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                                <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;text&#39;</span><span class="p">:</span>
                                    <span class="c"># FIXME: for fields.text columns we should try creating GIN indexes instead (seems most suitable for an ERP context)</span>
                                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: Adding (b-tree) index for </span><span class="si">%s</span><span class="s"> column &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span>\
                                        <span class="s">&quot;This is probably useless (does not work for fulltext search) and prevents INSERTs of long texts&quot;</span>\
                                        <span class="s">&quot; because there is a length limit for indexable btree values!</span><span class="se">\n</span><span class="s">&quot;</span>\
                                        <span class="s">&quot;Use a search view instead if you simply want to make the field searchable.&quot;</span>
                                    <span class="n">_schema</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">_type</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">res2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">select</span><span class="p">:</span>
                                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;DROP INDEX &quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_index&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                                <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: dropping index for column &#39;</span><span class="si">%s</span><span class="s">&#39; of type &#39;</span><span class="si">%s</span><span class="s">&#39; as it is not required anymore&quot;</span>
                                <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">_type</span><span class="p">)</span>

                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">many2one</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">function</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2one&#39;</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">store</span><span class="p">):</span>
                                <span class="n">dest_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">_obj</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">_table</span> <span class="o">!=</span> <span class="s">&#39;ir_actions&#39;</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_m2o_fix_foreign_key</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dest_model</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">ondelete</span><span class="p">)</span>

                    <span class="c"># The field doesn&#39;t exist in database. Create it if necessary.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">function</span><span class="p">)</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                            <span class="c"># add the missing field</span>
                            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; ADD COLUMN &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">get_pg_type</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;COMMENT ON COLUMN </span><span class="si">%s</span><span class="s">.</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s"> IS </span><span class="si">%%</span><span class="s">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">string</span><span class="p">,))</span>
                            <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: added column &#39;</span><span class="si">%s</span><span class="s">&#39; with definition=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">get_pg_type</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

                            <span class="c"># initialize it</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">create</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                                    <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

                                <span class="n">ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">_symbol_set</span>
                                <span class="n">query</span> <span class="o">=</span> <span class="s">&#39;UPDATE &quot;</span><span class="si">%s</span><span class="s">&quot; SET &quot;</span><span class="si">%s</span><span class="s">&quot;=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ss</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">ss</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">default</span><span class="p">),))</span>
                                <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: setting default value of new column </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

                            <span class="c"># remember the functions to call for the stored fields</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">function</span><span class="p">):</span>
                                <span class="n">order</span> <span class="o">=</span> <span class="mi">10</span>
                                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">:</span> <span class="c"># i.e. if f.store is a dict</span>
                                    <span class="n">order</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">store</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span>
                                <span class="n">todo_end</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_store</span><span class="p">,</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">k</span><span class="p">)))</span>

                            <span class="c"># and add constraints if needed</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">many2one</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">function</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2one&#39;</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">store</span><span class="p">):</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">_obj</span><span class="p">):</span>
                                    <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="s">&#39;Programming Error&#39;</span><span class="p">,</span> <span class="s">&#39;There is no reference available for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">_obj</span><span class="p">,))</span>
                                <span class="n">dest_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">_obj</span><span class="p">)</span>
                                <span class="n">ref</span> <span class="o">=</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">_table</span>
                                <span class="c"># ir_actions is inherited so foreign key doesn&#39;t work on it</span>
                                <span class="k">if</span> <span class="n">ref</span> <span class="o">!=</span> <span class="s">&#39;ir_actions&#39;</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_m2o_add_foreign_key_checked</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dest_model</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">ondelete</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">select</span><span class="p">:</span>
                                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;CREATE INDEX &quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_index&quot; ON &quot;</span><span class="si">%s</span><span class="s">&quot; (&quot;</span><span class="si">%s</span><span class="s">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">required</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; ALTER COLUMN &quot;</span><span class="si">%s</span><span class="s">&quot; SET NOT NULL&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">log_exceptions</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                                    <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: column &#39;</span><span class="si">%s</span><span class="s">&#39;: added a NOT NULL constraint&quot;</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;WARNING: unable to set column </span><span class="si">%s</span><span class="s"> of table </span><span class="si">%s</span><span class="s"> not null !</span><span class="se">\n</span><span class="s">&quot;</span>\
                                        <span class="s">&quot;Try to re-run: openerp-server --update=module</span><span class="se">\n</span><span class="s">&quot;</span>\
                                        <span class="s">&quot;If it doesn&#39;t work, update records and execute manually:</span><span class="se">\n</span><span class="s">&quot;</span>\
                                        <span class="s">&quot;ALTER TABLE </span><span class="si">%s</span><span class="s"> ALTER COLUMN </span><span class="si">%s</span><span class="s"> SET NOT NULL&quot;</span>
                                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                            <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT relname FROM pg_class WHERE relkind IN (&#39;r&#39;,&#39;v&#39;) AND relname=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,))</span>
            <span class="n">create</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">())</span>

        <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>     <span class="c"># start a new transaction</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_sql_constraints</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_sql</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">store_compute</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store_compute</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">todo_end</span>

    <span class="k">def</span> <span class="nf">_auto_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create the foreign keys recorded by _auto_init. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_foreign_keys</span><span class="p">:</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; ADD FOREIGN KEY (&quot;</span><span class="si">%s</span><span class="s">&quot;) REFERENCES &quot;</span><span class="si">%s</span><span class="s">&quot; ON DELETE </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_constraint</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_fkey&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="s">&#39;f&#39;</span><span class="p">)</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_foreign_keys</span>


    <span class="k">def</span> <span class="nf">_table_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT relname FROM pg_class WHERE relkind IN (&#39;r&#39;,&#39;v&#39;) AND relname=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span>


    <span class="k">def</span> <span class="nf">_create_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;CREATE TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; (id SERIAL NOT NULL, PRIMARY KEY(id))&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,))</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">((</span><span class="s">&quot;COMMENT ON TABLE </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s"> IS </span><span class="si">%%</span><span class="s">s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">,))</span>
        <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: created&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_parent_columns_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT c.relname</span>
<span class="s">            FROM pg_class c, pg_attribute a</span>
<span class="s">            WHERE c.relname=</span><span class="si">%s</span><span class="s"> AND a.attname=</span><span class="si">%s</span><span class="s"> AND c.oid=a.attrelid</span>
<span class="s">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="s">&#39;parent_left&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span>


    <span class="k">def</span> <span class="nf">_create_parent_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; ADD COLUMN &quot;parent_left&quot; INTEGER&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,))</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; ADD COLUMN &quot;parent_right&quot; INTEGER&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,))</span>
        <span class="k">if</span> <span class="s">&#39;parent_left&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;create a column parent_left on object </span><span class="si">%s</span><span class="s">: fields.integer(</span><span class="se">\&#39;</span><span class="s">Left Parent</span><span class="se">\&#39;</span><span class="s">, select=1)&#39;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
            <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: added column &#39;</span><span class="si">%s</span><span class="s">&#39; with definition=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="s">&#39;parent_left&#39;</span><span class="p">,</span> <span class="s">&#39;INTEGER&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="s">&#39;parent_left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;parent_left column on object </span><span class="si">%s</span><span class="s"> must be indexed! Add select=1 to the field definition)&#39;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;parent_right&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;create a column parent_right on object </span><span class="si">%s</span><span class="s">: fields.integer(</span><span class="se">\&#39;</span><span class="s">Right Parent</span><span class="se">\&#39;</span><span class="s">, select=1)&#39;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
            <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: added column &#39;</span><span class="si">%s</span><span class="s">&#39; with definition=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="s">&#39;parent_right&#39;</span><span class="p">,</span> <span class="s">&#39;INTEGER&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="s">&#39;parent_right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;parent_right column on object </span><span class="si">%s</span><span class="s"> must be indexed! Add select=1 to the field definition)&#39;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">ondelete</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;cascade&#39;</span><span class="p">,</span> <span class="s">&#39;restrict&#39;</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;The column </span><span class="si">%s</span><span class="s"> on object </span><span class="si">%s</span><span class="s"> must be set as ondelete=&#39;cascade&#39; or &#39;restrict&#39;&quot;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

        <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_add_log_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_def</span> <span class="ow">in</span> <span class="n">LOG_ACCESS_COLUMNS</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">                SELECT c.relname</span>
<span class="s">                  FROM pg_class c, pg_attribute a</span>
<span class="s">                 WHERE c.relname=</span><span class="si">%s</span><span class="s"> AND a.attname=</span><span class="si">%s</span><span class="s"> AND c.oid=a.attrelid</span>
<span class="s">                &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span><span class="p">:</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; ADD COLUMN &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_def</span><span class="p">))</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: added column &#39;</span><span class="si">%s</span><span class="s">&#39; with definition=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_def</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_select_column_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="c"># attlen is the number of bytes necessary to represent the type when</span>
        <span class="c"># the type has a fixed size. If the type has a varying size attlen is</span>
        <span class="c"># -1 and atttypmod is the size limit + 4, or -1 if there is no limit.</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT c.relname,a.attname,a.attlen,a.atttypmod,a.attnotnull,a.atthasdef,t.typname,CASE WHEN a.attlen=-1 THEN (CASE WHEN a.atttypmod=-1 THEN 0 ELSE a.atttypmod-4 END) ELSE a.attlen END as size &quot;</span> \
           <span class="s">&quot;FROM pg_class c,pg_attribute a,pg_type t &quot;</span> \
           <span class="s">&quot;WHERE c.relname=</span><span class="si">%s</span><span class="s"> &quot;</span> \
           <span class="s">&quot;AND c.oid=a.attrelid &quot;</span> \
           <span class="s">&quot;AND a.atttypid=t.oid&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,))</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;attname&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">),</span><span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()))</span>


    <span class="k">def</span> <span class="nf">_o2m_raise_on_missing_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="c"># TODO this check should be a method on fields.one2many.</span>

        <span class="n">other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">_obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">other</span><span class="p">:</span>
            <span class="c"># TODO the condition could use fields_get_keys().</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">_fields_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">_fields_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="s">&#39;Programming Error&#39;</span><span class="p">,</span> <span class="s">&quot;There is no reference field &#39;</span><span class="si">%s</span><span class="s">&#39; found for &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">_fields_id</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">_obj</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">_m2m_raise_or_create_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="n">m2m_tbl</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">_sql_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_relation_table</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">m2m_tbl</span><span class="p">)</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT relname FROM pg_class WHERE relkind IN (&#39;r&#39;,&#39;v&#39;) AND relname=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">m2m_tbl</span><span class="p">,))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">_obj</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="s">&#39;Programming Error&#39;</span><span class="p">,</span> <span class="s">&#39;Many2Many destination model does not exist: `</span><span class="si">%s</span><span class="s">`&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">_obj</span><span class="p">,))</span>
            <span class="n">dest_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">_obj</span><span class="p">)</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">_table</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;CREATE TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; (&quot;</span><span class="si">%s</span><span class="s">&quot; INTEGER NOT NULL, &quot;</span><span class="si">%s</span><span class="s">&quot; INTEGER NOT NULL, UNIQUE(&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;))&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m2m_tbl</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">))</span>
            <span class="c"># create foreign key references with ondelete=cascade, unless the targets are SQL views</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT relkind FROM pg_class WHERE relkind IN (&#39;v&#39;) AND relname=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ref</span><span class="p">,))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_m2o_add_foreign_key_unchecked</span><span class="p">(</span><span class="n">m2m_tbl</span><span class="p">,</span> <span class="n">col2</span><span class="p">,</span> <span class="n">dest_model</span><span class="p">,</span> <span class="s">&#39;cascade&#39;</span><span class="p">)</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT relkind FROM pg_class WHERE relkind IN (&#39;v&#39;) AND relname=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_m2o_add_foreign_key_unchecked</span><span class="p">(</span><span class="n">m2m_tbl</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="s">&#39;cascade&#39;</span><span class="p">)</span>

            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;CREATE INDEX &quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_index&quot; ON &quot;</span><span class="si">%s</span><span class="s">&quot; (&quot;</span><span class="si">%s</span><span class="s">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m2m_tbl</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">m2m_tbl</span><span class="p">,</span> <span class="n">col1</span><span class="p">))</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;CREATE INDEX &quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_index&quot; ON &quot;</span><span class="si">%s</span><span class="s">&quot; (&quot;</span><span class="si">%s</span><span class="s">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m2m_tbl</span><span class="p">,</span> <span class="n">col2</span><span class="p">,</span> <span class="n">m2m_tbl</span><span class="p">,</span> <span class="n">col2</span><span class="p">))</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;COMMENT ON TABLE </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s"> IS &#39;RELATION BETWEEN </span><span class="si">%s</span><span class="s"> AND </span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m2m_tbl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">ref</span><span class="p">))</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Create table &#39;</span><span class="si">%s</span><span class="s">&#39;: m2m relation between &#39;</span><span class="si">%s</span><span class="s">&#39; and &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="p">,</span> <span class="n">m2m_tbl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_add_sql_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Modify this model&#39;s database table constraints so they match the one in</span>
<span class="sd">        _sql_constraints.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">unify_cons_text</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">txt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">,</span><span class="s">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; (&#39;</span><span class="p">,</span><span class="s">&#39;(&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_constraints</span><span class="p">:</span>
            <span class="n">conname</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_save_constraint</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">conname</span><span class="p">,</span> <span class="s">&#39;u&#39;</span><span class="p">)</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT conname, pg_catalog.pg_get_constraintdef(oid, true) as condef FROM pg_constraint where conname=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">conname</span><span class="p">,))</span>
            <span class="n">existing_constraints</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()</span>
            <span class="n">sql_actions</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;drop&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">&#39;execute&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="s">&#39;query&#39;</span><span class="p">:</span> <span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; DROP CONSTRAINT &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">conname</span><span class="p">,</span> <span class="p">),</span>
                    <span class="s">&#39;msg_ok&#39;</span><span class="p">:</span> <span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: dropped constraint &#39;</span><span class="si">%s</span><span class="s">&#39;. Reason: its definition changed from &#39;</span><span class="si">%%</span><span class="s">s&#39; to &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">conname</span><span class="p">,</span> <span class="n">con</span><span class="p">),</span>
                    <span class="s">&#39;msg_err&#39;</span><span class="p">:</span> <span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: unable to drop </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> constraint !&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">con</span><span class="p">),</span>
                    <span class="s">&#39;order&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s">&#39;add&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">&#39;execute&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="s">&#39;query&#39;</span><span class="p">:</span> <span class="s">&#39;ALTER TABLE &quot;</span><span class="si">%s</span><span class="s">&quot; ADD CONSTRAINT &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">conname</span><span class="p">,</span> <span class="n">con</span><span class="p">,),</span>
                    <span class="s">&#39;msg_ok&#39;</span><span class="p">:</span> <span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: added constraint &#39;</span><span class="si">%s</span><span class="s">&#39; with definition=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">conname</span><span class="p">,</span> <span class="n">con</span><span class="p">),</span>
                    <span class="s">&#39;msg_err&#39;</span><span class="p">:</span> <span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39;: unable to add </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> constraint !</span><span class="se">\n</span><span class="s"> If you want to have it, you should update the records and execute manually:</span><span class="se">\n</span><span class="si">%%</span><span class="s">s&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">con</span><span class="p">),</span>
                    <span class="s">&#39;order&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_constraints</span><span class="p">:</span>
                <span class="c"># constraint does not exists:</span>
                <span class="n">sql_actions</span><span class="p">[</span><span class="s">&#39;add&#39;</span><span class="p">][</span><span class="s">&#39;execute&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">sql_actions</span><span class="p">[</span><span class="s">&#39;add&#39;</span><span class="p">][</span><span class="s">&#39;msg_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql_actions</span><span class="p">[</span><span class="s">&#39;add&#39;</span><span class="p">][</span><span class="s">&#39;msg_err&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="n">sql_actions</span><span class="p">[</span><span class="s">&#39;add&#39;</span><span class="p">][</span><span class="s">&#39;query&#39;</span><span class="p">],</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">unify_cons_text</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">unify_cons_text</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s">&#39;condef&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">existing_constraints</span><span class="p">]:</span>
                <span class="c"># constraint exists but its definition has changed:</span>
                <span class="n">sql_actions</span><span class="p">[</span><span class="s">&#39;drop&#39;</span><span class="p">][</span><span class="s">&#39;execute&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">sql_actions</span><span class="p">[</span><span class="s">&#39;drop&#39;</span><span class="p">][</span><span class="s">&#39;msg_ok&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql_actions</span><span class="p">[</span><span class="s">&#39;drop&#39;</span><span class="p">][</span><span class="s">&#39;msg_ok&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="n">existing_constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;condef&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="p">)</span>
                <span class="n">sql_actions</span><span class="p">[</span><span class="s">&#39;add&#39;</span><span class="p">][</span><span class="s">&#39;execute&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">sql_actions</span><span class="p">[</span><span class="s">&#39;add&#39;</span><span class="p">][</span><span class="s">&#39;msg_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql_actions</span><span class="p">[</span><span class="s">&#39;add&#39;</span><span class="p">][</span><span class="s">&#39;msg_err&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="n">sql_actions</span><span class="p">[</span><span class="s">&#39;add&#39;</span><span class="p">][</span><span class="s">&#39;query&#39;</span><span class="p">],</span> <span class="p">)</span>

            <span class="c"># we need to add the constraint:</span>
            <span class="n">sql_actions</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sql_actions</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="n">sql_actions</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;order&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">sql_action</span> <span class="ow">in</span> <span class="p">[</span><span class="n">action</span> <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">sql_actions</span> <span class="k">if</span> <span class="n">action</span><span class="p">[</span><span class="s">&#39;execute&#39;</span><span class="p">]]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_action</span><span class="p">[</span><span class="s">&#39;query&#39;</span><span class="p">])</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="n">_schema</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sql_action</span><span class="p">[</span><span class="s">&#39;msg_ok&#39;</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">_schema</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">sql_action</span><span class="p">[</span><span class="s">&#39;msg_err&#39;</span><span class="p">])</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_execute_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Execute the SQL code from the _sql attribute (if any).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;_sql&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">):</span>
                <span class="n">line2</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">line2</span><span class="p">:</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">line2</span><span class="p">)</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c">#</span>
    <span class="c"># Update objects that uses this one to update their _inherits fields</span>
    <span class="c">#</span>

    <span class="k">def</span> <span class="nf">_inherits_reload_src</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Recompute the _inherit_fields mapping on each _inherits&#39;d child model.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_inherits_reload</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_inherits_reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Recompute the _inherit_fields mapping.</span>

<span class="sd">        This will also call itself on each inherits&#39;d child model.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
            <span class="n">other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">res</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">[</span><span class="n">table</span><span class="p">],</span> <span class="n">other</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">table</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">res</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">[</span><span class="n">table</span><span class="p">],</span> <span class="n">other</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">other</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span> <span class="o">=</span> <span class="n">res</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_column_infos</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_reload_src</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">_get_column_infos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a dict mapping all fields names (direct fields and</span>
<span class="sd">           inherited field via _inherits) to a ``column_info`` struct</span>
<span class="sd">           giving detailed columns &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">m2o</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">original_parent</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">column_info</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">m2o</span><span class="p">,</span> <span class="n">original_parent</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">column_info</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>


    <span class="k">def</span> <span class="nf">_inherits_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Missing many2one field definition for _inherits reference &quot;</span><span class="si">%s</span><span class="s">&quot; in &quot;</span><span class="si">%s</span><span class="s">&quot;, using default one.&#39;</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">many2one</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s">&quot;Automatically created field to link to parent </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">table</span><span class="p">,</span>
                                                             <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s">&quot;cascade&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">required</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">ondelete</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;cascade&quot;</span><span class="p">,</span> <span class="s">&quot;restrict&quot;</span><span class="p">):</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Field definition for _inherits reference &quot;</span><span class="si">%s</span><span class="s">&quot; in &quot;</span><span class="si">%s</span><span class="s">&quot; must be marked as &quot;required&quot; with ondelete=&quot;cascade&quot; or &quot;restrict&quot;, forcing it to required + cascade.&#39;</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">ondelete</span> <span class="o">=</span> <span class="s">&quot;cascade&quot;</span>

    <span class="c">#def __getattr__(self, name):</span>
    <span class="c">#    &quot;&quot;&quot;</span>
    <span class="c">#    Proxies attribute accesses to the `inherits` parent so we can call methods defined on the inherited parent</span>
    <span class="c">#    (though inherits doesn&#39;t use Python inheritance).</span>
    <span class="c">#    Handles translating between local ids and remote ids.</span>
    <span class="c">#    Known issue: doesn&#39;t work correctly when using python&#39;s own super(), don&#39;t involve inherit-based inheritance</span>
    <span class="c">#                 when you have inherits.</span>
    <span class="c">#    &quot;&quot;&quot;</span>
    <span class="c">#    for model, field in self._inherits.iteritems():</span>
    <span class="c">#        proxy = self.pool.get(model)</span>
    <span class="c">#        if hasattr(proxy, name):</span>
    <span class="c">#            attribute = getattr(proxy, name)</span>
    <span class="c">#            if not hasattr(attribute, &#39;__call__&#39;):</span>
    <span class="c">#                return attribute</span>
    <span class="c">#            break</span>
    <span class="c">#    else:</span>
    <span class="c">#        return super(orm, self).__getattr__(name)</span>

    <span class="c">#    def _proxy(cr, uid, ids, *args, **kwargs):</span>
    <span class="c">#        objects = self.browse(cr, uid, ids, kwargs.get(&#39;context&#39;, None))</span>
    <span class="c">#        lst = [obj[field].id for obj in objects if obj[field]]</span>
    <span class="c">#        return getattr(proxy, name)(cr, uid, lst, *args, **kwargs)</span>

    <span class="c">#    return _proxy</span>


<div class="viewcode-block" id="BaseModel.fields_get"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.fields_get">[docs]</a>    <span class="k">def</span> <span class="nf">fields_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">allfields</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">write_access</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the definition of each field.</span>

<span class="sd">        The returned value is a dictionary (indiced by field name) of</span>
<span class="sd">        dictionaries. The _inherits&#39;d fields are included. The string, help,</span>
<span class="sd">        and selection (if present) attributes are translated.</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param user: current user id</span>
<span class="sd">        :param allfields: list of fields</span>
<span class="sd">        :param context: context arguments, like lang, time zone</span>
<span class="sd">        :return: dictionary of field dictionaries, each one describing a field of the business object</span>
<span class="sd">        :raise AccessError: * if user has no create/write rights on the requested object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">write_access</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> \
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;create&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">translation_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.translation&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">fields_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">allfields</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">allfields</span> <span class="ow">and</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allfields</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">groups</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_groups</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)):</span>
                <span class="k">continue</span>

            <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">field_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">write_access</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s">&#39;readonly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s">&#39;states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="s">&#39;lang&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;string&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="p">]:</span>
                    <span class="n">res_trans</span> <span class="o">=</span> <span class="n">translation_obj</span><span class="o">.</span><span class="n">_get_source</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">+</span> <span class="s">&#39;,&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="p">,</span> <span class="s">&#39;field&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;lang&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">res_trans</span><span class="p">:</span>
                        <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s">&#39;string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_trans</span>
                <span class="k">if</span> <span class="s">&#39;help&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="p">]:</span>
                    <span class="n">help_trans</span> <span class="o">=</span> <span class="n">translation_obj</span><span class="o">.</span><span class="n">_get_source</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">+</span> <span class="s">&#39;,&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="p">,</span> <span class="s">&#39;help&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;lang&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">help_trans</span><span class="p">:</span>
                        <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s">&#39;help&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">help_trans</span>
                <span class="k">if</span> <span class="s">&#39;selection&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">selection</span>
                        <span class="n">sel2</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">:</span>
                            <span class="n">val2</span> <span class="o">=</span> <span class="bp">None</span>
                            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                                <span class="n">val2</span> <span class="o">=</span> <span class="n">translation_obj</span><span class="o">.</span><span class="n">_get_source</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">+</span> <span class="s">&#39;,&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="p">,</span> <span class="s">&#39;selection&#39;</span><span class="p">,</span>  <span class="n">context</span><span class="p">[</span><span class="s">&#39;lang&#39;</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>
                            <span class="n">sel2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">val2</span> <span class="ow">or</span> <span class="n">val</span><span class="p">))</span>
                        <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="s">&#39;selection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sel2</span>

        <span class="k">return</span> <span class="n">res</span>
</div>
<div class="viewcode-block" id="BaseModel.check_field_access_rights"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.check_field_access_rights">[docs]</a>    <span class="k">def</span> <span class="nf">check_field_access_rights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the user access rights on the given fields. This raises Access</span>
<span class="sd">        Denied if the user does not have the rights. Otherwise it returns the</span>
<span class="sd">        fields (as is if the fields is not falsy, or the readable/writable</span>
<span class="sd">        fields if fields is falsy).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="n">field_name</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Predicate to test if the user has access to the given field name.&quot;&quot;&quot;</span>
            <span class="c"># Ignore requested field if it doesn&#39;t exist. This is ugly but</span>
            <span class="c"># it seems to happen at least with &#39;name_alias&#39; on res.partner.</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">column</span>
            <span class="k">if</span> <span class="n">user</span> <span class="o">!=</span> <span class="n">SUPERUSER_ID</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_groups</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filtered_fields</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="ow">not</span> <span class="n">p</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">fields</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filtered_fields</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Access Denied by ACLs for operation: </span><span class="si">%s</span><span class="s">, uid: </span><span class="si">%s</span><span class="s">, model: </span><span class="si">%s</span><span class="s">, fields: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_fields</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s">&#39;Access Denied&#39;</span><span class="p">),</span>
                    <span class="n">_</span><span class="p">(</span><span class="s">&#39;The requested operation cannot be completed due to security restrictions. &#39;</span>
                    <span class="s">&#39;Please contact your system administrator.</span><span class="se">\n\n</span><span class="s">(Document type: </span><span class="si">%s</span><span class="s">, Operation: </span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">)</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">,</span> <span class="n">operation</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fields</span>
</div>
<div class="viewcode-block" id="BaseModel.read"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="s">&#39;_classic_read&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read records with given ids with the given fields</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param user: current user id</span>
<span class="sd">        :param ids: id or list of the ids of the records to read</span>
<span class="sd">        :param fields: optional list of field names to return (default: all fields would be returned)</span>
<span class="sd">        :type fields: list (example [&#39;field_name_1&#39;, ...])</span>
<span class="sd">        :param context: optional context dictionary - it may contains keys for specifying certain options</span>
<span class="sd">                        like ``context_lang``, ``context_tz`` to alter the results of the call.</span>
<span class="sd">                        A special ``bin_size`` boolean flag may also be passed in the context to request the</span>
<span class="sd">                        value of all fields.binary columns to be returned as the size of the binary instead of its</span>
<span class="sd">                        contents. This can also be selectively overriden by passing a field-specific flag</span>
<span class="sd">                        in the form ``bin_size_XXX: True/False`` where ``XXX`` is the name of the field.</span>
<span class="sd">                        Note: The ``bin_size_XXX`` form is new in OpenERP v6.0.</span>
<span class="sd">        :return: list of dictionaries((dictionary per record asked)) with requested field values</span>
<span class="sd">        :rtype: [{‘name_of_the_field’: value, ...}, ...]</span>
<span class="sd">        :raise AccessError: * if user has no read rights on the requested object</span>
<span class="sd">                            * if user tries to bypass access rules for read on the requested object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_field_access_rights</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
            <span class="n">select</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">select</span> <span class="o">=</span> <span class="n">ids</span>
        <span class="n">select</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">x</span><span class="p">,</span> <span class="n">select</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_flat</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">load</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
    <span class="k">def</span> <span class="nf">_read_flat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">fields_to_read</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="s">&#39;_classic_read&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">fields_to_read</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fields_to_read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c"># all inherited fields + all non inherited fields for which the attribute whose name is in load is True</span>
        <span class="n">fields_pre</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields_to_read</span> <span class="k">if</span>
                           <span class="n">f</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONCURRENCY_CHECK_FIELD</span>
                        <span class="ow">or</span> <span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="s">&#39;_classic_write&#39;</span><span class="p">))</span>
                     <span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields_pre</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">convert_field</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">f_qual</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="c"># need fully-qualified references in case len(tables) &gt; 1</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;create_date&#39;</span><span class="p">,</span> <span class="s">&#39;write_date&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="s">&quot;date_trunc(&#39;second&#39;, </span><span class="si">%s</span><span class="s">) as </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f_qual</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONCURRENCY_CHECK_FIELD</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s">&quot;COALESCE(</span><span class="si">%s</span><span class="s">.write_date, </span><span class="si">%s</span><span class="s">.create_date, (now() at time zone &#39;UTC&#39;))::timestamp AS </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">f</span><span class="p">,)</span>
                    <span class="k">return</span> <span class="s">&quot;(now() at time zone &#39;UTC&#39;)::timestamp AS </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">fields</span><span class="o">.</span><span class="n">binary</span><span class="p">)</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;bin_size&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                    <span class="k">return</span> <span class="s">&#39;length(</span><span class="si">%s</span><span class="s">) as &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f_qual</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">f_qual</span>

            <span class="c"># Construct a clause for the security rules.</span>
            <span class="c"># &#39;tables&#39; hold the list of tables necessary for the SELECT including the ir.rule clauses,</span>
            <span class="c"># or will at least contain self._table.</span>
            <span class="n">rule_clause</span><span class="p">,</span> <span class="n">rule_params</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.rule&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">domain_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

            <span class="n">fields_pre2</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">convert_field</span><span class="p">,</span> <span class="n">fields_pre</span><span class="p">)</span>
            <span class="n">order_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_order</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span>
            <span class="n">select_fields</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields_pre2</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.id&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">])</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s">&#39;SELECT </span><span class="si">%s</span><span class="s"> FROM </span><span class="si">%s</span><span class="s"> WHERE </span><span class="si">%s</span><span class="s">.id IN </span><span class="si">%%</span><span class="s">s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">select_fields</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tables</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rule_clause</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s">&quot; AND &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s">&#39; OR &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rule_clause</span><span class="p">))</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s">&quot; ORDER BY &quot;</span> <span class="o">+</span> <span class="n">order_by</span>
            <span class="k">for</span> <span class="n">sub_ids</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">sub_ids</span><span class="p">)]</span> <span class="o">+</span> <span class="n">rule_params</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()</span>
                <span class="n">result_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_record_rules_result_count</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">sub_ids</span><span class="p">,</span> <span class="n">result_ids</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rule</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">},</span> <span class="n">ids</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lang&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields_pre</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONCURRENCY_CHECK_FIELD</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">translate</span><span class="p">:</span>
                    <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>
                    <span class="c">#TODO: optimize out of this loop</span>
                    <span class="n">res_trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.translation&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_get_ids</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;model&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;lang&#39;</span><span class="p">],</span> <span class="n">ids</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                        <span class="n">r</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_trans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="bp">False</span><span class="p">)</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">intersect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">fields_to_read</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">res2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">],</span> <span class="n">cols</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">load</span><span class="p">)</span>

            <span class="n">res3</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res2</span><span class="p">:</span>
                <span class="n">res3</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">r</span>
                <span class="k">del</span> <span class="n">r</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="p">[</span><span class="n">col</span><span class="p">]:</span> <span class="c"># if the record is deleted from _inherits table?</span>
                    <span class="k">continue</span>
                <span class="n">record</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">res3</span><span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="n">col</span><span class="p">]])</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields_to_read</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">record</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

        <span class="c"># all fields which need to be post-processed by a simple function (symbol_get)</span>
        <span class="n">fields_post</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">_symbol_get</span><span class="p">,</span> <span class="n">fields_to_read</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fields_post</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields_post</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">_symbol_get</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>

        <span class="c"># all non inherited fields for which the attribute whose name is in load is False</span>
        <span class="n">fields_post</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">load</span><span class="p">),</span> <span class="n">fields_to_read</span><span class="p">)</span>

        <span class="c"># Compute POST fields</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields_post</span><span class="p">:</span>
            <span class="n">todo</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">_multi</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">todo</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">_multi</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">todo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">res2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">res</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">res2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> \
                    <span class="s">&#39;The function field &quot;</span><span class="si">%s</span><span class="s">&quot; on the &quot;</span><span class="si">%s</span><span class="s">&quot; model returned None</span><span class="se">\n</span><span class="s">&#39;</span> \
                    <span class="s">&#39;(a dictionary was expected).&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res2</span><span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]],</span> <span class="nb">str</span><span class="p">):</span> <span class="n">res2</span><span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">res2</span><span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]])</span> <span class="c">#TOCHECK : why got string instend of dict in python2.6</span>
                        <span class="n">multi_fields</span> <span class="o">=</span> <span class="n">res2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],{})</span>
                        <span class="k">if</span> <span class="n">multi_fields</span><span class="p">:</span>
                            <span class="n">record</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pos</span><span class="p">,[])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                    <span class="n">res2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">res</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">res2</span><span class="p">:</span>
                            <span class="n">record</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">res2</span><span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">record</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Warn about deprecated fields now that fields_pre and fields_post are computed</span>
        <span class="c"># Explicitly use list() because we may receive tuples</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">fields_pre</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">fields_post</span><span class="p">):</span>
            <span class="n">field_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">column</span>
            <span class="k">if</span> <span class="n">field_column</span> <span class="ow">and</span> <span class="n">field_column</span><span class="o">.</span><span class="n">deprecated</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Field </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s"> is deprecated: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">field_column</span><span class="o">.</span><span class="n">deprecated</span><span class="p">)</span>

        <span class="n">readonly</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
                <span class="n">fobj</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                    <span class="n">fobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">fobj</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">groups</span> <span class="o">=</span> <span class="n">fobj</span><span class="o">.</span><span class="n">read</span>
                <span class="k">if</span> <span class="n">groups</span><span class="p">:</span>
                    <span class="n">edit</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                        <span class="n">module</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">grp</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select count(*) from res_groups_users_rel where gid IN (select res_id from ir_model_data where name=</span><span class="si">%s</span><span class="s"> and module=</span><span class="si">%s</span><span class="s"> and model=</span><span class="si">%s</span><span class="s">) and uid=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span>  \
                                   <span class="p">(</span><span class="n">grp</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="s">&#39;res.groups&#39;</span><span class="p">,</span> <span class="n">user</span><span class="p">))</span>
                        <span class="n">readonly</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">readonly</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">edit</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">break</span>
                        <span class="k">elif</span> <span class="n">readonly</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">edit</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">edit</span> <span class="o">=</span> <span class="bp">False</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">edit</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="p">])</span> <span class="o">==</span> <span class="nb">type</span><span class="p">([]):</span>
                            <span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="p">])</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="mf">0.0</span><span class="p">):</span>
                            <span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="p">])</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">):</span>
                            <span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;=No Permission=&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="c"># TODO check READ access</span>
<div class="viewcode-block" id="BaseModel.perm_read"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.perm_read">[docs]</a>    <span class="k">def</span> <span class="nf">perm_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns some metadata about the given records.</span>

<span class="sd">        :param details: if True, \*_uid fields are replaced with the name of the user</span>
<span class="sd">        :return: list of ownership dictionaries for each requested record</span>
<span class="sd">        :rtype: list of dictionaries with the following keys:</span>

<span class="sd">                    * id: object id</span>
<span class="sd">                    * create_uid: user who created the record</span>
<span class="sd">                    * create_date: date when the record was created</span>
<span class="sd">                    * write_uid: last user who changed the record</span>
<span class="sd">                    * write_date: date of the last change to the record</span>
<span class="sd">                    * xmlid: XML ID to use to refer to this record (if there is one), in format ``module.name``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">uniq</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">uniq</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;create_uid&#39;</span><span class="p">,</span> <span class="s">&#39;create_date&#39;</span><span class="p">,</span> <span class="s">&#39;write_uid&#39;</span><span class="p">,</span> <span class="s">&#39;write_date&#39;</span><span class="p">]</span>
        <span class="n">quoted_table</span> <span class="o">=</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span>
        <span class="n">fields_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">quoted_table</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;SELECT </span><span class="si">%s</span><span class="s">, __imd.module, __imd.name</span>
<span class="s">                   FROM </span><span class="si">%s</span><span class="s"> LEFT JOIN ir_model_data __imd</span>
<span class="s">                       ON (__imd.model = </span><span class="si">%%</span><span class="s">s and __imd.res_id = </span><span class="si">%s</span><span class="s">.id)</span>
<span class="s">                   WHERE </span><span class="si">%s</span><span class="s">.id IN </span><span class="si">%%</span><span class="s">s&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fields_str</span><span class="p">,</span> <span class="n">quoted_table</span><span class="p">,</span> <span class="n">quoted_table</span><span class="p">,</span> <span class="n">quoted_table</span><span class="p">)</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ids</span><span class="p">)))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">details</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;write_uid&#39;</span><span class="p">,</span> <span class="s">&#39;create_uid&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;res.users&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">name_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span> <span class="c"># Leave the numeric uid there</span>
            <span class="n">r</span><span class="p">[</span><span class="s">&#39;xmlid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%(module)s</span><span class="s">.</span><span class="si">%(name)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">r</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="bp">False</span>
            <span class="k">del</span> <span class="n">r</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s">&#39;module&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">uniq</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">res</span>
</div>
    <span class="k">def</span> <span class="nf">_check_concurrency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONCURRENCY_CHECK_FIELD</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">check_clause</span> <span class="o">=</span> <span class="s">&quot;(id = </span><span class="si">%s</span><span class="s"> AND </span><span class="si">%s</span><span class="s"> &lt; COALESCE(write_date, create_date, (now() at time zone &#39;UTC&#39;))::timestamp)&quot;</span>
        <span class="k">for</span> <span class="n">sub_ids</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
            <span class="n">ids_to_check</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">sub_ids</span><span class="p">:</span>
                <span class="n">id_ref</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
                <span class="n">update_date</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CONCURRENCY_CHECK_FIELD</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">id_ref</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">update_date</span><span class="p">:</span>
                    <span class="n">ids_to_check</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">id</span><span class="p">,</span> <span class="n">update_date</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ids_to_check</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT id FROM </span><span class="si">%s</span><span class="s"> WHERE </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="s">&quot; OR &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">check_clause</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ids_to_check</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ids_to_check</span><span class="p">))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                <span class="c"># mention the first one only to keep the error message readable</span>
                <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="s">&#39;ConcurrencyException&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;A document was modified since you last viewed it (</span><span class="si">%s</span><span class="s">:</span><span class="si">%d</span><span class="s">)&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_check_record_rules_result_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">result_ids</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify the returned rows after applying record rules matches</span>
<span class="sd">           the length of `ids`, and raise an appropriate exception if it does not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ids</span><span class="p">,</span> <span class="n">result_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">result_ids</span><span class="p">)</span>
        <span class="n">missing_ids</span> <span class="o">=</span> <span class="n">ids</span> <span class="o">-</span> <span class="n">result_ids</span>
        <span class="k">if</span> <span class="n">missing_ids</span><span class="p">:</span>
            <span class="c"># Attempt to distinguish record rule restriction vs deleted records,</span>
            <span class="c"># to provide a more specific error message - check if the missinf</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SELECT id FROM &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="s">&#39; WHERE id IN </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">missing_ids</span><span class="p">),))</span>
            <span class="k">if</span> <span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span><span class="p">:</span>
                <span class="c"># the missing ids are (at least partially) hidden by access rules</span>
                <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="n">SUPERUSER_ID</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Access Denied by record rules for operation: </span><span class="si">%s</span><span class="s">, uid: </span><span class="si">%s</span><span class="s">, model: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Access Denied&#39;</span><span class="p">),</span>
                                 <span class="n">_</span><span class="p">(</span><span class="s">&#39;The requested operation cannot be completed due to security restrictions. Please contact your system administrator.</span><span class="se">\n\n</span><span class="s">(Document type: </span><span class="si">%s</span><span class="s">, Operation: </span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">)</span> <span class="o">%</span> \
                                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">,</span> <span class="n">operation</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># If we get here, the missing_ids are not in the database</span>
                <span class="k">if</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;read&#39;</span><span class="p">,</span><span class="s">&#39;unlink&#39;</span><span class="p">):</span>
                    <span class="c"># No need to warn about deleting an already deleted record.</span>
                    <span class="c"># And no error when reading a record that was deleted, to prevent spurious</span>
                    <span class="c"># errors for non-transactional search/read sequences coming from clients </span>
                    <span class="k">return</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Failed operation on deleted record(s): </span><span class="si">%s</span><span class="s">, uid: </span><span class="si">%s</span><span class="s">, model: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Missing document(s)&#39;</span><span class="p">),</span>
                                 <span class="n">_</span><span class="p">(</span><span class="s">&#39;One of the documents you are trying to access has been deleted, please try again after refreshing.&#39;</span><span class="p">))</span>


<div class="viewcode-block" id="BaseModel.check_access_rights"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.check_access_rights">[docs]</a>    <span class="k">def</span> <span class="nf">check_access_rights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span> <span class="c"># no context on purpose.</span>
        <span class="sd">&quot;&quot;&quot;Verifies that the operation given by ``operation`` is allowed for the user</span>
<span class="sd">           according to the access rights.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.model.access&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">raise_exception</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseModel.check_access_rule"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.check_access_rule">[docs]</a>    <span class="k">def</span> <span class="nf">check_access_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verifies that the operation given by ``operation`` is allowed for the user</span>
<span class="sd">           according to ir.rules.</span>

<span class="sd">           :param operation: one of ``write``, ``unlink``</span>
<span class="sd">           :raise except_orm: * if current ir.rules do not permit this operation.</span>
<span class="sd">           :return: None if the operation is allowed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="n">SUPERUSER_ID</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_transient</span><span class="p">():</span>
            <span class="c"># Only one single implicit access rule for transient models: owner only!</span>
            <span class="c"># This is ok to hardcode because we assert that TransientModels always</span>
            <span class="c"># have log_access enabled so that the create_uid column is always there.</span>
            <span class="c"># And even with _inherits, these fields are always present in the local</span>
            <span class="c"># table too, so no need for JOINs.</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;SELECT distinct create_uid</span>
<span class="s">                          FROM </span><span class="si">%s</span><span class="s"></span>
<span class="s">                          WHERE id IN </span><span class="si">%%</span><span class="s">s&quot;&quot;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ids</span><span class="p">),))</span>
            <span class="n">uids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uids</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">uids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">uid</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Access Denied&#39;</span><span class="p">),</span>
                                 <span class="n">_</span><span class="p">(</span><span class="s">&#39;For this kind of document, you may only access records you created yourself.</span><span class="se">\n\n</span><span class="s">(Document type: </span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">,))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">where_clause</span><span class="p">,</span> <span class="n">where_params</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.rule&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">domain_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">where_clause</span><span class="p">:</span>
                <span class="n">where_clause</span> <span class="o">=</span> <span class="s">&#39; and &#39;</span> <span class="o">+</span> <span class="s">&#39; and &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">where_clause</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sub_ids</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SELECT &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="s">&#39;.id FROM &#39;</span> <span class="o">+</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span> <span class="o">+</span>
                               <span class="s">&#39; WHERE &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="s">&#39;.id IN </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">where_clause</span><span class="p">,</span>
                               <span class="p">[</span><span class="n">sub_ids</span><span class="p">]</span> <span class="o">+</span> <span class="n">where_params</span><span class="p">)</span>
                    <span class="n">returned_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_check_record_rules_result_count</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">sub_ids</span><span class="p">,</span> <span class="n">returned_ids</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_workflow_trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call given workflow trigger as a result of a CRUD operation&quot;&quot;&quot;</span>
        <span class="n">wf_service</span> <span class="o">=</span> <span class="n">netsvc</span><span class="o">.</span><span class="n">LocalService</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">res_id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">wf_service</span><span class="p">,</span> <span class="n">trigger</span><span class="p">)(</span><span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">cr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_workflow_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send given workflow signal and return a dict mapping ids to workflow results&quot;&quot;&quot;</span>
        <span class="n">wf_service</span> <span class="o">=</span> <span class="n">netsvc</span><span class="o">.</span><span class="n">LocalService</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">res_id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">res_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">wf_service</span><span class="o">.</span><span class="n">trg_validate</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">cr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="BaseModel.unlink"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.unlink">[docs]</a>    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete records with given ids</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param uid: current user id</span>
<span class="sd">        :param ids: id or list of ids</span>
<span class="sd">        :param context: (optional) context arguments, like lang, time zone</span>
<span class="sd">        :return: True</span>
<span class="sd">        :raise AccessError: * if user has no unlink rights on the requested object</span>
<span class="sd">                            * if user tries to bypass access rules for unlink on the requested object</span>
<span class="sd">        :raise UserError: if the record is default property for other records</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>

        <span class="n">result_store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_get_values</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_concurrency</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="s">&#39;unlink&#39;</span><span class="p">)</span>

        <span class="n">ir_property</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.property&#39;</span><span class="p">)</span>

        <span class="c"># Check if the records are used as default properties.</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;res_id&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span>
                  <span class="p">(</span><span class="s">&#39;value_reference&#39;</span><span class="p">,</span> <span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]),</span>
                 <span class="p">]</span>
        <span class="k">if</span> <span class="n">ir_property</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Error&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Unable to delete this document because it is used as a default property&#39;</span><span class="p">))</span>

        <span class="c"># Delete the records&#39; properties.</span>
        <span class="n">property_ids</span> <span class="o">=</span> <span class="n">ir_property</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;res_id&#39;</span><span class="p">,</span> <span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">])],</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="n">ir_property</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">property_ids</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_trigger</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="s">&#39;trg_delete&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rule</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="s">&#39;unlink&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="n">pool_model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.model.data&#39;</span><span class="p">)</span>
        <span class="n">ir_values_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.values&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sub_ids</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;delete from &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> \
                       <span class="s">&#39;where id IN </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">sub_ids</span><span class="p">,))</span>

            <span class="c"># Removing the ir_model_data reference if the record being deleted is a record created by xml/csv file,</span>
            <span class="c"># as these are not connected with real database foreign keys, and would be dangling references.</span>
            <span class="c"># Note: following steps performed as admin to avoid access rights restrictions, and with no context</span>
            <span class="c">#       to avoid possible side-effects during admin calls.</span>
            <span class="c"># Step 1. Calling unlink of ir_model_data only for the affected IDS</span>
            <span class="n">reference_ids</span> <span class="o">=</span> <span class="n">pool_model_data</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;res_id&#39;</span><span class="p">,</span><span class="s">&#39;in&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="n">sub_ids</span><span class="p">)),(</span><span class="s">&#39;model&#39;</span><span class="p">,</span><span class="s">&#39;=&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)])</span>
            <span class="c"># Step 2. Marching towards the real deletion of referenced records</span>
            <span class="k">if</span> <span class="n">reference_ids</span><span class="p">:</span>
                <span class="n">pool_model_data</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="n">reference_ids</span><span class="p">)</span>

            <span class="c"># For the same reason, removing the record relevant to ir_values</span>
            <span class="n">ir_value_ids</span> <span class="o">=</span> <span class="n">ir_values_obj</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span>
                    <span class="p">[</span><span class="s">&#39;|&#39;</span><span class="p">,(</span><span class="s">&#39;value&#39;</span><span class="p">,</span><span class="s">&#39;in&#39;</span><span class="p">,[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">sid</span><span class="p">)</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">sub_ids</span><span class="p">]),</span><span class="s">&#39;&amp;&#39;</span><span class="p">,(</span><span class="s">&#39;res_id&#39;</span><span class="p">,</span><span class="s">&#39;in&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="n">sub_ids</span><span class="p">)),(</span><span class="s">&#39;model&#39;</span><span class="p">,</span><span class="s">&#39;=&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)],</span>
                    <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ir_value_ids</span><span class="p">:</span>
                <span class="n">ir_values_obj</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ir_value_ids</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">order</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">store_ids</span><span class="p">,</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">result_store</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">object</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;select id from &#39;</span><span class="o">+</span><span class="n">obj</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; where id IN </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">store_ids</span><span class="p">),))</span>
                <span class="n">rids</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">rids</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">_store_set_values</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">rids</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">True</span>

    <span class="c">#</span>
    <span class="c"># TODO: Validate</span>
    <span class="c">#</span></div>
<div class="viewcode-block" id="BaseModel.write"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update records with given ids with the given field values</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param user: current user id</span>
<span class="sd">        :type user: integer</span>
<span class="sd">        :param ids: object id or list of object ids to update according to **vals**</span>
<span class="sd">        :param vals: field values to update, e.g {&#39;field_name&#39;: new_field_value, ...}</span>
<span class="sd">        :type vals: dictionary</span>
<span class="sd">        :param context: (optional) context arguments, e.g. {&#39;lang&#39;: &#39;en_us&#39;, &#39;tz&#39;: &#39;UTC&#39;, ...}</span>
<span class="sd">        :type context: dictionary</span>
<span class="sd">        :return: True</span>
<span class="sd">        :raise AccessError: * if user has no write rights on the requested object</span>
<span class="sd">                            * if user tries to bypass access rules for write on the requested object</span>
<span class="sd">        :raise ValidateError: if user tries to enter invalid value for a field that is not in selection</span>
<span class="sd">        :raise UserError: if a loop would be created in a hierarchy of objects a result of the operation (such as setting an object as its own parent)</span>

<span class="sd">        **Note**: The type of field values to pass in ``vals`` for relationship fields is specific:</span>

<span class="sd">            + For a many2many field, a list of tuples is expected.</span>
<span class="sd">              Here is the list of tuple that are accepted, with the corresponding semantics ::</span>

<span class="sd">                 (0, 0,  { values })    link to a new record that needs to be created with the given values dictionary</span>
<span class="sd">                 (1, ID, { values })    update the linked record with id = ID (write *values* on it)</span>
<span class="sd">                 (2, ID)                remove and delete the linked record with id = ID (calls unlink on ID, that will delete the object completely, and the link to it as well)</span>
<span class="sd">                 (3, ID)                cut the link to the linked record with id = ID (delete the relationship between the two objects but does not delete the target object itself)</span>
<span class="sd">                 (4, ID)                link to existing record with id = ID (adds a relationship)</span>
<span class="sd">                 (5)                    unlink all (like using (3,ID) for all linked records)</span>
<span class="sd">                 (6, 0, [IDs])          replace the list of linked IDs (like using (5) then (4,ID) for each ID in the list of IDs)</span>

<span class="sd">                 Example:</span>
<span class="sd">                    [(6, 0, [8, 5, 6, 4])] sets the many2many to ids [8, 5, 6, 4]</span>

<span class="sd">            + For a one2many field, a lits of tuples is expected.</span>
<span class="sd">              Here is the list of tuple that are accepted, with the corresponding semantics ::</span>

<span class="sd">                 (0, 0,  { values })    link to a new record that needs to be created with the given values dictionary</span>
<span class="sd">                 (1, ID, { values })    update the linked record with id = ID (write *values* on it)</span>
<span class="sd">                 (2, ID)                remove and delete the linked record with id = ID (calls unlink on ID, that will delete the object completely, and the link to it as well)</span>

<span class="sd">                 Example:</span>
<span class="sd">                    [(0, 0, {&#39;field_name&#39;:field_value_record1, ...}), (0, 0, {&#39;field_name&#39;:field_value_record2, ...})]</span>

<span class="sd">            + For a many2one field, simply use the ID of target record, which must already exist, or ``False`` to remove the link.</span>
<span class="sd">            + For a reference field, use a string with the model name, a comma, and the target object id (example: ``&#39;product.product, 5&#39;``)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">readonly</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_field_access_rights</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">,</span> <span class="n">vals</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
            <span class="n">fobj</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                <span class="n">fobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">:</span>
                <span class="n">fobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fobj</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">fobj</span><span class="o">.</span><span class="n">write</span>

            <span class="k">if</span> <span class="n">groups</span><span class="p">:</span>
                <span class="n">edit</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">grp</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select count(*) from res_groups_users_rel where gid IN (select res_id from ir_model_data where name=</span><span class="si">%s</span><span class="s"> and module=</span><span class="si">%s</span><span class="s"> and model=</span><span class="si">%s</span><span class="s">) and uid=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> \
                               <span class="p">(</span><span class="n">grp</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="s">&#39;res.groups&#39;</span><span class="p">,</span> <span class="n">user</span><span class="p">))</span>
                    <span class="n">readonly</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">readonly</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">edit</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">edit</span><span class="p">:</span>
                    <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_concurrency</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_get_values</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">vals</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">context</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="c"># No direct update of parent_left/right</span>
        <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;parent_left&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;parent_right&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">parents_changed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">parent_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_order</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">):</span>
            <span class="c"># The parent_left/right computation may take up to</span>
            <span class="c"># 5 seconds. No need to recompute the values if the</span>
            <span class="c"># parent is the same.</span>
            <span class="c"># Note: to respect parent_order, nodes must be processed in</span>
            <span class="c"># order, so ``parents_changed`` must be ordered properly.</span>
            <span class="n">parent_val</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">parent_val</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;SELECT id FROM </span><span class="si">%s</span><span class="s"> WHERE id IN </span><span class="si">%%</span><span class="s">s AND (</span><span class="si">%s</span><span class="s"> != </span><span class="si">%%</span><span class="s">s OR </span><span class="si">%s</span><span class="s"> IS NULL) ORDER BY </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">,</span> <span class="n">parent_order</span><span class="p">)</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">parent_val</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;SELECT id FROM </span><span class="si">%s</span><span class="s"> WHERE id IN </span><span class="si">%%</span><span class="s">s AND (</span><span class="si">%s</span><span class="s"> IS NOT NULL) ORDER BY </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">,</span> <span class="n">parent_order</span><span class="p">)</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ids</span><span class="p">),))</span>
            <span class="n">parents_changed</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

        <span class="n">upd0</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">upd1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">upd_todo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">updend</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">direct</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">totranslate</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lang&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s">&#39;lang&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;en_US&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
            <span class="n">field_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">.</span><span class="n">column</span>
            <span class="k">if</span> <span class="n">field_column</span> <span class="ow">and</span> <span class="n">field_column</span><span class="o">.</span><span class="n">deprecated</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Field </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s"> is deprecated: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_column</span><span class="o">.</span><span class="n">deprecated</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">_classic_write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="s">&#39;_fnct_inv&#39;</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">totranslate</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">translate</span><span class="p">:</span>
                        <span class="n">upd0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="o">+</span><span class="n">field</span><span class="o">+</span><span class="s">&#39;&quot;=&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">_symbol_set</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">upd1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">_symbol_set</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="p">]))</span>
                    <span class="n">direct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">upd_todo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> \
                    <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="s">&#39;selection&#39;</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_selection_field_value</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
            <span class="n">upd0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;write_uid=</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">upd0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;write_date=(now() at time zone &#39;UTC&#39;)&quot;</span><span class="p">)</span>
            <span class="n">upd1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">upd0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rule</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sub_ids</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;update &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="s">&#39; set &#39;</span> <span class="o">+</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upd0</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> \
                           <span class="s">&#39;where id IN </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">upd1</span> <span class="o">+</span> <span class="p">[</span><span class="n">sub_ids</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_ids</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;AccessError&#39;</span><span class="p">),</span>
                                     <span class="n">_</span><span class="p">(</span><span class="s">&#39;One of the records you are trying to modify has already been deleted (Document type: </span><span class="si">%s</span><span class="s">).&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">totranslate</span><span class="p">:</span>
                <span class="c"># TODO: optimize</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">direct</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">translate</span><span class="p">:</span>
                        <span class="n">src_trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="p">[</span><span class="n">f</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="n">f</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">src_trans</span><span class="p">:</span>
                            <span class="n">src_trans</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                            <span class="c"># Inserting value to DB</span>
                            <span class="n">context_wo_lang</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="n">vals</span><span class="p">[</span><span class="n">f</span><span class="p">]},</span> <span class="n">context</span><span class="o">=</span><span class="n">context_wo_lang</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.translation&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_set_ids</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;model&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;lang&#39;</span><span class="p">],</span> <span class="n">ids</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">src_trans</span><span class="p">)</span>


        <span class="c"># call the &#39;set&#39; method of fields which are not classic_write</span>
        <span class="n">upd_todo</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">priority</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">priority</span><span class="p">)</span>

        <span class="c"># default element in context must be removed when call a one2many or many2many</span>
        <span class="n">rel_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;default_&#39;</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">rel_context</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">upd_todo</span><span class="p">:</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">rel_context</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="n">unknown_fields</span> <span class="o">=</span> <span class="n">updend</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>
            <span class="n">nids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sub_ids</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;select distinct &quot;&#39;</span><span class="o">+</span><span class="n">col</span><span class="o">+</span><span class="s">&#39;&quot; from &quot;&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39;&quot; &#39;</span> \
                           <span class="s">&#39;where id IN </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">sub_ids</span><span class="p">,))</span>
                <span class="n">nids</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()])</span>

            <span class="n">v</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">updend</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">val</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">table</span><span class="p">:</span>
                    <span class="n">v</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>
                    <span class="n">unknown_fields</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">nids</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">unknown_fields</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s">&#39;No such field(s) in model </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">.&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unknown_fields</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="c"># TODO: use _order to set dest at the right position and not first node of parent</span>
        <span class="c"># We can&#39;t defer parent_store computation because the stored function</span>
        <span class="c"># fields that are computer may refer (directly or indirectly) to</span>
        <span class="c"># parent_left/right (via a child_of domain)</span>
        <span class="k">if</span> <span class="n">parents_changed</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_init</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_init_parent</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_order</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span>
                <span class="n">parent_val</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">parent_val</span><span class="p">:</span>
                    <span class="n">clause</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%%</span><span class="s">s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">,),</span> <span class="p">(</span><span class="n">parent_val</span><span class="p">,)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">clause</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> IS NULL&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">,),</span> <span class="p">()</span>

                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">parents_changed</span><span class="p">:</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SELECT parent_left, parent_right FROM </span><span class="si">%s</span><span class="s"> WHERE id=</span><span class="si">%%</span><span class="s">s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,),</span> <span class="p">(</span><span class="nb">id</span><span class="p">,))</span>
                    <span class="n">pleft</span><span class="p">,</span> <span class="n">pright</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="n">distance</span> <span class="o">=</span> <span class="n">pright</span> <span class="o">-</span> <span class="n">pleft</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="c"># Positions of current siblings, to locate proper insertion point;</span>
                    <span class="c"># this can _not_ be fetched outside the loop, as it needs to be refreshed</span>
                    <span class="c"># after each update, in case several nodes are sequentially inserted one</span>
                    <span class="c"># next to the other (i.e computed incrementally)</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SELECT parent_right, id FROM </span><span class="si">%s</span><span class="s"> WHERE </span><span class="si">%s</span><span class="s"> ORDER BY </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">clause</span><span class="p">,</span> <span class="n">parent_order</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
                    <span class="n">parents</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

                    <span class="c"># Find Position of the element</span>
                    <span class="n">position</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">parent_pright</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parent_id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">position</span> <span class="o">=</span> <span class="n">parent_pright</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="c"># It&#39;s the first node of the parent</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">position</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_val</span><span class="p">:</span>
                            <span class="n">position</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;select parent_left from &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; where id=</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">parent_val</span><span class="p">,))</span>
                            <span class="n">position</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">pleft</span> <span class="o">&lt;</span> <span class="n">position</span> <span class="o">&lt;=</span> <span class="n">pright</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;UserError&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Recursivity Detected.&#39;</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">pleft</span> <span class="o">&lt;</span> <span class="n">position</span><span class="p">:</span>
                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;update &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; set parent_left=parent_left+</span><span class="si">%s</span><span class="s"> where parent_left&gt;=</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">position</span><span class="p">))</span>
                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;update &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; set parent_right=parent_right+</span><span class="si">%s</span><span class="s"> where parent_right&gt;=</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">position</span><span class="p">))</span>
                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;update &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; set parent_left=parent_left+</span><span class="si">%s</span><span class="s">, parent_right=parent_right+</span><span class="si">%s</span><span class="s"> where parent_left&gt;=</span><span class="si">%s</span><span class="s"> and parent_left&lt;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">position</span><span class="o">-</span><span class="n">pleft</span><span class="p">,</span> <span class="n">position</span><span class="o">-</span><span class="n">pleft</span><span class="p">,</span> <span class="n">pleft</span><span class="p">,</span> <span class="n">pright</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;update &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; set parent_left=parent_left+</span><span class="si">%s</span><span class="s"> where parent_left&gt;=</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">position</span><span class="p">))</span>
                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;update &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; set parent_right=parent_right+</span><span class="si">%s</span><span class="s"> where parent_right&gt;=</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">position</span><span class="p">))</span>
                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;update &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; set parent_left=parent_left-</span><span class="si">%s</span><span class="s">, parent_right=parent_right-</span><span class="si">%s</span><span class="s"> where parent_left&gt;=</span><span class="si">%s</span><span class="s"> and parent_left&lt;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">pleft</span><span class="o">-</span><span class="n">position</span><span class="o">+</span><span class="n">distance</span><span class="p">,</span> <span class="n">pleft</span><span class="o">-</span><span class="n">position</span><span class="o">+</span><span class="n">distance</span><span class="p">,</span> <span class="n">pleft</span><span class="o">+</span><span class="n">distance</span><span class="p">,</span> <span class="n">pright</span><span class="o">+</span><span class="n">distance</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_get_values</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">vals</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">done</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">order</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">ids_to_update</span><span class="p">,</span> <span class="n">fields_to_recompute</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fields_to_recompute</span><span class="p">))</span>
            <span class="n">done</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span>
            <span class="c"># avoid to do several times the same computation</span>
            <span class="n">todo</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids_to_update</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">done</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">todo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span><span class="o">.</span><span class="n">_store_set_values</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">todo</span><span class="p">,</span> <span class="n">fields_to_recompute</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_trigger</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="s">&#39;trg_write&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c">#</span>
    <span class="c"># TODO: Should set perm to user.xxx</span>
    <span class="c">#</span></div>
<div class="viewcode-block" id="BaseModel.create"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new record for the model.</span>

<span class="sd">        The values for the new record are initialized using the ``vals``</span>
<span class="sd">        argument, and if necessary the result of ``default_get()``.</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param user: current user id</span>
<span class="sd">        :type user: integer</span>
<span class="sd">        :param vals: field values for new record, e.g {&#39;field_name&#39;: field_value, ...}</span>
<span class="sd">        :type vals: dictionary</span>
<span class="sd">        :param context: optional context arguments, e.g. {&#39;lang&#39;: &#39;en_us&#39;, &#39;tz&#39;: &#39;UTC&#39;, ...}</span>
<span class="sd">        :type context: dictionary</span>
<span class="sd">        :return: id of new record created</span>
<span class="sd">        :raise AccessError: * if user has no create rights on the requested object</span>
<span class="sd">                            * if user tries to bypass access rules for create on the requested object</span>
<span class="sd">        :raise ValidateError: if user tries to enter invalid value for a field that is not in selection</span>
<span class="sd">        :raise UserError: if a loop would be created in a hierarchy of objects a result of the operation (such as setting an object as its own parent)</span>

<span class="sd">        **Note**: The type of field values to pass in ``vals`` for relationship fields is specific.</span>
<span class="sd">        Please see the description of the :py:meth:`~osv.osv.osv.write` method for details about the possible values and how</span>
<span class="sd">        to specify them.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_transient</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transient_vacuum</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;create&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">LOG_ACCESS_COLUMNS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s">&#39;Field `</span><span class="si">%s</span><span class="s">` is not allowed when creating the model `</span><span class="si">%s</span><span class="s">`.&#39;</span><span class="p">,</span>
                        <span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_missing_default_values</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="n">tocreate</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                <span class="n">tocreate</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tocreate</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">vals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">[</span><span class="n">v</span><span class="p">]]}</span>
        <span class="p">(</span><span class="n">upd0</span><span class="p">,</span> <span class="n">upd1</span><span class="p">,</span> <span class="n">upd2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">upd_todo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unknown_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">col_detail</span><span class="p">,</span> <span class="n">original_parent</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">tocreate</span><span class="p">[</span><span class="n">table</span><span class="p">][</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">vals</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">vals</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                    <span class="n">unknown_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unknown_fields</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s">&#39;No such field(s) in model </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">.&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unknown_fields</span><span class="p">))</span>

        <span class="c"># Try-except added to filter the creation of those records whose filds are readonly.</span>
        <span class="c"># Example : any dashboard which has all the fields readonly.(due to Views(database views))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT nextval(&#39;&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">+</span><span class="s">&quot;&#39;)&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;UserError&#39;</span><span class="p">),</span>
                <span class="n">_</span><span class="p">(</span><span class="s">&#39;You cannot perform this operation. New Record Creation is not allowed for this object as this object is for reporting purpose.&#39;</span><span class="p">))</span>

        <span class="n">id_new</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tocreate</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">vals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">[</span><span class="n">table</span><span class="p">]]</span>

            <span class="n">record_id</span> <span class="o">=</span> <span class="n">tocreate</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            
            <span class="c"># When linking/creating parent records, force context without &#39;no_store_function&#39; key that</span>
            <span class="c"># defers stored functions computing, as these won&#39;t be computed in batch at the end of create(). </span>
            <span class="n">parent_context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="n">parent_context</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;no_store_function&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">record_id</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">record_id</span><span class="p">:</span>
                <span class="n">record_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">tocreate</span><span class="p">[</span><span class="n">table</span><span class="p">],</span> <span class="n">context</span><span class="o">=</span><span class="n">parent_context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="p">[</span><span class="n">record_id</span><span class="p">],</span> <span class="n">tocreate</span><span class="p">[</span><span class="n">table</span><span class="p">],</span> <span class="n">context</span><span class="o">=</span><span class="n">parent_context</span><span class="p">)</span>

            <span class="n">upd0</span> <span class="o">+=</span> <span class="s">&#39;,&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>
            <span class="n">upd1</span> <span class="o">+=</span> <span class="s">&#39;,</span><span class="si">%s</span><span class="s">&#39;</span>
            <span class="n">upd2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record_id</span><span class="p">)</span>

        <span class="c">#Start : Set bool fields to be False if they are not touched(to make search more powerful)</span>
        <span class="n">bool_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span><span class="o">==</span><span class="s">&#39;boolean&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">bool_field</span> <span class="ow">in</span> <span class="n">bool_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bool_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                <span class="n">vals</span><span class="p">[</span><span class="n">bool_field</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c">#End</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
            <span class="n">fobj</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                <span class="n">fobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fobj</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">fobj</span><span class="o">.</span><span class="n">write</span>
            <span class="k">if</span> <span class="n">groups</span><span class="p">:</span>
                <span class="n">edit</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">grp</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select count(*) from res_groups_users_rel where gid IN (select res_id from ir_model_data where name=&#39;</span><span class="si">%s</span><span class="s">&#39; and module=&#39;</span><span class="si">%s</span><span class="s">&#39; and model=&#39;</span><span class="si">%s</span><span class="s">&#39;) and uid=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                               <span class="p">(</span><span class="n">grp</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="s">&#39;res.groups&#39;</span><span class="p">,</span> <span class="n">user</span><span class="p">))</span>
                    <span class="n">readonly</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">readonly</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">edit</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="n">readonly</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">edit</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">edit</span> <span class="o">=</span> <span class="bp">False</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">edit</span><span class="p">:</span>
                    <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">_classic_write</span><span class="p">:</span>
                <span class="n">upd0</span> <span class="o">=</span> <span class="n">upd0</span> <span class="o">+</span> <span class="s">&#39;,&quot;&#39;</span> <span class="o">+</span> <span class="n">field</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span>
                <span class="n">upd1</span> <span class="o">=</span> <span class="n">upd1</span> <span class="o">+</span> <span class="s">&#39;,&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">_symbol_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">upd2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">_symbol_set</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="p">]))</span>
                <span class="c">#for the function fields that receive a value, we set them directly in the database </span>
                <span class="c">#(they may be required), but we also need to trigger the _fct_inv()</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="s">&#39;_fnct_inv&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">fields</span><span class="o">.</span><span class="n">related</span><span class="p">):</span>
                    <span class="c">#TODO: this way to special case the related fields is really creepy but it shouldn&#39;t be changed at</span>
                    <span class="c">#one week of the release candidate. It seems the only good way to handle correctly this is to add an</span>
                    <span class="c">#attribute to make a field `really readonly´ and thus totally ignored by the create()... otherwise</span>
                    <span class="c">#if, for example, the related has a default value (for usability) then the fct_inv is called and it</span>
                    <span class="c">#may raise some access rights error. Changing this is a too big change for now, and is thus postponed</span>
                    <span class="c">#after the release but, definitively, the behavior shouldn&#39;t be different for related and function</span>
                    <span class="c">#fields.</span>
                    <span class="n">upd_todo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">#TODO: this `if´ statement should be removed because there is no good reason to special case the fields</span>
                <span class="c">#related. See the above TODO comment for further explanations.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">fields</span><span class="o">.</span><span class="n">related</span><span class="p">):</span>
                    <span class="n">upd_todo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> \
                    <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="s">&#39;selection&#39;</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_selection_field_value</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
            <span class="n">upd0</span> <span class="o">+=</span> <span class="s">&#39;,create_uid,create_date,write_uid,write_date&#39;</span>
            <span class="n">upd1</span> <span class="o">+=</span> <span class="s">&quot;,</span><span class="si">%s</span><span class="s">,(now() at time zone &#39;UTC&#39;),</span><span class="si">%s</span><span class="s">,(now() at time zone &#39;UTC&#39;)&quot;</span>
            <span class="n">upd2</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">user</span><span class="p">,</span> <span class="n">user</span><span class="p">))</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;insert into &quot;&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39;&quot; (id&#39;</span><span class="o">+</span><span class="n">upd0</span><span class="o">+</span><span class="s">&quot;) values (&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">id_new</span><span class="p">)</span><span class="o">+</span><span class="n">upd1</span><span class="o">+</span><span class="s">&#39;)&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">upd2</span><span class="p">))</span>
        <span class="n">upd_todo</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">priority</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">priority</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;defer_parent_store_computation&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_init</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_init_parent</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;select parent_right from &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; where &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="o">+</span><span class="s">&#39;=</span><span class="si">%s</span><span class="s"> order by &#39;</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_order</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span><span class="p">),</span> <span class="p">(</span><span class="n">parent</span><span class="p">,))</span>
                    <span class="n">pleft_old</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">result_p</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">pleft</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">result_p</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">pleft</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">pleft_old</span> <span class="o">=</span> <span class="n">pleft</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pleft_old</span><span class="p">:</span>
                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;select parent_left from &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; where id=</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">parent</span><span class="p">,))</span>
                        <span class="n">pleft_old</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">pleft</span> <span class="o">=</span> <span class="n">pleft_old</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;select max(parent_right) from &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
                    <span class="n">pleft</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;update &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; set parent_left=parent_left+2 where parent_left&gt;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">pleft</span><span class="p">,))</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;update &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; set parent_right=parent_right+2 where parent_right&gt;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">pleft</span><span class="p">,))</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;update &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; set parent_left=</span><span class="si">%s</span><span class="s">,parent_right=</span><span class="si">%s</span><span class="s"> where id=</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">pleft</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">pleft</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">id_new</span><span class="p">))</span>

        <span class="c"># default element in context must be remove when call a one2many or many2many</span>
        <span class="n">rel_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;default_&#39;</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">rel_context</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">upd_todo</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">id_new</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">user</span><span class="p">,</span> <span class="n">rel_context</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="p">[</span><span class="n">id_new</span><span class="p">],</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;no_store_function&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_get_values</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="p">[</span><span class="n">id_new</span><span class="p">],</span>
                <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span>
                <span class="n">context</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">done</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">order</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">fields2</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">fields2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span><span class="o">.</span><span class="n">_store_set_values</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">fields2</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                    <span class="n">done</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">object</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">fields2</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_create</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">context</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;no_store_function&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">+</span> \
                <span class="s">&quot; &#39;&quot;</span> <span class="o">+</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">name_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="p">[</span><span class="n">id_new</span><span class="p">],</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                <span class="s">&quot;&#39; &quot;</span> <span class="o">+</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;created.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">id_new</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rule</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="p">[</span><span class="n">id_new</span><span class="p">],</span> <span class="s">&#39;create&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_trigger</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="p">[</span><span class="n">id_new</span><span class="p">],</span> <span class="s">&#39;trg_create&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">id_new</span>
</div>
<div class="viewcode-block" id="BaseModel.browse"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.browse">[docs]</a>    <span class="k">def</span> <span class="nf">browse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">list_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fields_process</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch records as objects allowing to use dot notation to browse fields and relations</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param uid: current user id</span>
<span class="sd">        :param select: id or list of ids.</span>
<span class="sd">        :param context: context arguments, like lang, time zone</span>
<span class="sd">        :rtype: object or list of objects requested</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_list_class</span> <span class="o">=</span> <span class="n">list_class</span> <span class="ow">or</span> <span class="n">browse_record_list</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># need to accepts ints and longs because ids coming from a method</span>
        <span class="c"># launched by button in the interface have a type long...</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">browse_record</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">list_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_list_class</span><span class="p">,</span> <span class="n">fields_process</span><span class="o">=</span><span class="n">fields_process</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_class</span><span class="p">([</span><span class="n">browse_record</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">list_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_list_class</span><span class="p">,</span> <span class="n">fields_process</span><span class="o">=</span><span class="n">fields_process</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">select</span><span class="p">],</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">browse_null</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_store_get_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an ordered list of fields.functions to call due to</span>
<span class="sd">           an update operation on ``fields`` of records with ``ids``,</span>
<span class="sd">           obtained by calling the &#39;store&#39; functions of these fields,</span>
<span class="sd">           as setup by their &#39;store&#39; attribute.</span>

<span class="sd">           :return: [(priority, model_name, [record_ids,], [function_fields,])]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fields</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stored_functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_store_function</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c"># use indexed names for the details of the stored_functions:</span>
        <span class="n">model_name_</span><span class="p">,</span> <span class="n">func_field_to_compute_</span><span class="p">,</span> <span class="n">id_mapping_fnct_</span><span class="p">,</span> <span class="n">trigger_fields_</span><span class="p">,</span> <span class="n">priority_</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="c"># only keep functions that should be triggered for the ``fields``</span>
        <span class="c"># being written to.</span>
        <span class="n">to_compute</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">stored_functions</span> \
                <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">f</span><span class="p">[</span><span class="n">trigger_fields_</span><span class="p">])</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">trigger_fields_</span><span class="p">]))]</span>

        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fresults</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">to_compute</span><span class="p">:</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">function</span><span class="p">[</span><span class="n">id_mapping_fnct_</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fid</span> <span class="ow">in</span> <span class="n">fresults</span><span class="p">:</span>
                <span class="c"># use admin user for accessing objects having rules defined on store fields</span>
                <span class="n">fresults</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">id2</span> <span class="k">for</span> <span class="n">id2</span> <span class="ow">in</span> <span class="n">function</span><span class="p">[</span><span class="n">id_mapping_fnct_</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="k">if</span> <span class="n">id2</span><span class="p">]</span>
            <span class="n">target_ids</span> <span class="o">=</span> <span class="n">fresults</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span>

            <span class="c"># the compound key must consider the priority and model name</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">function</span><span class="p">[</span><span class="n">priority_</span><span class="p">],</span> <span class="n">function</span><span class="p">[</span><span class="n">model_name_</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">target_id</span> <span class="ow">in</span> <span class="n">target_ids</span><span class="p">:</span>
                <span class="n">mapping</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">target_id</span><span class="p">,</span><span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">function</span><span class="p">))</span>

        <span class="c"># Here mapping looks like:</span>
        <span class="c"># { (10, &#39;model_a&#39;) : { target_id1: [ (function_1_tuple, function_2_tuple) ], ... }</span>
        <span class="c">#   (20, &#39;model_a&#39;) : { target_id2: [ (function_3_tuple, function_4_tuple) ], ... }</span>
        <span class="c">#   (99, &#39;model_a&#39;) : { target_id1: [ (function_5_tuple, function_6_tuple) ], ... }</span>
        <span class="c"># }</span>

        <span class="c"># Now we need to generate the batch function calls list</span>
        <span class="c"># call_map =</span>
        <span class="c">#   { (10, &#39;model_a&#39;) : [(10, &#39;model_a&#39;, [record_ids,], [function_fields,])] }</span>
        <span class="n">call_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="p">((</span><span class="n">priority</span><span class="p">,</span><span class="n">model</span><span class="p">),</span> <span class="n">id_map</span><span class="p">)</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">functions_ids_maps</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># function_ids_maps =</span>
            <span class="c">#   { (function_1_tuple, function_2_tuple) : [target_id1, target_id2, ..] }</span>
            <span class="k">for</span> <span class="n">fid</span><span class="p">,</span> <span class="n">functions</span> <span class="ow">in</span> <span class="n">id_map</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">functions_ids_maps</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">functions</span><span class="p">),</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">functions</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">functions_ids_maps</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">call_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">((</span><span class="n">priority</span><span class="p">,</span><span class="n">model</span><span class="p">),[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">priority</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span>
                                                                 <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="n">func_field_to_compute_</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">]))</span>
        <span class="n">ordered_keys</span> <span class="o">=</span> <span class="n">call_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">ordered_keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ordered_keys</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="p">(</span><span class="n">call_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ordered_keys</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_store_set_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calls the fields.function&#39;s &quot;implementation function&quot; for all ``fields``, on records with ``ids`` (taking care of</span>
<span class="sd">           respecting ``multi`` attributes), and stores the resulting values in the database directly.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">field_flag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">field_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;select id,write_date from &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">+</span><span class="s">&#39; where id IN </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ids</span><span class="p">),))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">field_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[])</span>
                    <span class="n">res_date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">((</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:</span><span class="mi">19</span><span class="p">],</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">)</span>
                    <span class="n">write_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">res_date</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_store_function</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="p">[]):</span>
                        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span>
                            <span class="n">up_write_date</span> <span class="o">=</span> <span class="n">write_date</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">up_write_date</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                                    <span class="n">field_dict</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">field_flag</span><span class="p">:</span>
                                        <span class="n">field_flag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">_multi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">_multi</span><span class="p">)</span>
            <span class="n">todo</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">_multi</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">todo</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">_multi</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">todo</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
                <span class="c"># use admin user for accessing objects having rules defined on store fields</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
                <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">field_flag</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">field_dict</span><span class="p">[</span><span class="nb">id</span><span class="p">]:</span>
                                <span class="n">value</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">upd0</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">upd1</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2one&#39;</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">value</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="n">upd0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s">&#39;&quot;=&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">_symbol_set</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">upd1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">_symbol_set</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">value</span><span class="p">[</span><span class="n">v</span><span class="p">]))</span>
                    <span class="n">upd1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">upd0</span> <span class="ow">and</span> <span class="n">upd1</span><span class="p">:</span>
                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;update &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="s">&#39;&quot; set &#39;</span> <span class="o">+</span> \
                            <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upd0</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; where id = </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">upd1</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                    <span class="c"># use admin user for accessing objects having rules defined on store fields</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">field_flag</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">field_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">field_dict</span><span class="p">[</span><span class="n">r</span><span class="p">]:</span>
                                    <span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2one&#39;</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;update &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="s">&#39;&quot; set &#39;</span> <span class="o">+</span> \
                            <span class="s">&#39;&quot;&#39;</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="s">&#39;&quot;=&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">_symbol_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; where id = </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">_symbol_set</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">value</span><span class="p">),</span> <span class="nb">id</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c">#</span>
    <span class="c"># TODO: Validate</span>
    <span class="c">#</span>
<div class="viewcode-block" id="BaseModel.perm_write"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.perm_write">[docs]</a>    <span class="k">def</span> <span class="nf">perm_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;This method does not exist anymore&#39;</span><span class="p">))</span>

    <span class="c"># TODO: ameliorer avec NULL</span></div>
    <span class="k">def</span> <span class="nf">_where_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">active_test</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the WHERE clause needed to implement an OpenERP domain.</span>
<span class="sd">        :param domain: the domain to compute</span>
<span class="sd">        :type domain: list</span>
<span class="sd">        :param active_test: whether the default filtering of records with ``active``</span>
<span class="sd">                            field set to ``False`` should be applied.</span>
<span class="sd">        :return: the query expressing the given domain as provided in domain</span>
<span class="sd">        :rtype: osv.query.Query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="p">[:]</span>
        <span class="c"># if the object has a field named &#39;active&#39;, filter out all inactive</span>
        <span class="c"># records unless they were explicitely asked for</span>
        <span class="k">if</span> <span class="s">&#39;active&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span> <span class="ow">and</span> <span class="p">(</span><span class="n">active_test</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;active_test&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">domain</span><span class="p">:</span>
                <span class="c"># the item[0] trick below works for domain items and &#39;&amp;&#39;/&#39;|&#39;/&#39;!&#39;</span>
                <span class="c"># operators too</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;active&#39;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">domain</span><span class="p">):</span>
                    <span class="n">domain</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;active&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;active&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">domain</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">get_tables</span><span class="p">()</span>
            <span class="n">where_clause</span><span class="p">,</span> <span class="n">where_params</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">to_sql</span><span class="p">()</span>
            <span class="n">where_clause</span> <span class="o">=</span> <span class="n">where_clause</span> <span class="ow">and</span> <span class="p">[</span><span class="n">where_clause</span><span class="p">]</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">where_clause</span><span class="p">,</span> <span class="n">where_params</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[</span><span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">Query</span><span class="p">(</span><span class="n">tables</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">where_params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_qorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">regex_order</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">except_orm</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;AccessError&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Invalid &quot;order&quot; specified. A valid &quot;order&quot; specification is a comma-separated list of valid field names (optionally followed by asc/desc for the direction)&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_apply_ir_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add what&#39;s missing in ``query`` to implement all appropriate ir.rules</span>
<span class="sd">          (using the ``model_name``&#39;s rules or the current model&#39;s rules if ``model_name`` is None)</span>

<span class="sd">           :param query: the current query object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="n">SUPERUSER_ID</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">apply_rule</span><span class="p">(</span><span class="n">added_clause</span><span class="p">,</span> <span class="n">added_params</span><span class="p">,</span> <span class="n">added_tables</span><span class="p">,</span> <span class="n">parent_model</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">child_object</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; :param string parent_model: string of the parent model</span>
<span class="sd">                :param model child_object: model object, base of the rule application</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">added_clause</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">parent_model</span> <span class="ow">and</span> <span class="n">child_object</span><span class="p">:</span>
                    <span class="c"># as inherited rules are being applied, we need to add the missing JOIN</span>
                    <span class="c"># to reach the parent table (if it was not JOINed yet in the query)</span>
                    <span class="n">parent_alias</span> <span class="o">=</span> <span class="n">child_object</span><span class="o">.</span><span class="n">_inherits_join_add</span><span class="p">(</span><span class="n">child_object</span><span class="p">,</span> <span class="n">parent_model</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
                    <span class="c"># inherited rules are applied on the external table -&gt; need to get the alias and replace</span>
                    <span class="n">parent_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_model</span><span class="p">)</span><span class="o">.</span><span class="n">_table</span>
                    <span class="n">added_clause</span> <span class="o">=</span> <span class="p">[</span><span class="n">clause</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">parent_table</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">parent_alias</span><span class="p">)</span> <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">added_clause</span><span class="p">]</span>
                    <span class="c"># change references to parent_table to parent_alias, because we now use the alias to refer to the table</span>
                    <span class="n">new_tables</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">added_tables</span><span class="p">:</span>
                        <span class="c"># table is just a table name -&gt; switch to the full alias</span>
                        <span class="k">if</span> <span class="n">table</span> <span class="o">==</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">parent_table</span><span class="p">:</span>
                            <span class="n">new_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot; as &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_table</span><span class="p">,</span> <span class="n">parent_alias</span><span class="p">))</span>
                        <span class="c"># table is already a full statement -&gt; replace reference to the table to its alias, is correct with the way aliases are generated</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">parent_table</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">parent_alias</span><span class="p">))</span>
                    <span class="n">added_tables</span> <span class="o">=</span> <span class="n">new_tables</span>
                <span class="n">query</span><span class="o">.</span><span class="n">where_clause</span> <span class="o">+=</span> <span class="n">added_clause</span>
                <span class="n">query</span><span class="o">.</span><span class="n">where_clause_params</span> <span class="o">+=</span> <span class="n">added_params</span>
                <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">added_tables</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
                        <span class="n">query</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># apply main rules on the object</span>
        <span class="n">rule_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.rule&#39;</span><span class="p">)</span>
        <span class="n">rule_where_clause</span><span class="p">,</span> <span class="n">rule_where_clause_params</span><span class="p">,</span> <span class="n">rule_tables</span> <span class="o">=</span> <span class="n">rule_obj</span><span class="o">.</span><span class="n">domain_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="n">apply_rule</span><span class="p">(</span><span class="n">rule_where_clause</span><span class="p">,</span> <span class="n">rule_where_clause_params</span><span class="p">,</span> <span class="n">rule_tables</span><span class="p">)</span>

        <span class="c"># apply ir.rules from the parents (through _inherits)</span>
        <span class="k">for</span> <span class="n">inherited_model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
            <span class="n">rule_where_clause</span><span class="p">,</span> <span class="n">rule_where_clause_params</span><span class="p">,</span> <span class="n">rule_tables</span> <span class="o">=</span> <span class="n">rule_obj</span><span class="o">.</span><span class="n">domain_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">inherited_model</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
            <span class="n">apply_rule</span><span class="p">(</span><span class="n">rule_where_clause</span><span class="p">,</span> <span class="n">rule_where_clause_params</span><span class="p">,</span> <span class="n">rule_tables</span><span class="p">,</span>
                        <span class="n">parent_model</span><span class="o">=</span><span class="n">inherited_model</span><span class="p">,</span> <span class="n">child_object</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_m2o_order_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_field</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add possibly missing JOIN to ``query`` and generate the ORDER BY clause for m2o fields,</span>
<span class="sd">        either native m2o fields or function/related fields that are stored, including</span>
<span class="sd">        intermediate JOINs for inheritance if required.</span>

<span class="sd">        :return: the qualified field name to use in an ORDER BY clause to sort by ``order_field``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">order_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="ow">and</span> <span class="n">order_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">:</span>
            <span class="c"># also add missing joins for reaching the table containing the m2o field</span>
            <span class="n">qualified_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_join_calc</span><span class="p">(</span><span class="n">order_field</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">order_field_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">order_field</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qualified_field</span> <span class="o">=</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;.&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">order_field</span><span class="p">)</span>
            <span class="n">order_field_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">order_field</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">order_field_column</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2one&#39;</span><span class="p">,</span> <span class="s">&#39;Invalid field passed to _generate_m2o_order_by()&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">order_field_column</span><span class="o">.</span><span class="n">_classic_write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">order_field_column</span><span class="p">,</span> <span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Many2one function/related fields must be stored &quot;</span> \
                <span class="s">&quot;to be used as ordering fields! Ignoring sorting for </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">order_field</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># figure out the applicable order_by for the m2o</span>
        <span class="n">dest_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">order_field_column</span><span class="o">.</span><span class="n">_obj</span><span class="p">)</span>
        <span class="n">m2o_order</span> <span class="o">=</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">_order</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">regex_order</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">m2o_order</span><span class="p">):</span>
            <span class="c"># _order is complex, can&#39;t use it here, so we default to _rec_name</span>
            <span class="n">m2o_order</span> <span class="o">=</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">_rec_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># extract the field names, to be able to qualify them and add desc/asc</span>
            <span class="n">m2o_order_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">order_part</span> <span class="ow">in</span> <span class="n">m2o_order</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">):</span>
                <span class="n">m2o_order_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order_part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">m2o_order</span> <span class="o">=</span> <span class="n">m2o_order_list</span>

        <span class="c"># Join the dest m2o table if it&#39;s not joined yet. We use [LEFT] OUTER join here</span>
        <span class="c"># as we don&#39;t want to exclude results that have NULL values for the m2o</span>
        <span class="n">src_table</span><span class="p">,</span> <span class="n">src_field</span> <span class="o">=</span> <span class="n">qualified_field</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dst_alias</span><span class="p">,</span> <span class="n">dst_alias_statement</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">add_join</span><span class="p">((</span><span class="n">src_table</span><span class="p">,</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">src_field</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">src_field</span><span class="p">),</span> <span class="n">implicit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">outer</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">qualify</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">field</span><span class="p">:</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;.&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dst_alias</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="n">qualify</span><span class="p">,</span> <span class="n">m2o_order</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m2o_order</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">qualify</span><span class="p">(</span><span class="n">m2o_order</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_order_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_spec</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempt to consruct an appropriate ORDER BY clause based on order_spec, which must be</span>
<span class="sd">        a comma-separated list of valid field names, optionally followed by an ASC or DESC direction.</span>

<span class="sd">        :raise&quot; except_orm in case order_spec is malformed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order_by_clause</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">order_spec</span> <span class="o">=</span> <span class="n">order_spec</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span>
        <span class="k">if</span> <span class="n">order_spec</span><span class="p">:</span>
            <span class="n">order_by_elements</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_qorder</span><span class="p">(</span><span class="n">order_spec</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">order_part</span> <span class="ow">in</span> <span class="n">order_spec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
                <span class="n">order_split</span> <span class="o">=</span> <span class="n">order_part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
                <span class="n">order_field</span> <span class="o">=</span> <span class="n">order_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">order_direction</span> <span class="o">=</span> <span class="n">order_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">order_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
                <span class="n">inner_clause</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">order_field</span> <span class="o">==</span> <span class="s">&#39;id&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span> <span class="ow">and</span> <span class="n">order_field</span> <span class="ow">in</span> <span class="n">LOG_ACCESS_COLUMNS</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">order_by_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;.&quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">order_field</span><span class="p">,</span> <span class="n">order_direction</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">order_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                    <span class="n">order_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">order_field</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">order_column</span><span class="o">.</span><span class="n">_classic_read</span><span class="p">:</span>
                        <span class="n">inner_clause</span> <span class="o">=</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;.&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">order_field</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">order_column</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2one&#39;</span><span class="p">:</span>
                        <span class="n">inner_clause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_m2o_order_by</span><span class="p">(</span><span class="n">order_field</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>  <span class="c"># ignore non-readable or &quot;non-joinable&quot; fields</span>
                <span class="k">elif</span> <span class="n">order_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">:</span>
                    <span class="n">parent_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">order_field</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">order_column</span> <span class="o">=</span> <span class="n">parent_obj</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">order_field</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">order_column</span><span class="o">.</span><span class="n">_classic_read</span><span class="p">:</span>
                        <span class="n">inner_clause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_join_calc</span><span class="p">(</span><span class="n">order_field</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">order_column</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2one&#39;</span><span class="p">:</span>
                        <span class="n">inner_clause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_m2o_order_by</span><span class="p">(</span><span class="n">order_field</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>  <span class="c"># ignore non-readable or &quot;non-joinable&quot; fields</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Sorting field </span><span class="si">%s</span><span class="s"> not found on model </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span><span class="p">(</span> <span class="n">order_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">inner_clause</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inner_clause</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">inner_clause</span><span class="p">:</span>
                            <span class="n">order_by_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">clause</span><span class="p">,</span> <span class="n">order_direction</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">order_by_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">inner_clause</span><span class="p">,</span> <span class="n">order_direction</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">order_by_elements</span><span class="p">:</span>
                <span class="n">order_by_clause</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_by_elements</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">order_by_clause</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39; ORDER BY </span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="n">order_by_clause</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">access_rights_uid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private implementation of search() method, allowing specifying the uid to use for the access right check.</span>
<span class="sd">        This is useful for example when filling in the selection list for a drop-down and avoiding access rights errors,</span>
<span class="sd">        by specifying ``access_rights_uid=1`` to bypass access rights check, but not ir.rules!</span>
<span class="sd">        This is ok at the security level because this method is private and not callable through XML-RPC.</span>

<span class="sd">        :param access_rights_uid: optional user ID to use when checking access rights</span>
<span class="sd">                                  (not for ir.rules, this is only for ir.model.access)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">access_rights_uid</span> <span class="ow">or</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">)</span>

        <span class="c"># For transient models, restrict acces to the current user, except for the super-user</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_transient</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span> <span class="ow">and</span> <span class="n">user</span> <span class="o">!=</span> <span class="n">SUPERUSER_ID</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">(([(</span><span class="s">&#39;create_uid&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">user</span><span class="p">)],</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>

        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where_calc</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_ir_rules</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="n">order_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_order_by</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">from_clause</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">where_clause_params</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">get_sql</span><span class="p">()</span>

        <span class="n">limit_str</span> <span class="o">=</span> <span class="n">limit</span> <span class="ow">and</span> <span class="s">&#39; limit </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">limit</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">offset_str</span> <span class="o">=</span> <span class="n">offset</span> <span class="ow">and</span> <span class="s">&#39; offset </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">offset</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">where_str</span> <span class="o">=</span> <span class="n">where_clause</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&quot; WHERE </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">where_clause</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SELECT count(&quot;</span><span class="si">%s</span><span class="s">&quot;.id) FROM &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="n">from_clause</span> <span class="o">+</span> <span class="n">where_str</span> <span class="o">+</span> <span class="n">limit_str</span> <span class="o">+</span> <span class="n">offset_str</span><span class="p">,</span> <span class="n">where_clause_params</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SELECT &quot;</span><span class="si">%s</span><span class="s">&quot;.id FROM &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="n">from_clause</span> <span class="o">+</span> <span class="n">where_str</span> <span class="o">+</span> <span class="n">order_by</span> <span class="o">+</span> <span class="n">limit_str</span> <span class="o">+</span> <span class="n">offset_str</span><span class="p">,</span> <span class="n">where_clause_params</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c"># TDE note: with auto_join, we could have several lines about the same result</span>
        <span class="c"># i.e. a lead with several unread messages; we uniquify the result using</span>
        <span class="c"># a fast way to do it while preserving order (http://www.peterbe.com/plog/uniqifiers-benchmark)</span>
        <span class="k">def</span> <span class="nf">_uniquify_list</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seq</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">_uniquify_list</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">])</span>

    <span class="c"># returns the different values ever entered for one field</span>
    <span class="c"># this is used, for example, in the client when the user hits enter on</span>
    <span class="c"># a char field</span>
<div class="viewcode-block" id="BaseModel.distinct_field_get"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.distinct_field_get">[docs]</a>    <span class="k">def</span> <span class="nf">distinct_field_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">distinct_field_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">uid</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BaseModel.copy_data"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.copy_data">[docs]</a>    <span class="k">def</span> <span class="nf">copy_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy given record&#39;s data with all its fields values</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param uid: current user id</span>
<span class="sd">        :param id: id of the record to copy</span>
<span class="sd">        :param default: field values to override in the original values of the copied record</span>
<span class="sd">        :type default: dictionary</span>
<span class="sd">        :param context: context arguments, like lang, time zone</span>
<span class="sd">        :type context: dictionary</span>
<span class="sd">        :return: dictionary containing all the field values</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># avoid recursion through already copied records in case of circular relationship</span>
        <span class="n">seen_map</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;__copy_data_seen&#39;</span><span class="p">,{})</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">seen_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,[]):</span>
            <span class="k">return</span>
        <span class="n">seen_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s">&#39;state&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;state&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">[</span><span class="s">&#39;state&#39;</span><span class="p">]):</span>
                    <span class="n">default</span><span class="p">[</span><span class="s">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">[</span><span class="s">&#39;state&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">default</span><span class="p">[</span><span class="s">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span><span class="p">[</span><span class="s">&#39;state&#39;</span><span class="p">]</span>

        <span class="c"># build a black list of fields that should not be copied</span>
        <span class="n">blacklist</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">MAGIC_COLUMNS</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;parent_left&#39;</span><span class="p">,</span> <span class="s">&#39;parent_right&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">blacklist_given_fields</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="c"># blacklist the fields that are given by inheritance</span>
            <span class="k">for</span> <span class="n">other</span><span class="p">,</span> <span class="n">field_to_other</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">blacklist</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field_to_other</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field_to_other</span> <span class="ow">in</span> <span class="n">default</span><span class="p">:</span>
                    <span class="c"># all the fields of &#39;other&#39; are given by the record: default[field_to_other],</span>
                    <span class="c"># except the ones redefined in self</span>
                    <span class="n">blacklist</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="o">.</span><span class="n">_all_columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">blacklist_given_fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
        <span class="n">blacklist_given_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


        <span class="n">fields_to_copy</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">f</span><span class="p">,</span><span class="n">fi</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">fi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
                                     <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default</span>
                                     <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">blacklist</span>
                                     <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fi</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">function</span><span class="p">))</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">[</span><span class="nb">id</span><span class="p">],</span> <span class="n">fields_to_copy</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Record #</span><span class="si">%d</span><span class="s"> of </span><span class="si">%s</span><span class="s"> not found, cannot copy!&quot;</span><span class="p">)</span> <span class="o">%</span><span class="p">(</span> <span class="nb">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">colinfo</span> <span class="ow">in</span> <span class="n">fields_to_copy</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">colinfo</span><span class="o">.</span><span class="n">column</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2one&#39;</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;one2many&#39;</span><span class="p">:</span>
                <span class="n">other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">_obj</span><span class="p">)</span>
                <span class="c"># duplicate following the order of the ids because we&#39;ll rely on</span>
                <span class="c"># it later for copying translations in copy_translation()!</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">other</span><span class="o">.</span><span class="n">copy_data</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">line_id</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span> <span class="k">for</span> <span class="n">line_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">f</span><span class="p">])]</span>
                <span class="c"># the lines are duplicated using the wrong (old) parent, but then</span>
                <span class="c"># are reassigned to the correct one thanks to the (0, 0, ...)</span>
                <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2many&#39;</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">f</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">res</span>
</div>
<div class="viewcode-block" id="BaseModel.copy_translations"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.copy_translations">[docs]</a>    <span class="k">def</span> <span class="nf">copy_translations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">old_id</span><span class="p">,</span> <span class="n">new_id</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># avoid recursion through already copied records in case of circular relationship</span>
        <span class="n">seen_map</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;__copy_translations_seen&#39;</span><span class="p">,{})</span>
        <span class="k">if</span> <span class="n">old_id</span> <span class="ow">in</span> <span class="n">seen_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,[]):</span>
            <span class="k">return</span>
        <span class="n">seen_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">old_id</span><span class="p">)</span>

        <span class="n">trans_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.translation&#39;</span><span class="p">)</span>
        <span class="c"># TODO it seems fields_get can be replaced by _all_columns (no need for translation)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_get</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_def</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c"># removing the lang to compare untranslated values</span>
            <span class="n">context_wo_lang</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">old_record</span><span class="p">,</span> <span class="n">new_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">[</span><span class="n">old_id</span><span class="p">,</span> <span class="n">new_id</span><span class="p">],</span> <span class="n">context</span><span class="o">=</span><span class="n">context_wo_lang</span><span class="p">)</span>
            <span class="c"># we must recursively copy the translations for o2o and o2m</span>
            <span class="k">if</span> <span class="n">field_def</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;one2many&#39;</span><span class="p">:</span>
                <span class="n">target_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_def</span><span class="p">[</span><span class="s">&#39;relation&#39;</span><span class="p">])</span>
                <span class="c"># here we rely on the order of the ids to match the translations</span>
                <span class="c"># as foreseen in copy_data()</span>
                <span class="n">old_children</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">old_record</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
                <span class="n">new_children</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">new_record</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">old_child</span><span class="p">,</span> <span class="n">new_child</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old_children</span><span class="p">,</span> <span class="n">new_children</span><span class="p">):</span>
                    <span class="n">target_obj</span><span class="o">.</span><span class="n">copy_translations</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">old_child</span><span class="p">,</span> <span class="n">new_child</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
            <span class="c"># and for translatable fields we keep them for copy</span>
            <span class="k">elif</span> <span class="n">field_def</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;translate&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                    <span class="n">trans_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">field_name</span>
                    <span class="n">target_id</span> <span class="o">=</span> <span class="n">new_id</span>
                    <span class="n">source_id</span> <span class="o">=</span> <span class="n">old_id</span>
                <span class="k">elif</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">:</span>
                    <span class="n">trans_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">field_name</span>
                    <span class="c"># get the id of the parent record to set the translation</span>
                    <span class="n">inherit_field_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">target_id</span> <span class="o">=</span> <span class="n">new_record</span><span class="p">[</span><span class="n">inherit_field_name</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
                    <span class="n">source_id</span> <span class="o">=</span> <span class="n">old_record</span><span class="p">[</span><span class="n">inherit_field_name</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">trans_ids</span> <span class="o">=</span> <span class="n">trans_obj</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">[</span>
                        <span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">trans_name</span><span class="p">),</span>
                        <span class="p">(</span><span class="s">&#39;res_id&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">source_id</span><span class="p">)</span>
                <span class="p">])</span>
                <span class="n">user_lang</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lang&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">trans_obj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">trans_ids</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">record</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
                    <span class="c"># remove source to avoid triggering _set_src</span>
                    <span class="k">del</span> <span class="n">record</span><span class="p">[</span><span class="s">&#39;source&#39;</span><span class="p">]</span>
                    <span class="n">record</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;res_id&#39;</span><span class="p">:</span> <span class="n">target_id</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">user_lang</span> <span class="ow">and</span> <span class="n">user_lang</span> <span class="o">==</span> <span class="n">record</span><span class="p">[</span><span class="s">&#39;lang&#39;</span><span class="p">]:</span>
                        <span class="c"># &#39;source&#39; to force the call to _set_src</span>
                        <span class="c"># &#39;value&#39; needed if value is changed in copy(), want to see the new_value</span>
                        <span class="n">record</span><span class="p">[</span><span class="s">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_record</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                        <span class="n">record</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_record</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                    <span class="n">trans_obj</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="BaseModel.copy"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Duplicate record with given id updating it with default values</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param uid: current user id</span>
<span class="sd">        :param id: id of the record to copy</span>
<span class="sd">        :param default: dictionary of field values to override in the original values of the copied record, e.g: ``{&#39;field_name&#39;: overriden_value, ...}``</span>
<span class="sd">        :type default: dictionary</span>
<span class="sd">        :param context: context arguments, like lang, time zone</span>
<span class="sd">        :type context: dictionary</span>
<span class="sd">        :return: id of the newly created record</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_data</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">new_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_translations</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">new_id</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_id</span>
</div>
<div class="viewcode-block" id="BaseModel.exists"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.exists">[docs]</a>    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks whether the given id or ids exist in this model,</span>
<span class="sd">           and return the list of ids that do. This is simple to use for</span>
<span class="sd">           a truth test on a browse_record::</span>

<span class="sd">               if record.exists():</span>
<span class="sd">                   pass</span>

<span class="sd">           :param ids: id or list of ids to check for existence</span>
<span class="sd">           :type ids: int or [int]</span>
<span class="sd">           :return: the list of ids that currently exist, out of</span>
<span class="sd">                    the given `ids`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">):</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s">&#39;SELECT id FROM &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span> <span class="o">+</span> <span class="s">&quot;WHERE ID IN </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ids</span><span class="p">),))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
</div>
<div class="viewcode-block" id="BaseModel.check_recursion"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.check_recursion">[docs]</a>    <span class="k">def</span> <span class="nf">check_recursion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;You are using deprecated </span><span class="si">%s</span><span class="s">.check_recursion(). Please use the &#39;_check_recursion()&#39; instead!&quot;</span> <span class="o">%</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="ow">or</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit_fields</span><span class="p">,</span>\
                    <span class="s">&quot;The &#39;parent&#39; parameter passed to check_recursion() must be None or a valid field name&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_recursion</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_check_recursion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that there is no loop in a hierarchical structure of records,</span>
<span class="sd">        by following the parent relationship using the **parent** field until a loop</span>
<span class="sd">        is detected or until a top-level record is found.</span>

<span class="sd">        :param cr: database cursor</span>
<span class="sd">        :param uid: current user id</span>
<span class="sd">        :param ids: list of ids of records to check</span>
<span class="sd">        :param parent: optional parent field name (default: ``self._parent_name = parent_id``)</span>
<span class="sd">        :return: **True** if the operation can proceed safely, or **False** if an infinite loop is detected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span>

        <span class="c"># must ignore &#39;active&#39; flag, ir.rules, etc. =&gt; direct SQL query</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s">&#39;SELECT &quot;</span><span class="si">%s</span><span class="s">&quot; FROM &quot;</span><span class="si">%s</span><span class="s">&quot; WHERE id = </span><span class="si">%%</span><span class="s">s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">current_id</span> <span class="o">=</span> <span class="nb">id</span>
            <span class="k">while</span> <span class="n">current_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">current_id</span><span class="p">,))</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                <span class="n">current_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">current_id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_get_external_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve the External ID(s) of any database record.</span>

<span class="sd">        **Synopsis**: ``_get_xml_ids(cr, uid, ids) -&gt; { &#39;id&#39;: [&#39;module.xml_id&#39;] }``</span>

<span class="sd">        :return: map of ids to the list of their fully qualified External IDs</span>
<span class="sd">                 in the form ``module.key``, or an empty list when there&#39;s no External</span>
<span class="sd">                 ID for a record, e.g.::</span>

<span class="sd">                     { &#39;id&#39;: [&#39;module.ext_id&#39;, &#39;module.ext_id_bis&#39;],</span>
<span class="sd">                       &#39;id2&#39;: [] }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ir_model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ir.model.data&#39;</span><span class="p">)</span>
        <span class="n">data_ids</span> <span class="o">=</span> <span class="n">ir_model_data</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;model&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;res_id&#39;</span><span class="p">,</span> <span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">ids</span><span class="p">)])</span>
        <span class="n">data_results</span> <span class="o">=</span> <span class="n">ir_model_data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">data_ids</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;module&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;res_id&#39;</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="c"># can&#39;t use dict.fromkeys() as the list would be shared!</span>
            <span class="n">result</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">data_results</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="s">&#39;res_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%(module)s</span><span class="s">.</span><span class="si">%(name)s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">record</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="BaseModel.get_external_id"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.get_external_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_external_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve the External ID of any database record, if there</span>
<span class="sd">        is one. This method works as a possible implementation</span>
<span class="sd">        for a function field, to be able to add it to any</span>
<span class="sd">        model object easily, referencing it as ``Model.get_external_id``.</span>

<span class="sd">        When multiple External IDs exist for a record, only one</span>
<span class="sd">        of them is returned (randomly).</span>

<span class="sd">        :return: map of ids to their fully qualified XML ID,</span>
<span class="sd">                 defaulting to an empty string when there&#39;s none</span>
<span class="sd">                 (to be usable as a function field),</span>
<span class="sd">                 e.g.::</span>

<span class="sd">                     { &#39;id&#39;: &#39;module.ext_id&#39;,</span>
<span class="sd">                       &#39;id2&#39;: &#39;&#39; }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_ids</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="c"># backwards compatibility</span></div>
    <span class="n">get_xml_id</span> <span class="o">=</span> <span class="n">get_external_id</span>
    <span class="n">_get_xml_ids</span> <span class="o">=</span> <span class="n">_get_external_ids</span>

    <span class="c"># Transience</span>
<div class="viewcode-block" id="BaseModel.is_transient"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.is_transient">[docs]</a>    <span class="k">def</span> <span class="nf">is_transient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return whether the model is transient.</span>

<span class="sd">        See :class:`TransientModel`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transient</span>
</div>
    <span class="k">def</span> <span class="nf">_transient_clean_rows_older_than</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">seconds</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transient</span><span class="p">,</span> <span class="s">&quot;Model </span><span class="si">%s</span><span class="s"> is not transient, it cannot be vacuumed!&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
        <span class="c"># Never delete rows used in last 5 minutes</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;SELECT id FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="s">&quot; WHERE&quot;</span>
            <span class="s">&quot; COALESCE(write_date, create_date, (now() at time zone &#39;UTC&#39;))::timestamp&quot;</span>
            <span class="s">&quot; &lt; ((now() at time zone &#39;UTC&#39;) - interval </span><span class="si">%s</span><span class="s">)&quot;</span><span class="p">)</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> seconds&quot;</span> <span class="o">%</span> <span class="n">seconds</span><span class="p">,))</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_transient_clean_old_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">max_count</span><span class="p">):</span>
        <span class="c"># Check how many rows we have in the table</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT count(*) AS row_count FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_count</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c"># max not reached, nothing to do</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transient_clean_rows_older_than</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_transient_vacuum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clean the transient records.</span>

<span class="sd">        This unlinks old records from the transient model tables whenever the</span>
<span class="sd">        &quot;_transient_max_count&quot; or &quot;_max_age&quot; conditions (if any) are reached.</span>
<span class="sd">        Actual cleaning will happen only once every &quot;_transient_check_time&quot; calls.</span>
<span class="sd">        This means this method can be called frequently called (e.g. whenever</span>
<span class="sd">        a new record is created).</span>
<span class="sd">        Example with both max_hours and max_count active:</span>
<span class="sd">        Suppose max_hours = 0.2 (e.g. 12 minutes), max_count = 20, there are 55 rows in the</span>
<span class="sd">        table, 10 created/changed in the last 5 minutes, an additional 12 created/changed between</span>
<span class="sd">        5 and 10 minutes ago, the rest created/changed more then 12 minutes ago.</span>
<span class="sd">        - age based vacuum will leave the 22 rows created/changed in the last 12 minutes</span>
<span class="sd">        - count based vacuum will wipe out another 12 rows. Not just 2, otherwise each addition</span>
<span class="sd">          would immediately cause the maximum to be reached again.</span>
<span class="sd">        - the 10 rows that have been created/changed the last 5 minutes will NOT be deleted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transient</span><span class="p">,</span> <span class="s">&quot;Model </span><span class="si">%s</span><span class="s"> is not transient, it cannot be vacuumed!&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
        <span class="n">_transient_check_time</span> <span class="o">=</span> <span class="mi">20</span>          <span class="c"># arbitrary limit on vacuum executions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transient_check_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transient_check_count</span> <span class="o">&lt;</span> <span class="n">_transient_check_time</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>  <span class="c"># no vacuum cleaning this time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transient_check_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># Age-based expiration</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transient_max_hours</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transient_clean_rows_older_than</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transient_max_hours</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

        <span class="c"># Count-based expiration</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transient_max_count</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transient_clean_old_rows</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transient_max_count</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">True</span>

<div class="viewcode-block" id="BaseModel.resolve_2many_commands"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.BaseModel.resolve_2many_commands">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_2many_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">commands</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Serializes one2many and many2many commands into record dictionaries</span>
<span class="sd">            (as if all the records came from the database via a read()).  This</span>
<span class="sd">            method is aimed at onchange methods on one2many and many2many fields.</span>

<span class="sd">            Because commands might be creation commands, not all record dicts</span>
<span class="sd">            will contain an ``id`` field.  Commands matching an existing record</span>
<span class="sd">            will have an ``id``.</span>

<span class="sd">            :param field_name: name of the one2many or many2many field matching the commands</span>
<span class="sd">            :type field_name: str</span>
<span class="sd">            :param commands: one2many or many2many commands to execute on ``field_name``</span>
<span class="sd">            :type commands: list((int|False, int|False, dict|False))</span>
<span class="sd">            :param fields: list of fields to read from the database, when applicable</span>
<span class="sd">            :type fields: list(str)</span>
<span class="sd">            :returns: records in a shape similar to that returned by ``read()``</span>
<span class="sd">                (except records may be missing the ``id`` field if they don&#39;t exist in db)</span>
<span class="sd">            :rtype: list(dict)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>             <span class="c"># result (list of dict)</span>
        <span class="n">record_ids</span> <span class="o">=</span> <span class="p">[]</span>         <span class="c"># ids of records to read</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="p">{}</span>            <span class="c"># {id: dict} of updates on particular records</span>

        <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">record_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">record_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">updates</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">record_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">id</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">record_ids</span> <span class="k">if</span> <span class="nb">id</span> <span class="o">!=</span> <span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">record_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">record_ids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">record_ids</span> <span class="o">=</span> <span class="p">[],</span> <span class="nb">list</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c"># read the records and apply the updates</span>
        <span class="n">other_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_columns</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">_obj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">other_model</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">record_ids</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">):</span>
            <span class="n">record</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="p">{}))</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="c"># for backward compatibility</span></div>
    <span class="n">resolve_o2m_commands_to_record_dicts</span> <span class="o">=</span> <span class="n">resolve_2many_commands</span>

    <span class="k">def</span> <span class="nf">_register_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; stuff to do right after the registry is built &quot;&quot;&quot;</span>
        <span class="k">pass</span>

<span class="c"># keep this import here, at top it will cause dependency cycle errors</span></div>
<span class="kn">import</span> <span class="nn">expression</span>

<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.Model">[docs]</a><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Main super-class for regular database-persisted OpenERP models.</span>

<span class="sd">    OpenERP models are created by inheriting from this class::</span>

<span class="sd">        class user(Model):</span>
<span class="sd">            ...</span>

<span class="sd">    The system will later instantiate the class once per database (on</span>
<span class="sd">    which the class&#39; module is installed).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_auto</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">_register</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># not visible in ORM registry, meant to be python-inherited only</span>
    <span class="n">_transient</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True in a TransientModel</span>
</div>
<div class="viewcode-block" id="TransientModel"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.TransientModel">[docs]</a><span class="k">class</span> <span class="nc">TransientModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Model super-class for transient records, meant to be temporarily</span>
<span class="sd">       persisted, and regularly vaccuum-cleaned.</span>

<span class="sd">       A TransientModel has a simplified access rights management,</span>
<span class="sd">       all users can create new records, and may only access the</span>
<span class="sd">       records they created. The super-user has unrestricted access</span>
<span class="sd">       to all TransientModel records.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_auto</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">_register</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># not visible in ORM registry, meant to be python-inherited only</span>
    <span class="n">_transient</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="AbstractModel"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.AbstractModel">[docs]</a><span class="k">class</span> <span class="nc">AbstractModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract Model super-class for creating an abstract class meant to be</span>
<span class="sd">       inherited by regular models (Models or TransientModels) but not meant to</span>
<span class="sd">       be usable on its own, or persisted.</span>

<span class="sd">       Technical note: we don&#39;t want to make AbstractModel the super-class of</span>
<span class="sd">       Model or BaseModel because it would not make sense to put the main</span>
<span class="sd">       definition of persistence methods such as create() in it, and still we</span>
<span class="sd">       should be able to override them within an AbstractModel.</span>
<span class="sd">       &quot;&quot;&quot;</span>
    <span class="n">_auto</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># don&#39;t create any database backend for AbstractModels</span>
    <span class="n">_register</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># not visible in ORM registry, meant to be python-inherited only</span>
    <span class="n">_transient</span> <span class="o">=</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="itemgetter_tuple"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.itemgetter_tuple">[docs]</a><span class="k">def</span> <span class="nf">itemgetter_tuple</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Fixes itemgetter inconsistency (useful in some cases) of not returning</span>
<span class="sd">    a tuple if len(items) == 1: always returns an n-tuple where n = len(items)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">gettable</span><span class="p">:</span> <span class="p">(</span><span class="n">gettable</span><span class="p">[</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]],)</span>
    <span class="k">return</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">items</span><span class="p">)</span></div>
<div class="viewcode-block" id="ImportWarning"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.ImportWarning">[docs]</a><span class="k">class</span> <span class="nc">ImportWarning</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Used to send warnings upwards the stack during the import process</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="convert_pgerror_23502"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.convert_pgerror_23502">[docs]</a><span class="k">def</span> <span class="nf">convert_pgerror_23502</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;^null value in column &quot;(?P&lt;field&gt;\w+)&quot; violates &#39;</span>
                 <span class="s">r&#39;not-null constraint\n&#39;</span><span class="p">,</span>
                 <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="n">field_name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;field&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span> <span class="ow">or</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">u&quot;Missing required value for the field &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">field_name</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s"> This might be &#39;</span><span class="si">%s</span><span class="s">&#39; in the current model, or a field &quot;</span>
                    <span class="s">u&quot;of the same name in an o2m.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;string&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
        <span class="s">&#39;field&#39;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span>
    <span class="p">}</span></div>
<div class="viewcode-block" id="convert_pgerror_23505"><a class="viewcode-back" href="../../../api_models.html#openerp.osv.orm.convert_pgerror_23505">[docs]</a><span class="k">def</span> <span class="nf">convert_pgerror_23505</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;^duplicate key (?P&lt;field&gt;\w+) violates unique constraint&#39;</span><span class="p">,</span>
                 <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="n">field_name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;field&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span> <span class="ow">or</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">u&quot;The value for the field &#39;</span><span class="si">%s</span><span class="s">&#39; already exists.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">field_name</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s"> This might be &#39;</span><span class="si">%s</span><span class="s">&#39; in the current model, or a field &quot;</span>
                    <span class="s">u&quot;of the same name in an o2m.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">field</span><span class="p">[</span><span class="s">&#39;string&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
        <span class="s">&#39;field&#39;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span>
    <span class="p">}</span>
</div>
<span class="n">PGERROR_TO_OE</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span>
    <span class="c"># shape of mapped converters</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">model</span><span class="p">,</span> <span class="n">fvg</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">pgerror</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">pgerror</span><span class="p">)}),</span> <span class="p">{</span>
    <span class="c"># not_null_violation</span>
    <span class="s">&#39;23502&#39;</span><span class="p">:</span> <span class="n">convert_pgerror_23502</span><span class="p">,</span>
    <span class="c"># unique constraint error</span>
    <span class="s">&#39;23505&#39;</span><span class="p">:</span> <span class="n">convert_pgerror_23505</span><span class="p">,</span>
<span class="p">})</span>
<span class="c"># vim:expandtab:smartindent:tabstop=4:softtabstop=4:shiftwidth=4:</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="../../../index.html">
  <img class="logo" src="../../../_static/openerp.png" alt="Logo"/>
</a></p><h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    &copy; Copyright 2012, OpenERP s.a.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> and a modified <a href="https://github.com/mitsuhiko/flask-sphinx-themes">Flask theme</a>.
  </div>
  
  </body>
</html>